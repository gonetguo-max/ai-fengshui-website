<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEOä¼˜åŒ–ï¼šå…¨çƒä¸“ä¸šæœåŠ¡ -->
    <title id="page-title">AI Feng Shui Master | Premium Analysis & Consultation | æ™ºèƒ½é£æ°´å¤§å¸ˆ</title>
    <meta name="description" content="Professional AI-powered Feng Shui analysis for luxury homes worldwide. Expert consultation starting from $3.99. ä¸“ä¸šAIé£æ°´åˆ†ææœåŠ¡ï¼Œå…¨çƒå¥¢åä½å®…å¸ƒå±€ä¼˜åŒ–ã€‚">
    <meta name="keywords" content="AI feng shui master, feng shui consultant, luxury home feng shui, premium feng shui consultation, é£æ°´å¤§å¸ˆ, é£æ°´åˆ†æ, æµ·å¤–é£æ°´å¸ˆ, feng shui analysis worldwide">
    
    <!-- åœ°ç†ä½ç½®SEO -->
    <meta name="geo.region" content="US-CA, US-NY, US-TX, CA-ON, CA-BC">
    <meta name="geo.placename" content="North America">
    
    <!-- è¯­è¨€æ”¯æŒ -->
    <link rel="alternate" hreflang="en" href="?lang=en" id="hreflang-en">
    <link rel="alternate" hreflang="zh" href="?lang=zh" id="hreflang-zh">
    <link rel="alternate" hreflang="x-default" href="?lang=en" id="hreflang-default">
    
    <!-- Open Graphç¤¾äº¤åª’ä½“ä¼˜åŒ– -->
    <meta property="og:title" content="AI Feng Shui Analysis | Premium Consultation">
    <meta property="og:description" content="Professional AI-powered Feng Shui analysis for luxury homes. Expert consultation starting from $3.99.">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="en_US">
    <meta property="og:locale:alternate" content="zh_CN">
    
    <!-- Twitterå¡ç‰‡ -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="AI Feng Shui Analysis | Premium Consultation">
    <meta name="twitter:description" content="Professional AI-powered Feng Shui analysis for luxury homes.">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ®</text></svg>">
    <link rel="stylesheet" href="v0-style-enhanced.css">
    
    <!-- ç»“æ„åŒ–æ•°æ® JSON-LD -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "Organization",
          "name": "AI Feng Shui Analysis",
          "alternateName": "æ™ºèƒ½é£æ°´å¤§å¸ˆ",
          "description": "Professional AI-powered Feng Shui consultation service for luxury homes worldwide",
          "url": "https://aifengshui.com",
          "logo": "https://aifengshui.com/logo.png",
          "serviceArea": {
            "@type": "GeoCircle",
            "geoMidpoint": {
              "@type": "GeoCoordinates",
              "latitude": 40.7128,
              "longitude": -74.0060
            },
            "geoRadius": "5000000"
          }
        },
        {
          "@type": "Service",
          "name": "AI Feng Shui Analysis",
          "description": "Professional AI-powered Feng Shui analysis for luxury homes and offices worldwide",
          "provider": {
            "@type": "Organization",
            "name": "AI Feng Shui Analysis"
          },
          "serviceType": "Feng Shui Consultation",
          "category": "Home & Garden Services",
          "hasOfferCatalog": {
            "@type": "OfferCatalog",
            "name": "Feng Shui Analysis Plans",
            "itemListElement": [
              {
                "@type": "Offer",
                "itemOffered": {
                  "@type": "Service",
                  "name": "Basic Feng Shui Analysis",
                  "description": "Complete directional analysis with basic recommendations"
                },
                "price": "3.99",
                "priceCurrency": "USD",
                "availability": "https://schema.org/InStock"
              },
              {
                "@type": "Offer",
                "itemOffered": {
                  "@type": "Service", 
                  "name": "Professional Feng Shui Analysis",
                  "description": "Detailed layout suggestions and professional improvement advice"
                },
                "price": "4.99",
                "priceCurrency": "USD", 
                "availability": "https://schema.org/InStock"
              },
              {
                "@type": "Offer",
                "itemOffered": {
                  "@type": "Service",
                  "name": "Master Feng Shui Consultation", 
                  "description": "Professional feng shui reminders and personalized customization"
                },
                "price": "29.99",
                "priceCurrency": "USD",
                "availability": "https://schema.org/InStock"
              }
            ]
          },
          "areaServed": [
            {
              "@type": "Country",
              "name": "United States"
            },
            {
              "@type": "Country", 
              "name": "Canada"
            }
          ]
        },
        {
          "@type": "WebSite",
          "url": "https://aifengshui.com",
          "name": "AI Feng Shui Analysis",
          "description": "Professional AI-powered Feng Shui consultation for luxury homes worldwide",
          "inLanguage": ["en", "zh-CN"],
          "potentialAction": {
            "@type": "SearchAction",
            "target": "https://aifengshui.com/?q={search_term_string}",
            "query-input": "required name=search_term_string"
          }
        }
      ]
    }
    </script>
    <style>
        /* ===== ç°ä»£é£æ°´ä¸“ä¸šé£æ ¼ - åŸºäºv0.devè®¾è®¡ç†å¿µ ===== */
        
        /* ğŸ¨ åŸºç¡€å­—ä½“ä¸é¢œè‰²ç³»ç»Ÿ */
        :root {
            --primary-gold: #DAA520;
            --primary-gold-light: #F4E4A6;
            --primary-gold-dark: #B8860B;
            
            --bg-primary: #0F1419;
            --bg-secondary: #1A1F2E;
            --bg-card: #212936;
            --bg-input: #2A3441;
            
            --text-primary: #E2E8F0;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;
        }

        /* å…¨å±€é‡ç½®ä¸åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-primary);
        }

        /* é¡µé¢åŠ è½½åŠ¨ç”» */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loader-content {
            text-align: center;
        }

        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(218, 165, 32, 0.2);
            border-top: 3px solid var(--primary-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loader-text {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .hero-section {
            text-align: center;
            padding: 60px 0;
        }

        .hero-title {
            font-size: 2.5rem;
            color: var(--primary-gold);
            margin-bottom: 20px;
        }

        .hero-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 40px;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-gold);
            font-weight: 600;
            font-size: 1rem;
        }

        .form-help {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(218, 165, 32, 0.1);
            border-radius: 4px;
            border-left: 3px solid var(--primary-gold);
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--primary-gold);
            border-radius: 6px;
            color: var(--text-primary);
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 12px 24px;
            background: var(--primary-gold);
            color: var(--bg-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }

        .btn:hover {
            background: var(--primary-gold-light);
        }

        /* æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
        .file-upload-area {
            border: 2px dashed var(--primary-gold);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(218, 165, 32, 0.05);
        }

        .file-upload-area:hover {
            background: rgba(218, 165, 32, 0.1);
            border-color: var(--primary-gold-light);
        }

        .upload-placeholder {
            color: var(--text-secondary);
        }

        .upload-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .file-preview {
            position: relative;
            display: inline-block;
        }

        .remove-file-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-file-btn:hover {
            background: #ff3742;
        }

        /* è¯­è¨€åˆ‡æ¢æ ·å¼ */
        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
        }

        .lang-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--primary-gold);
            color: var(--primary-gold);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .lang-btn:hover,
        .lang-btn.active {
            background: var(--primary-gold);
            color: var(--bg-primary);
        }

        /* ç§»åŠ¨ç«¯å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                max-width: 100%;
            }

            .hero-section {
                padding: 40px 20px;
                text-align: center;
            }

            .hero-title {
                font-size: 2rem;
            }

            .hero-subtitle {
                font-size: 1rem;
                margin-top: 10px;
            }

            /* è¡¨å•å¸ƒå±€ä¼˜åŒ– */
            .form-section {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            /* æŒ‰é’®ä¼˜åŒ– */
            .analyze-button {
                padding: 16px 24px;
                font-size: 1.1rem;
                width: 100%;
                margin-top: 20px;
            }

            /* è¯­è¨€åˆ‡æ¢æŒ‰é’® */
            .language-switcher {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
                text-align: center;
            }

            .lang-btn {
                padding: 12px 20px;
                font-size: 1rem;
                margin: 0 5px;
            }

            /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
            .file-upload-area {
                padding: 30px 15px;
                min-height: 120px;
            }

            .upload-placeholder {
                font-size: 0.9rem;
            }

            .file-preview img {
                max-width: 150px;
                max-height: 150px;
            }

            /* è¡¨å•è¾“å…¥æ¡† */
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 14px;
                font-size: 1rem;
            }

            .form-group label {
                font-size: 0.95rem;
                margin-bottom: 8px;
            }

            /* ç»“æœæ˜¾ç¤ºä¼˜åŒ– */
            #result-section {
                margin-top: 30px;
            }

            #result-content {
                padding: 15px;
                font-size: 0.95rem;
                line-height: 1.6;
            }

            .result-block {
                margin-bottom: 20px;
            }

            .result-block h3 {
                font-size: 1.1rem;
                margin-bottom: 10px;
            }

            /* ç®¡ç†é¢æ¿ç§»åŠ¨ç«¯é€‚é… */
            #admin-panel > div {
                width: 95%;
                margin: 10px auto;
                padding: 15px;
                max-height: 95vh;
            }

            #admin-panel .stat-card {
                padding: 12px;
            }

            #admin-panel h2 {
                font-size: 1.2rem;
            }

            #admin-panel h3 {
                font-size: 1rem;
            }

            /* ç½‘æ ¼å¸ƒå±€è°ƒæ•´ */
            #admin-panel > div > div:first-of-type {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            #admin-panel > div > div:nth-of-type(2) {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            /* è¿›åº¦æŒ‡ç¤ºå™¨ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .progress-card {
                padding: 20px;
                margin: 0 10px;
            }
            
            .progress-steps {
                gap: 5px;
            }
            
            .step-icon {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            .step-text {
                font-size: 0.75rem;
            }
            
            .progress-message {
                font-size: 0.85rem;
            }
        }

        /* è¿›åº¦æŒ‡ç¤ºå™¨æ ·å¼ */
        .progress-card {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid rgba(218, 165, 32, 0.2);
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(218, 165, 32, 0.2);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-gold) 0%, #ffcc00 100%);
            border-radius: 4px;
            width: 0%;
            transition: width 0.8s ease;
            animation: progressShimmer 2s infinite;
        }

        @keyframes progressShimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin: 25px 0;
            gap: 10px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            opacity: 0.5;
            transition: all 0.5s ease;
        }

        .progress-step.active {
            opacity: 1;
            transform: scale(1.05);
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(218, 165, 32, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .progress-step.active .step-icon {
            background: var(--primary-gold);
            color: var(--bg-primary);
            animation: pulseIcon 1.5s infinite;
        }

        @keyframes pulseIcon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .step-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .progress-step.active .step-text {
            color: var(--primary-gold);
            font-weight: 600;
        }

        .progress-message {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 20px;
            line-height: 1.5;
            animation: fadeInOut 2s infinite alternate;
        }

        @keyframes fadeInOut {
            0% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* è¯­è¨€åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }

        .lang-btn {
            padding: 8px 16px;
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid rgba(218, 165, 32, 0.3);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .lang-btn:hover {
            background: rgba(218, 165, 32, 0.1);
            color: var(--text-primary);
            border-color: var(--primary-gold);
        }

        .lang-btn.active {
            background: var(--primary-gold);
            color: var(--bg-primary);
            border-color: var(--primary-gold);
            font-weight: bold;
        }

        /* å¯¼å‡ºæŒ‰é’®æ ·å¼ */
        .export-btn {
            background: linear-gradient(135deg, var(--primary-gold), #ffcc00);
            color: var(--bg-primary);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(218, 165, 32, 0.3);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #ffcc00, var(--primary-gold));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(218, 165, 32, 0.4);
        }

        .export-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(218, 165, 32, 0.3);
        }

        .export-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* å¯¼å‡ºæ§åˆ¶é¢æ¿å“åº”å¼ */
        @media (max-width: 768px) {
            #export-controls {
                flex-wrap: wrap;
                justify-content: center;
                width: 100%;
                margin-top: 10px;
            }
            
            .export-btn {
                font-size: 0.75rem;
                padding: 6px 10px;
                flex: 1;
                min-width: 70px;
                justify-content: center;
            }
        }

        /* å°å±å¹•è®¾å¤‡ (æ‰‹æœºç«–å±) */
        @media (max-width: 480px) {
            .hero-title {
                font-size: 1.8rem;
            }

            .hero-subtitle {
                font-size: 0.9rem;
            }

            .form-section {
                padding: 15px;
            }

            .analyze-button {
                padding: 18px 20px;
                font-size: 1.2rem;
            }

            .lang-btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            /* æ›´ç´§å‡‘çš„é—´è· */
            .form-group {
                margin-bottom: 15px;
            }

            .file-upload-area {
                padding: 20px 10px;
                min-height: 100px;
            }

            .upload-placeholder {
                font-size: 0.85rem;
            }

            /* ç»“æœæ˜¾ç¤ºæ›´ç´§å‡‘ */
            #result-content {
                padding: 12px;
                font-size: 0.9rem;
            }

            .result-block h3 {
                font-size: 1rem;
            }
        }

        /* æ¨ªå±å¹³æ¿é€‚é… */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 900px;
            }

            .form-grid {
                grid-template-columns: 1fr 1fr;
            }

            .hero-title {
                font-size: 2.5rem;
            }
        }

        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .analyze-button,
            .lang-btn,
            .remove-file-btn {
                min-height: 44px;
                min-width: 44px;
            }

            .file-upload-area {
                min-height: 140px;
            }

            /* å¢åŠ ç‚¹å‡»åŒºåŸŸ */
            .form-group input,
            .form-group select {
                min-height: 44px;
            }
        }
    </style>
</head>
<body>
    <!-- é¡µé¢åŠ è½½åŠ¨ç”» -->
    <div class="page-loader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <div class="loader-text">æ­£åœ¨åŠ è½½AIé£æ°´å¤§å¸ˆ...</div>
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="container">
        <!-- è¯­è¨€åˆ‡æ¢æŒ‰é’® -->
        <div class="language-switcher">
            <button class="lang-btn active" id="lang-zh" data-lang="zh">ä¸­æ–‡</button>
            <button class="lang-btn" id="lang-en" data-lang="en">English</button>
        </div>

        <section class="hero-section">
            <h1 class="hero-title" data-i18n="title">AIé£æ°´å¤§å¸ˆ</h1>
            <p class="hero-subtitle" data-i18n="subtitle">æ™ºèƒ½åˆ†ææ‚¨çš„å±…å®¶ç¯å¢ƒï¼Œæä¾›ä¸“ä¸šé£æ°´å»ºè®®</p>
        </section>

        <form id="fengshui-form">
            <div class="form-group">
                <label class="form-label" for="house-type" data-i18n="houseType">æˆ¿å±‹ç±»å‹</label>
                <select class="form-select" id="house-type">
                    <option value="" data-i18n="selectHouseType">è¯·é€‰æ‹©æˆ¿å±‹ç±»å‹</option>
                    <option value="residential" data-i18n="residential">ä½å®…</option>
                    <option value="office" data-i18n="office">åŠå…¬å®¤</option>
                    <option value="shop" data-i18n="shop">å•†é“º</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="direction" data-i18n="direction">æˆ¿å±‹æœå‘</label>
                <p class="form-help" data-i18n="directionHelp">ğŸ’¡ è¯´æ˜ï¼šè¯·é€‰æ‹©å…¥æˆ·é—¨é¢å¯¹çš„æ–¹å‘ï¼ˆå³ç«™åœ¨é—¨å†…å‘å¤–çœ‹çš„æ–¹å‘ï¼‰</p>
                <select class="form-select" id="direction" required>
                    <option value="" data-i18n="selectDirection">è¯·é€‰æ‹©å…¥æˆ·é—¨æœå‘</option>
                    <option value="north" data-i18n="north">åŒ—ï¼ˆå…¥æˆ·é—¨é¢å‘åŒ—æ–¹ï¼‰</option>
                    <option value="south" data-i18n="south">å—ï¼ˆå…¥æˆ·é—¨é¢å‘å—æ–¹ï¼‰</option>
                    <option value="east" data-i18n="east">ä¸œï¼ˆå…¥æˆ·é—¨é¢å‘ä¸œæ–¹ï¼‰</option>
                    <option value="west" data-i18n="west">è¥¿ï¼ˆå…¥æˆ·é—¨é¢å‘è¥¿æ–¹ï¼‰</option>
                    <option value="northeast" data-i18n="northeast">ä¸œåŒ—ï¼ˆå…¥æˆ·é—¨é¢å‘ä¸œåŒ—æ–¹ï¼‰</option>
                    <option value="northwest" data-i18n="northwest">è¥¿åŒ—ï¼ˆå…¥æˆ·é—¨é¢å‘è¥¿åŒ—æ–¹ï¼‰</option>
                    <option value="southeast" data-i18n="southeast">ä¸œå—ï¼ˆå…¥æˆ·é—¨é¢å‘ä¸œå—æ–¹ï¼‰</option>
                    <option value="southwest" data-i18n="southwest">è¥¿å—ï¼ˆå…¥æˆ·é—¨é¢å‘è¥¿å—æ–¹ï¼‰</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="area" data-i18n="area">é¢ç§¯ï¼ˆå¹³æ–¹ç±³ï¼‰</label>
                <input type="number" class="form-input" id="area" placeholder="" data-i18n-placeholder="areaPlaceholder" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="floor-level" data-i18n="floorLevel">æ‰€åœ¨æ¥¼å±‚</label>
                <select class="form-select" id="floor-level">
                    <option value="" data-i18n="selectFloor">è¯·é€‰æ‹©æ¥¼å±‚ï¼ˆå¯é€‰ï¼‰</option>
                    <option value="1" data-i18n="floor1">1æ¥¼</option>
                    <option value="2" data-i18n="floor2">2æ¥¼</option>
                    <option value="3" data-i18n="floor3">3æ¥¼</option>
                    <option value="4" data-i18n="floor4">4æ¥¼</option>
                    <option value="5" data-i18n="floor5">5æ¥¼</option>
                    <option value="6-10" data-i18n="floor6to10">6-10æ¥¼</option>
                    <option value="11-20" data-i18n="floor11to20">11-20æ¥¼</option>
                    <option value="21+" data-i18n="floor21plus">21æ¥¼ä»¥ä¸Š</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="room-count" data-i18n="roomCount">æˆ¿é—´æ•°é‡</label>
                <p class="form-help" data-i18n="roomHelp">ğŸ’¡ è¯´æ˜ï¼šæŒ‡å§å®¤æ•°é‡ï¼Œæœ‰åŠ©äºæä¾›æ›´ç²¾å‡†çš„ç©ºé—´å¸ƒå±€å»ºè®®ï¼ˆå¯é€‰ï¼‰</p>
                <select class="form-select" id="room-count">
                    <option value="" data-i18n="selectRooms">è¯·é€‰æ‹©æˆ¿é—´æ•°ï¼ˆå¯é€‰ï¼‰</option>
                    <option value="1" data-i18n="room1">1å®¤</option>
                    <option value="2" data-i18n="room2">2å®¤</option>
                    <option value="3" data-i18n="room3">3å®¤</option>
                    <option value="4" data-i18n="room4">4å®¤</option>
                    <option value="5+" data-i18n="room5plus">5å®¤ä»¥ä¸Š</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="family-size" data-i18n="familySize">å®¶åº­äººæ•°</label>
                <select class="form-select" id="family-size">
                    <option value="" data-i18n="selectFamily">è¯·é€‰æ‹©å®¶åº­äººæ•°ï¼ˆå¯é€‰ï¼‰</option>
                    <option value="1" data-i18n="family1">1äºº</option>
                    <option value="2" data-i18n="family2">2äºº</option>
                    <option value="3" data-i18n="family3">3äºº</option>
                    <option value="4" data-i18n="family4">4äºº</option>
                    <option value="5+" data-i18n="family5plus">5äººä»¥ä¸Š</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="house-photo" data-i18n="photoUpload">æˆ·å‹å›¾ä¸Šä¼ </label>
                <p class="form-help" data-i18n="photoHelp">ğŸ’¡ ä¸Šä¼ æˆ·å‹å›¾å¯è·å¾—æ›´ç²¾å‡†çš„é£æ°´åˆ†æï¼ˆå¯é€‰ï¼Œæ”¯æŒJPGã€PNGæ ¼å¼ï¼Œä¸è¶…è¿‡5MBï¼‰</p>
                <div class="file-upload-area" id="file-upload-area">
                    <input type="file" class="file-input" id="house-photo" accept="image/*" style="display: none;">
                    <div class="upload-placeholder" id="upload-placeholder">
                        <div class="upload-icon">ğŸ“</div>
                        <p data-i18n="uploadText">ç‚¹å‡»é€‰æ‹©æˆ·å‹å›¾ç‰‡æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</p>
                        <small data-i18n="uploadFormat">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 5MB</small>
                    </div>
                    <div class="file-preview" id="file-preview" style="display: none;">
                        <img id="preview-image" src="" alt="æˆ·å‹å›¾é¢„è§ˆ" style="max-width: 200px; max-height: 200px; border-radius: 6px;">
                        <button type="button" class="remove-file-btn" id="remove-file-btn">Ã—</button>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="description" data-i18n="description">æˆ¿å±‹æè¿°</label>
                <textarea class="form-input" id="description" rows="4" placeholder="" data-i18n-placeholder="descriptionPlaceholder"></textarea>
            </div>

            <button type="submit" class="btn" id="analyze-btn" data-i18n="analyzeBtn">å¼€å§‹åˆ†æ</button>
        </form>

        <!-- åˆ†æè¿›åº¦æŒ‡ç¤ºå™¨ -->
        <div id="progress-container" style="display: none; margin-top: 40px;">
            <div class="progress-card">
                <h3 style="color: var(--primary-gold); text-align: center; margin-bottom: 20px;" data-i18n="analyzingTitle">ğŸ”® æ­£åœ¨è¿›è¡Œé£æ°´åˆ†æ</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-steps">
                    <div class="progress-step active" id="step-1">
                        <div class="step-icon">ğŸ“Š</div>
                        <div class="step-text" data-i18n="step1">æ•°æ®åˆ†æ</div>
                    </div>
                    <div class="progress-step" id="step-2">
                        <div class="step-icon">ğŸ§­</div>
                        <div class="step-text" data-i18n="step2">æ–¹ä½è®¡ç®—</div>
                    </div>
                    <div class="progress-step" id="step-3">
                        <div class="step-icon">ğŸ </div>
                        <div class="step-text" data-i18n="step3">å¸ƒå±€åˆ†æ</div>
                    </div>
                    <div class="progress-step" id="step-4">
                        <div class="step-icon">ğŸ’¡</div>
                        <div class="step-text" data-i18n="step4">å»ºè®®ç”Ÿæˆ</div>
                    </div>
                </div>
                <div class="progress-message" id="progress-message" data-i18n="progressMsg">è¯·ç¨å€™ï¼ŒAIæ­£åœ¨æ·±åº¦åˆ†ææ‚¨çš„ä½å®…é£æ°´...</div>
            </div>
        </div>

        <!-- åˆ†æç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
        <div id="result-section" style="display: none; margin-top: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="color: var(--primary-gold); margin: 0;" data-i18n="resultTitle">ğŸ”® é£æ°´åˆ†æç»“æœ</h2>
                <div id="export-controls" style="display: flex; gap: 10px; align-items: center;">
                    <button class="export-btn" onclick="exportToPDF()" data-i18n="exportPDF" title="å¯¼å‡ºä¸ºPDFæ–‡ä»¶">
                        ğŸ“„ PDF
                    </button>
                    <button class="export-btn" onclick="exportToImage()" data-i18n="exportImage" title="å¯¼å‡ºä¸ºå›¾ç‰‡">
                        ğŸ–¼ï¸ å›¾ç‰‡
                    </button>
                    <button class="export-btn" onclick="exportToText()" data-i18n="exportText" title="å¯¼å‡ºä¸ºæ–‡æœ¬æ–‡ä»¶">
                        ğŸ“ æ–‡æœ¬
                    </button>
                    <button class="export-btn" onclick="shareResult()" data-i18n="shareResult" title="åˆ†äº«åˆ†æç»“æœ">
                        ğŸ”— åˆ†äº«
                    </button>
                </div>
            </div>
            <div id="result-content" style="background: var(--bg-card); padding: 20px; border-radius: 8px; margin-top: 0;">
                <!-- ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
    </div>

    <!-- è¿”å›é¡¶éƒ¨æŒ‰é’®ï¼ˆç§»åŠ¨ç«¯ï¼‰-->
    <div id="back-to-top" style="display: none; position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background: var(--primary-gold); border-radius: 50%; cursor: pointer; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); opacity: 0.8; transition: all 0.3s ease;">
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--bg-primary); font-size: 1.2rem; font-weight: bold;">â†‘</div>
    </div>

    <!-- ç®¡ç†é¢æ¿ï¼ˆéšè—ï¼‰-->
    <div id="admin-panel" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000;">
        <div style="position: relative; width: 90%; max-width: 1200px; margin: 20px auto; background: var(--bg-primary); border-radius: 12px; padding: 20px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--primary-gold); padding-bottom: 10px;">
                <h2 style="color: var(--primary-gold); margin: 0;">ğŸ”§ ç³»ç»Ÿç›‘æ§é¢æ¿</h2>
                <button id="close-admin" style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">âœ• å…³é—­</button>
            </div>
            
            <!-- å®æ—¶ç»Ÿè®¡å¡ç‰‡ -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="stat-card">
                    <h3>ğŸ“Š ä»Šæ—¥ç»Ÿè®¡</h3>
                    <div id="today-stats">åŠ è½½ä¸­...</div>
                </div>
                <div class="stat-card">
                    <h3>ğŸ¤– AIæ€§èƒ½</h3>
                    <div id="ai-performance">åŠ è½½ä¸­...</div>
                </div>
                <div class="stat-card">
                    <h3>ğŸŒ ç”¨æˆ·åˆ†å¸ƒ</h3>
                    <div id="user-distribution">åŠ è½½ä¸­...</div>
                </div>
                <div class="stat-card">
                    <h3>âš¡ ç³»ç»ŸçŠ¶æ€</h3>
                    <div id="system-health">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- è¯¦ç»†åˆ†æè¡¨æ ¼ -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3 style="color: var(--primary-gold); border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">ğŸ”„ AIæ¨¡å‹å¯¹æ¯”</h3>
                    <div id="ai-comparison-table">åŠ è½½ä¸­...</div>
                </div>
                <div>
                    <h3 style="color: var(--primary-gold); border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">ğŸ“ˆ ä½¿ç”¨è¶‹åŠ¿</h3>
                    <div id="usage-trends">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- æœ€è¿‘åé¦ˆ -->
            <div style="margin-top: 20px;">
                <h3 style="color: var(--primary-gold); border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">ğŸ’¬ æœ€è¿‘ç”¨æˆ·åé¦ˆ</h3>
                <div id="recent-feedback">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <style>
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
        }
        .stat-card h3 {
            color: var(--primary-gold);
            margin: 0 0 10px 0;
            font-size: 1rem;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
        }
        .stat-value {
            color: var(--primary-gold);
            font-weight: bold;
        }
        .performance-bar {
            background: #333;
            border-radius: 10px;
            height: 6px;
            margin: 5px 0;
            overflow: hidden;
        }
        .performance-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444 0%, #ffaa44 50%, #44ff44 100%);
            transition: width 0.3s ease;
        }
    </style>

    <script>
        // å¤šè¯­è¨€é…ç½®
        const i18n = {
            zh: {
                title: 'æ™ºèƒ½é£æ°´å¤§å¸ˆ',
                subtitle: 'ä¸“ä¸šAIé£æ°´åˆ†ææœåŠ¡ | å¥¢åä½å®…å¸ƒå±€ä¼˜åŒ– | å…¨çƒä¸“ä¸šå’¨è¯¢ | $3.99èµ·',
                houseType: 'æˆ¿å±‹ç±»å‹',
                selectHouseType: 'è¯·é€‰æ‹©æˆ¿å±‹ç±»å‹',
                residential: 'ä½å®…',
                office: 'åŠå…¬å®¤',
                shop: 'å•†é“º',
                direction: 'æˆ¿å±‹æœå‘',
                directionHelp: 'ğŸ’¡ è¯´æ˜ï¼šè¯·é€‰æ‹©å…¥æˆ·é—¨é¢å¯¹çš„æ–¹å‘ï¼ˆå³ç«™åœ¨é—¨å†…å‘å¤–çœ‹çš„æ–¹å‘ï¼‰',
                selectDirection: 'è¯·é€‰æ‹©å…¥æˆ·é—¨æœå‘',
                north: 'åŒ—ï¼ˆå…¥æˆ·é—¨é¢å‘åŒ—æ–¹ï¼‰',
                south: 'å—ï¼ˆå…¥æˆ·é—¨é¢å‘å—æ–¹ï¼‰',
                east: 'ä¸œï¼ˆå…¥æˆ·é—¨é¢å‘ä¸œæ–¹ï¼‰',
                west: 'è¥¿ï¼ˆå…¥æˆ·é—¨é¢å‘è¥¿æ–¹ï¼‰',
                northeast: 'ä¸œåŒ—ï¼ˆå…¥æˆ·é—¨é¢å‘ä¸œåŒ—æ–¹ï¼‰',
                northwest: 'è¥¿åŒ—ï¼ˆå…¥æˆ·é—¨é¢å‘è¥¿åŒ—æ–¹ï¼‰',
                southeast: 'ä¸œå—ï¼ˆå…¥æˆ·é—¨é¢å‘ä¸œå—æ–¹ï¼‰',
                southwest: 'è¥¿å—ï¼ˆå…¥æˆ·é—¨é¢å‘è¥¿å—æ–¹ï¼‰',
                area: 'é¢ç§¯ï¼ˆå¹³æ–¹ç±³ï¼‰',
                areaPlaceholder: 'è¯·è¾“å…¥æˆ¿å±‹é¢ç§¯',
                floorLevel: 'æ‰€åœ¨æ¥¼å±‚',
                selectFloor: 'è¯·é€‰æ‹©æ¥¼å±‚ï¼ˆå¯é€‰ï¼‰',
                floor1: '1æ¥¼',
                floor2: '2æ¥¼',
                floor3: '3æ¥¼',
                floor4: '4æ¥¼',
                floor5: '5æ¥¼',
                floor6to10: '6-10æ¥¼',
                floor11to20: '11-20æ¥¼',
                floor21plus: '21æ¥¼ä»¥ä¸Š',
                roomCount: 'æˆ¿é—´æ•°é‡',
                roomHelp: 'ğŸ’¡ è¯´æ˜ï¼šæŒ‡å§å®¤æ•°é‡ï¼Œæœ‰åŠ©äºæä¾›æ›´ç²¾å‡†çš„ç©ºé—´å¸ƒå±€å»ºè®®ï¼ˆå¯é€‰ï¼‰',
                selectRooms: 'è¯·é€‰æ‹©æˆ¿é—´æ•°ï¼ˆå¯é€‰ï¼‰',
                room1: '1å®¤',
                room2: '2å®¤',
                room3: '3å®¤',
                room4: '4å®¤',
                room5plus: '5å®¤ä»¥ä¸Š',
                familySize: 'å®¶åº­äººæ•°',
                selectFamily: 'è¯·é€‰æ‹©å®¶åº­äººæ•°ï¼ˆå¯é€‰ï¼‰',
                family1: '1äºº',
                family2: '2äºº',
                family3: '3äºº',
                family4: '4äºº',
                family5plus: '5äººä»¥ä¸Š',
                photoUpload: 'æˆ·å‹å›¾ä¸Šä¼ ',
                photoHelp: 'ğŸ’¡ ä¸Šä¼ æˆ·å‹å›¾å¯è·å¾—æ›´ç²¾å‡†çš„é£æ°´åˆ†æï¼ˆå¯é€‰ï¼Œæ”¯æŒJPGã€PNGæ ¼å¼ï¼Œä¸è¶…è¿‡5MBï¼‰',
                uploadText: 'ç‚¹å‡»é€‰æ‹©æˆ·å‹å›¾ç‰‡æˆ–æ‹–æ‹½åˆ°æ­¤å¤„',
                uploadFormat: 'æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 5MB',
                description: 'æˆ¿å±‹æè¿°',
                descriptionPlaceholder: 'è¯·æè¿°æˆ¿å±‹çš„å…·ä½“æƒ…å†µï¼Œå¦‚ï¼šè£…ä¿®é£æ ¼ã€å®¶å…·æ‘†æ”¾ç­‰',
                analyzeBtn: 'ğŸ”® è·å–ä¸“ä¸šé£æ°´åˆ†æ',
                analyzing: 'åˆ†æä¸­...',
                resultTitle: 'ğŸ”® é£æ°´åˆ†æç»“æœ',
                scoreTitle: 'ç»¼åˆè¯„åˆ†',
                directionTitle: 'æœå‘åˆ†æ',
                layoutTitle: 'å¸ƒå±€å»ºè®®',
                actionTitle: 'ç«‹å³æ”¹å–„å»ºè®®',
                notesTitle: 'é‡è¦æé†’',
                explanationTitle: 'ğŸ’¡ åˆ†æè¯´æ˜',
                explanationText: 'é£æ°´åˆ†æä¼šç»“åˆå½“å‰æ—¶é—´ã€è¿åŠ¿å‘¨æœŸç­‰åŠ¨æ€å› ç´ ï¼Œå› æ­¤åŒæ ·æ¡ä»¶ä¸‹å¯èƒ½äº§ç”Ÿè½»å¾®å·®å¼‚ã€‚è¿™ä½“ç°äº†ä¼ ç»Ÿé£æ°´å­¦"å› æ—¶åˆ¶å®œ"çš„æ ¸å¿ƒç†å¿µï¼Œå»ºè®®ä»¥ç»¼åˆè¶‹åŠ¿ä¸ºå‡†ã€‚',
                analyzingTitle: 'ğŸ”® æ­£åœ¨è¿›è¡Œé£æ°´åˆ†æ',
                step1: 'æ•°æ®åˆ†æ',
                step2: 'æ–¹ä½è®¡ç®—',
                step3: 'å¸ƒå±€åˆ†æ',
                step4: 'å»ºè®®ç”Ÿæˆ',
                progressMsg: 'è¯·ç¨å€™ï¼ŒAIæ­£åœ¨æ·±åº¦åˆ†ææ‚¨çš„ä½å®…é£æ°´...',
                exportPDF: 'ğŸ“„ PDF',
                exportImage: 'ğŸ–¼ï¸ å›¾ç‰‡',
                exportText: 'ğŸ“ æ–‡æœ¬',
                shareResult: 'ğŸ”— åˆ†äº«'
            },
            en: {
                title: 'AI Feng Shui Master',
                subtitle: 'Professional AI-Powered Feng Shui Analysis | Luxury Home & Office Worldwide | From $3.99',
                houseType: 'Property Type',
                selectHouseType: 'Please select property type',
                residential: 'Residential',
                office: 'Office',
                shop: 'Shop',
                direction: 'House Orientation',
                directionHelp: 'ğŸ’¡ Note: Please select the direction your main entrance faces (the direction you see when standing inside looking out)',
                selectDirection: 'Please select main entrance direction',
                north: 'North (Entrance facing north)',
                south: 'South (Entrance facing south)',
                east: 'East (Entrance facing east)',
                west: 'West (Entrance facing west)',
                northeast: 'Northeast (Entrance facing northeast)',
                northwest: 'Northwest (Entrance facing northwest)',
                southeast: 'Southeast (Entrance facing southeast)',
                southwest: 'Southwest (Entrance facing southwest)',
                area: 'Area (Square Meters)',
                areaPlaceholder: 'Please enter property area',
                floorLevel: 'Floor Level',
                selectFloor: 'Please select floor (Optional)',
                floor1: '1st Floor',
                floor2: '2nd Floor',
                floor3: '3rd Floor',
                floor4: '4th Floor',
                floor5: '5th Floor',
                floor6to10: '6-10 Floors',
                floor11to20: '11-20 Floors',
                floor21plus: '21+ Floors',
                roomCount: 'Number of Rooms',
                roomHelp: 'ğŸ’¡ Note: Refers to bedroom count, helps provide more precise layout suggestions (Optional)',
                selectRooms: 'Please select rooms (Optional)',
                room1: '1 Room',
                room2: '2 Rooms',
                room3: '3 Rooms',
                room4: '4 Rooms',
                room5plus: '5+ Rooms',
                familySize: 'Family Size',
                selectFamily: 'Please select family size (Optional)',
                family1: '1 Person',
                family2: '2 People',
                family3: '3 People',
                family4: '4 People',
                family5plus: '5+ People',
                photoUpload: 'Floor Plan Upload',
                photoHelp: 'ğŸ’¡ Upload floor plan for more accurate Feng Shui analysis (Optional, supports JPG, PNG format, max 5MB)',
                uploadText: 'Click to select floor plan or drag here',
                uploadFormat: 'Supports JPG, PNG format, max 5MB',
                description: 'Property Description',
                descriptionPlaceholder: 'Please describe your property details, such as: decoration style, furniture arrangement, etc.',
                analyzeBtn: 'ğŸ”® Get Premium Feng Shui Analysis',
                analyzing: 'Analyzing...',
                resultTitle: 'ğŸ”® Feng Shui Analysis Result',
                scoreTitle: 'Overall Score',
                directionTitle: 'Orientation Analysis',
                layoutTitle: 'Layout Suggestions',
                actionTitle: 'Immediate Improvements',
                notesTitle: 'Important Notes',
                explanationTitle: 'ğŸ’¡ Analysis Note',
                explanationText: 'Feng Shui analysis incorporates dynamic factors such as current time and fortune cycles, so slight variations may occur under the same conditions. This reflects the core concept of traditional Feng Shui "adapting to time and circumstances". Please focus on the overall trends.',
                analyzingTitle: 'ğŸ”® Feng Shui Analysis in Progress',
                step1: 'Data Analysis',
                step2: 'Direction Calculation',
                step3: 'Layout Analysis',
                step4: 'Recommendation Generation',
                progressMsg: 'Please wait, AI is deeply analyzing your residential Feng Shui...',
                exportPDF: 'ğŸ“„ PDF',
                exportImage: 'ğŸ–¼ï¸ Image',
                exportText: 'ğŸ“ Text',
                shareResult: 'ğŸ”— Share'
            }
        };

        let currentLang = 'zh';
        
        // äº‹ä»¶è¿½è¸ªç³»ç»Ÿ
        function trackEvent(eventName, properties = {}) {
            const eventData = {
                event: eventName,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href,
                language: currentLang,
                ...properties
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒåº”å‘é€åˆ°åˆ†ææœåŠ¡ï¼‰
            const events = JSON.parse(localStorage.getItem('analytics_events') || '[]');
            events.push(eventData);
            localStorage.setItem('analytics_events', JSON.stringify(events));
            
            // è¾“å‡ºåˆ°æ§åˆ¶å°ç”¨äºè°ƒè¯•
            console.log('ğŸ“Š Event Tracked:', eventData);
        }

        // è¯­è¨€åˆ‡æ¢å‡½æ•°
        function switchLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            
            // æ›´æ–°URLå‚æ•°
            const url = new URL(window.location);
            url.searchParams.set('lang', lang);
            window.history.replaceState({}, '', url);
            
            // æ›´æ–°hreflangé“¾æ¥
            document.getElementById('hreflang-en').href = window.location.pathname + '?lang=en';
            document.getElementById('hreflang-zh').href = window.location.pathname + '?lang=zh';
            document.getElementById('hreflang-default').href = window.location.pathname + '?lang=en';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`lang-${lang}`).classList.add('active');

            // æ›´æ–°æ‰€æœ‰å¸¦æœ‰ data-i18n çš„å…ƒç´ 
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang][key]) {
                    el.textContent = i18n[lang][key];
                }
            });

            // æ›´æ–°placeholder
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (i18n[lang][key]) {
                    el.placeholder = i18n[lang][key];
                }
            });

            // ä¿å­˜è¯­è¨€é€‰æ‹©
            localStorage.setItem('selectedLanguage', lang);
            
            // å¦‚æœæœ‰æ˜¾ç¤ºçš„åˆ†æç»“æœï¼Œé‡æ–°æ¸²æŸ“å†…å®¹
            const resultSection = document.getElementById('result-section');
            if (resultSection && resultSection.style.display !== 'none' && window.lastAnalysisResult) {
                displayResult(window.lastAnalysisResult);
            }
        }

        // ç§»åŠ¨ç«¯ä¼˜åŒ–åŠŸèƒ½
        function initMobileOptimizations() {
            // æ£€æµ‹ç§»åŠ¨è®¾å¤‡
            const isMobile = window.innerWidth <= 768;
            const isTouchDevice = 'ontouchstart' in window;

            if (isMobile || isTouchDevice) {
                // ä¼˜åŒ–è¡¨å•æ»šåŠ¨è¡Œä¸º
                const formInputs = document.querySelectorAll('input, select, textarea');
                formInputs.forEach(input => {
                    input.addEventListener('focus', (e) => {
                        // å»¶è¿Ÿæ»šåŠ¨ï¼Œé¿å…è™šæ‹Ÿé”®ç›˜å½±å“
                        setTimeout(() => {
                            e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    });
                });

                // ä¼˜åŒ–æ–‡ä»¶ä¸Šä¼ åŒºåŸŸçš„è§¦æ‘¸åé¦ˆ
                const uploadArea = document.getElementById('file-upload-area');
                if (uploadArea) {
                    let touchStartTime = 0;
                    
                    uploadArea.addEventListener('touchstart', (e) => {
                        touchStartTime = Date.now();
                        uploadArea.style.transform = 'scale(0.98)';
                        uploadArea.style.transition = 'transform 0.1s ease';
                    });

                    uploadArea.addEventListener('touchend', (e) => {
                        uploadArea.style.transform = 'scale(1)';
                        
                        // å¦‚æœæ˜¯å¿«é€Ÿç‚¹å‡»ï¼Œè§¦å‘æ–‡ä»¶é€‰æ‹©
                        if (Date.now() - touchStartTime < 200) {
                            document.getElementById('house-photo').click();
                        }
                    });

                    uploadArea.addEventListener('touchcancel', (e) => {
                        uploadArea.style.transform = 'scale(1)';
                    });
                }

                // ä¼˜åŒ–æŒ‰é’®è§¦æ‘¸åé¦ˆ
                const buttons = document.querySelectorAll('.analyze-button, .lang-btn, .remove-file-btn');
                buttons.forEach(button => {
                    button.addEventListener('touchstart', (e) => {
                        button.style.transform = 'scale(0.95)';
                        button.style.transition = 'transform 0.1s ease';
                    });

                    button.addEventListener('touchend', (e) => {
                        setTimeout(() => {
                            button.style.transform = 'scale(1)';
                        }, 100);
                    });

                    button.addEventListener('touchcancel', (e) => {
                        button.style.transform = 'scale(1)';
                    });
                });

                // é˜²æ­¢ç§»åŠ¨ç«¯åŒå‡»ç¼©æ”¾ï¼ˆåœ¨åˆ†ææŒ‰é’®ä¸Šï¼‰
                const analyzeButton = document.getElementById('analyze-button');
                if (analyzeButton) {
                    analyzeButton.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        setTimeout(() => {
                            analyzeButton.click();
                        }, 100);
                    });
                }

                // ä¼˜åŒ–ç»“æœåŒºåŸŸçš„æ»šåŠ¨
                const resultSection = document.getElementById('result-section');
                if (resultSection) {
                    const observer = new MutationObserver(() => {
                        if (resultSection.style.display === 'block') {
                            setTimeout(() => {
                                resultSection.scrollIntoView({ 
                                    behavior: 'smooth', 
                                    block: 'start',
                                    inline: 'nearest'
                                });
                            }, 500);
                        }
                    });
                    
                    observer.observe(resultSection, { 
                        attributes: true, 
                        attributeFilter: ['style'] 
                    });
                }
            }

            // æ·»åŠ ç§»åŠ¨ç«¯ä¸“ç”¨çš„swipeæ‰‹åŠ¿ï¼ˆç”¨äºç®¡ç†é¢æ¿ï¼‰
            if (isTouchDevice) {
                let startY = 0;
                let startX = 0;

                document.addEventListener('touchstart', (e) => {
                    startY = e.touches[0].clientY;
                    startX = e.touches[0].clientX;
                });

                document.addEventListener('touchend', (e) => {
                    if (!adminPanelVisible) return;

                    const endY = e.changedTouches[0].clientY;
                    const endX = e.changedTouches[0].clientX;
                    const diffY = startY - endY;
                    const diffX = startX - endX;

                    // å‘ä¸‹æ»‘åŠ¨å…³é—­ç®¡ç†é¢æ¿
                    if (diffY < -100 && Math.abs(diffX) < 50) {
                        closeAdminPanel();
                    }
                });
            }
        }

        // æ·»åŠ ç§»åŠ¨ç«¯çš„è§†çª—å˜åŒ–ç›‘å¬
        function handleViewportChange() {
            // å¤„ç†ç§»åŠ¨ç«¯è½¯é”®ç›˜æ˜¾ç¤º/éšè—
            const visualViewport = window.visualViewport;
            if (visualViewport) {
                visualViewport.addEventListener('resize', () => {
                    document.documentElement.style.setProperty(
                        '--vh', 
                        `${visualViewport.height * 0.01}px`
                    );
                });
            }

            // å¤„ç†å±å¹•æ–¹å‘å˜åŒ–
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    // é‡æ–°è®¡ç®—å¸ƒå±€
                    window.dispatchEvent(new Event('resize'));
                    
                    // å¦‚æœç®¡ç†é¢æ¿å¼€å¯ï¼Œè°ƒæ•´å…¶å¤§å°
                    if (adminPanelVisible) {
                        const adminPanel = document.getElementById('admin-panel');
                        if (adminPanel) {
                            adminPanel.style.height = '100vh';
                        }
                    }
                }, 500);
            });
        }

        // åœ¨é¡µé¢åŠ è½½å®Œæˆåç§»é™¤åŠ è½½åŠ¨ç”»å’Œåˆå§‹åŒ–è¯­è¨€
        window.addEventListener('load', () => {
            // åˆå§‹åŒ–ç§»åŠ¨ç«¯ä¼˜åŒ–
            initMobileOptimizations();
            handleViewportChange();
            const loader = document.querySelector('.page-loader');
            if (loader) {
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);
            }

            // åˆå§‹åŒ–è¯­è¨€ï¼ˆä¼˜å…ˆä½¿ç”¨URLå‚æ•°ï¼Œç„¶åç”¨æˆ·ä¹‹å‰çš„é€‰æ‹©ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const urlLang = urlParams.get('lang');
            const savedLang = localStorage.getItem('selectedLanguage') || 'zh';
            const initialLang = urlLang || savedLang;
            
            if (initialLang !== 'zh') {
                switchLanguage(initialLang);
            }

            // ç»‘å®šè¯­è¨€åˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    switchLanguage(btn.getAttribute('data-lang'));
                });
            });
        });

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        const fileInput = document.getElementById('house-photo');
        const uploadArea = document.getElementById('file-upload-area');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const filePreview = document.getElementById('file-preview');
        const previewImage = document.getElementById('preview-image');
        const removeFileBtn = document.getElementById('remove-file-btn');

        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        fileInput.addEventListener('change', handleFileSelect);
        
        // æ‹–æ‹½ä¸Šä¼ å¤„ç†
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--primary-gold-light)';
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--primary-gold)';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--primary-gold)';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect({ target: { files: files } });
            }
        });

        // åˆ é™¤æ–‡ä»¶å¤„ç†
        removeFileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.value = '';
            uploadPlaceholder.style.display = 'block';
            filePreview.style.display = 'none';
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å° (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                return;
            }

            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                uploadPlaceholder.style.display = 'none';
                filePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // è¡¨å•è¾“å…¥éªŒè¯
        function validateForm() {
            // éªŒè¯å¿…å¡«å­—æ®µ
            const houseType = document.getElementById('house-type').value;
            const direction = document.getElementById('direction').value;
            const area = document.getElementById('area').value;
            
            if (!houseType) {
                const errorMsg = currentLang === 'en' ? 
                    'Please select property type' : 
                    'è¯·é€‰æ‹©æˆ¿å±‹ç±»å‹';
                alert(errorMsg);
                return false;
            }
            
            if (!direction) {
                const errorMsg = currentLang === 'en' ? 
                    'Please select house orientation' : 
                    'è¯·é€‰æ‹©æˆ¿å±‹æœå‘';
                alert(errorMsg);
                return false;
            }
            
            const areaValue = parseFloat(area);
            if (!area || isNaN(areaValue) || areaValue < 1 || areaValue > 10000) {
                const errorMsg = currentLang === 'en' ? 
                    'Area must be between 1 and 10,000 square meters' : 
                    'é¢ç§¯å¿…é¡»åœ¨1åˆ°10000å¹³æ–¹ç±³ä¹‹é—´';
                alert(errorMsg);
                document.getElementById('area').focus();
                return false;
            }
            
            return true;
        }

        // å‰ç«¯åˆ†æå¼•æ“ - å…œåº•æ–¹æ¡ˆ
        async function generateLocalAnalysis(formData, language = 'zh') {
            const isEnglish = language === 'en';
            
            // æˆ¿å±‹æœå‘è¯„åˆ†è¡¨
            const directionScores = {
                'æ­£å—': 92, 'ä¸œå—': 88, 'æ­£ä¸œ': 85, 'è¥¿å—': 82,
                'æ­£åŒ—': 78, 'ä¸œåŒ—': 75, 'æ­£è¥¿': 72, 'è¥¿åŒ—': 70,
                'ä¸ç¡®å®š': 75
            };
            
            const score = directionScores[formData.direction] || 75;
            
            function getScoreLevel(score) {
                if (score >= 90) return isEnglish ? "Excellent" : "æå‰æ ¼å±€";
                if (score >= 85) return isEnglish ? "Very Good" : "å¤§å‰æ ¼å±€";
                if (score >= 80) return isEnglish ? "Good" : "å‰åˆ©æ ¼å±€";
                if (score >= 75) return isEnglish ? "Above Average" : "è¾ƒä¸ºå‰åˆ©";
                return isEnglish ? "Average" : "ä¸­ç­‰æ°´å¹³";
            }

            const level = getScoreLevel(score);
            
            const analysisResult = {
                analysis: isEnglish ? 
                    `ğŸ  Professional Feng Shui Analysis

Property Details:
- Type: ${formData.houseType || 'Residential'}
- Direction: ${formData.direction || 'Unknown'}
- Area: ${formData.area || 'Not specified'}

â­ Overall Score: ${score}/100 (${level})

ğŸ§­ Directional Analysis: ${formData.direction || 'Unknown'} direction ${score >= 80 ? 'provides excellent feng shui energy for prosperity and harmony' : 'offers good potential with some optimization opportunities'}.

ğŸ’¡ Recommendations: ${score >= 85 ? 'Maintain current layout and add green plants for enhanced positive energy.' : 'Consider improving lighting and optimizing furniture arrangement for better energy flow.'}

ğŸ“‹ Important Notes: This analysis is based on traditional feng shui principles combined with modern living considerations.` :

                    `ğŸ”® AIé£æ°´å¤§å¸ˆä¸“ä¸šåˆ†ææŠ¥å‘Š

ğŸ  æˆ¿å±‹åŸºæœ¬ä¿¡æ¯ï¼š
- æˆ¿å±‹ç±»å‹ï¼š${formData.houseType || 'ä½å®…'}
- æˆ¿å±‹æœå‘ï¼š${formData.direction || 'ä¸ç¡®å®š'}
- æˆ¿å±‹é¢ç§¯ï¼š${formData.area || 'ä¸è¯¦'}

â­ ç»¼åˆè¯„åˆ†ï¼š${score}/100 (${level})

ğŸ§­ æœå‘åˆ†æï¼š${formData.direction || 'ä¸ç¡®å®š'}æœå‘${score >= 80 ? 'é£æ°´æ ¼å±€æä½³ï¼Œæœ‰åˆ©äºäº‹ä¸šå‘å±•å’Œå®¶åº­å’Œè°' : 'é£æ°´æ ¼å±€è‰¯å¥½ï¼Œé€šè¿‡åˆç†å¸ƒç½®å¯è¿›ä¸€æ­¥æå‡'}ã€‚

ğŸ’¡ æ”¹å–„å»ºè®®ï¼š${score >= 85 ? 'ä¿æŒç°æœ‰æ ¼å±€ï¼Œå®šæœŸæ•´ç†ï¼Œé€‚å½“æ·»åŠ ç»¿æ¤æå‡ç”Ÿæ°”ã€‚' : 'å»ºè®®ä¼˜åŒ–å®¤å†…ç…§æ˜ï¼Œè°ƒæ•´å®¶å…·æ‘†æ”¾ï¼Œç¡®ä¿é€šé“é¡ºç•…ã€‚'}

ğŸ“‹ é‡è¦æé†’ï¼šæœ¬åˆ†æåŸºäºä¼ ç»Ÿé£æ°´ç†è®ºç»“åˆç°ä»£å±…ä½éœ€æ±‚ï¼Œå»ºè®®ç»“åˆå®é™…æƒ…å†µç»¼åˆåˆ¤æ–­ã€‚`,

                recommendations: isEnglish ? 
                    "Focus on natural lighting, keep spaces organized, and consider adding plants for positive energy." :
                    "æ³¨é‡è‡ªç„¶é‡‡å…‰ï¼Œä¿æŒç©ºé—´æ•´æ´æœ‰åºï¼Œå¯é€‚å½“æ·»åŠ ç»¿æ¤æå‡æ­£èƒ½é‡ã€‚",

                importantNotes: isEnglish ?
                    "For major decisions, consider consulting with professional feng shui practitioners." :
                    "é‡å¤§å†³ç­–å»ºè®®å’¨è¯¢ä¸“ä¸šé£æ°´å¸ˆè¿›è¡Œå®åœ°æŒ‡å¯¼ã€‚",

                analysisData: {
                    score: score,
                    level: level,
                    direction: formData.direction || 'ä¸ç¡®å®š',
                    houseType: formData.houseType || 'ä½å®…',
                    area: formData.area || 'ä¸è¯¦',
                    timestamp: new Date().toISOString()
                },

                type: 'full',
                watermark: false,
                freeAccess: true,
                userTier: 'FREE',
                upgradeMessage: 'ğŸš€ Coming Soon! Professional analysis for $3.99+',
                showUpgradePrompt: true,
                message: isEnglish ? 'Now completely free, thank you for using our service!' : 'ç°åœ¨å®Œå…¨å…è´¹ï¼Œæ„Ÿè°¢æ‚¨çš„ä½¿ç”¨ï¼',

                userStatus: {
                    fingerprint: 'frontend_' + Date.now(),
                    dailyUsage: 1,
                    hasFreeAccess: true,
                    lastUsed: new Date().toISOString()
                }
            };

            // æ¨¡æ‹Ÿåˆ†æå»¶è¿Ÿï¼Œæå‡ç”¨æˆ·ä½“éªŒ
            await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 1500));
            
            return analysisResult;
        }

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('fengshui-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // éªŒè¯è¡¨å•
            if (!validateForm()) {
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const btn = document.getElementById('analyze-btn');
            const originalText = btn.textContent;
            btn.textContent = i18n[currentLang].analyzing;
            btn.disabled = true;
            
            // æ˜¾ç¤ºè¿›åº¦æŒ‡ç¤ºå™¨
            showProgressIndicator();

            try {
                // åˆ›å»ºFormDataå¯¹è±¡ä»¥æ”¯æŒæ–‡ä»¶ä¸Šä¼ 
                const formData = new FormData();
                formData.append('houseType', document.getElementById('house-type').value);
                formData.append('direction', document.getElementById('direction').value);
                formData.append('area', document.getElementById('area').value);
                formData.append('floorLevel', document.getElementById('floor-level').value);
                formData.append('roomCount', document.getElementById('room-count').value);
                formData.append('familySize', document.getElementById('family-size').value);
                formData.append('description', document.getElementById('description').value);
                formData.append('language', currentLang); // æ·»åŠ å½“å‰è¯­è¨€
                
                // æ·»åŠ æ–‡ä»¶ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                const fileInput = document.getElementById('house-photo');
                if (fileInput.files[0]) {
                    formData.append('photo', fileInput.files[0]);
                }

                // å°è¯•è°ƒç”¨åç«¯APIï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨å‰ç«¯åˆ†æ
                let analysisResult;
                
                try {
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            analysisResult = data.data;
                            console.log('âœ… ä½¿ç”¨åç«¯APIåˆ†æ');
                        } else {
                            throw new Error('APIè¿”å›é”™è¯¯');
                        }
                    } else {
                        throw new Error('APIè¯·æ±‚å¤±è´¥');
                    }
                } catch (apiError) {
                    console.log('âš ï¸ åç«¯APIä¸å¯ç”¨ï¼Œä½¿ç”¨å‰ç«¯åˆ†æå¼•æ“');
                    
                    // ä½¿ç”¨å‰ç«¯å†…ç½®åˆ†æå¼•æ“
                    const formDataObj = {};
                    for (let [key, value] of formData.entries()) {
                        formDataObj[key] = value;
                    }
                    
                    analysisResult = await generateLocalAnalysis(formDataObj, currentLang);
                }

                // æ˜¾ç¤ºåˆ†æç»“æœ
                console.log('ğŸ“Š åˆ†æç»“æœæ•°æ®:', analysisResult);
                hideProgressIndicator();
                displayResult(analysisResult);
                
            } catch (error) {
                console.error('åˆ†æè¯·æ±‚å¤±è´¥:', error);
                const errorMsg = currentLang === 'en' ? 
                    'Analysis failed, please try again: ' + error.message : 
                    'åˆ†æè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼š' + error.message;
                alert(errorMsg);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.textContent = originalText;
                btn.disabled = false;
                // ç¡®ä¿åœ¨é”™è¯¯æƒ…å†µä¸‹ä¹Ÿéšè—è¿›åº¦æŒ‡ç¤ºå™¨
                hideProgressIndicator();
            }
        });

        // æ˜¾ç¤ºåˆ†æç»“æœ
        function displayResult(result) {
            // ä¿å­˜ç»“æœä¾›è¯­è¨€åˆ‡æ¢æ—¶é‡æ–°æ¸²æŸ“
            window.lastAnalysisResult = result;
            
            const resultSection = document.getElementById('result-section');
            const resultContent = document.getElementById('result-content');
            
            console.log('ğŸ“Š å®Œæ•´ç»“æœæ•°æ®:', result);
            
            // æ›´æ™ºèƒ½çš„æ•°æ®æå–å’Œæ˜¾ç¤º
            const scoreInfo = getScoreInfo(result);
            const directionInfo = getDirectionInfo(result);
            const layoutInfo = getLayoutInfo(result);
            const actionInfo = getActionInfo(result);
            const notesInfo = getNotesInfo(result);
            
            resultContent.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary-gold); margin-bottom: 10px;" data-i18n="scoreTitle">ç»¼åˆè¯„åˆ†</h3>
                    <div style="font-size: 1.5em; color: var(--text-primary);">${scoreInfo}</div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary-gold); margin-bottom: 10px;" data-i18n="directionTitle">æœå‘åˆ†æ</h3>
                    <p style="color: var(--text-secondary); line-height: 1.6; white-space: pre-line;">${directionInfo}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary-gold); margin-bottom: 10px;" data-i18n="layoutTitle">å¸ƒå±€å»ºè®®</h3>
                    <p style="color: var(--text-secondary); line-height: 1.6; white-space: pre-line;">${layoutInfo}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary-gold); margin-bottom: 10px;" data-i18n="actionTitle">ç«‹å³æ”¹å–„å»ºè®®</h3>
                    <p style="color: var(--text-secondary); line-height: 1.6; white-space: pre-line;">${actionInfo}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary-gold); margin-bottom: 10px;" data-i18n="notesTitle">é‡è¦æé†’</h3>
                    <p style="color: var(--text-secondary); line-height: 1.6; white-space: pre-line;">${notesInfo}</p>
                </div>
                
${getUpgradeSection(result)}
                
                <div style="background: rgba(218, 165, 32, 0.1); padding: 15px; border-radius: 6px; border-left: 3px solid var(--primary-gold);">
                    <h4 style="color: var(--primary-gold); margin-bottom: 8px; font-size: 0.9rem;" data-i18n="explanationTitle">ğŸ’¡ åˆ†æè¯´æ˜</h4>
                    <p style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.4;" data-i18n="explanationText">
                        é£æ°´åˆ†æä¼šç»“åˆå½“å‰æ—¶é—´ã€è¿åŠ¿å‘¨æœŸç­‰åŠ¨æ€å› ç´ ï¼Œå› æ­¤åŒæ ·æ¡ä»¶ä¸‹å¯èƒ½äº§ç”Ÿè½»å¾®å·®å¼‚ã€‚è¿™ä½“ç°äº†ä¼ ç»Ÿé£æ°´å­¦"å› æ—¶åˆ¶å®œ"çš„æ ¸å¿ƒç†å¿µï¼Œå»ºè®®ä»¥ç»¼åˆè¶‹åŠ¿ä¸ºå‡†ã€‚
                    </p>
                </div>
            `;
            
            // é‡æ–°åº”ç”¨å¤šè¯­è¨€ç¿»è¯‘åˆ°æ–°ç”Ÿæˆçš„å†…å®¹
            document.querySelectorAll('#result-section [data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[currentLang][key]) {
                    el.textContent = i18n[currentLang][key];
                }
            });
            
            // ä¿å­˜åŸå§‹åˆ†ææ•°æ®å’Œå½“å‰è¯­è¨€ï¼Œä»¥ä¾¿è¯­è¨€åˆ‡æ¢æ—¶é‡æ–°æ¸²æŸ“
            resultSection.setAttribute('data-original-result', JSON.stringify(result));
            resultSection.setAttribute('data-result-lang', currentLang);
            
            // è¿½è¸ªåˆ†æå®Œæˆäº‹ä»¶
            trackEvent('analysis_completed', { 
                tier: result.userTier || 'FREE', 
                score: result.score,
                hasImage: !!result.formData?.photo 
            });
            
            // ç§»é™¤è‡ªåŠ¨é‚®ç®±æ”¶é›†å¼¹çª— - å·²æ•´åˆåˆ°å‡çº§æµç¨‹ä¸­
            // å…è´¹ç”¨æˆ·çš„é‚®ç®±æ”¶é›†ç°åœ¨åœ¨å‡çº§æŒ‰é’®ç‚¹å‡»æ—¶è§¦å‘
            
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // æ™ºèƒ½æå–è¯„åˆ†ä¿¡æ¯
        function getScoreInfo(result) {
            const scoreUnit = currentLang === 'en' ? ' Points' : 'åˆ†';
            
            if (result.gradeInfo && result.gradeInfo.name && result.score) {
                return `${result.score}${scoreUnit} - ${result.gradeInfo.name}`;
            } else if (result.score) {
                // æ ¹æ®åˆ†æ•°æ¨å¯¼ç­‰çº§
                const grade = getGradeByScore(result.score);
                return `${result.score}${scoreUnit} - ${grade}`;
            } else if (result.fengshuiScore) {
                return `${result.fengshuiScore}${scoreUnit}`;
            } else {
                return currentLang === 'en' ? 'Analysis Complete' : 'åˆ†æå®Œæˆ';
            }
        }

        // æ ¹æ®åˆ†æ•°ç¡®å®šç­‰çº§ï¼ˆæ”¯æŒå¤šè¯­è¨€ï¼‰
        function getGradeByScore(score) {
            const currentLang = document.documentElement.lang || 'zh';
            
            // ä¿®æ­£ç­‰çº§èŒƒå›´å’Œé¡ºåº
            const gradeRanges = [
                { min: 85, zh: 'æå‰æ ¼å±€', en: 'Extremely Auspicious' },
                { min: 75, zh: 'ä¸Šå‰æ ¼å±€', en: 'Very Auspicious' },
                { min: 65, zh: 'ä¸­å‰æ ¼å±€', en: 'Moderately Auspicious' },
                { min: 55, zh: 'å°å‰æ ¼å±€', en: 'Slightly Auspicious' },
                { min: 45, zh: 'ä¸­å¹³æ ¼å±€', en: 'Neutral' },
                { min: 35, zh: 'å°å‡¶æ ¼å±€', en: 'Slightly Inauspicious' },
                { min: 25, zh: 'å¤§å‡¶æ ¼å±€', en: 'Very Inauspicious' },
                { min: 0, zh: 'å‡¶é™©æ ¼å±€', en: 'Extremely Inauspicious' }
            ];
            
            for (let range of gradeRanges) {
                if (score >= range.min) {
                    return range[currentLang];
                }
            }
            
            // é»˜è®¤è¿”å›æœ€ä½ç­‰çº§
            return currentLang === 'en' ? 'Extremely Inauspicious' : 'å‡¶é™©æ ¼å±€';
        }

        // å…è´¹ç‰ˆå†…å®¹æˆªæ–­è¾…åŠ©å‡½æ•°
        function truncateContent(content, maxLength) {
            if (content.length <= maxLength) return content;
            return content.substring(0, maxLength) + '...';
        }

        // å…è´¹ç‰ˆå‡çº§æç¤º
        function getFreeVersionPrompt(type) {
            // æ”¹è¿›è¯­è¨€æ£€æµ‹ï¼šä¼˜å…ˆæ£€æŸ¥DOMè¯­è¨€å±æ€§
            let currentLang = 'zh'; // é»˜è®¤ä¸­æ–‡
            
            // æ–¹æ³•1ï¼šæ£€æŸ¥HTML langå±æ€§
            if (document.documentElement.lang && document.documentElement.lang.startsWith('en')) {
                currentLang = 'en';
            }
            // æ–¹æ³•2ï¼šæ£€æŸ¥i18nManager
            else if (window.i18nManager && window.i18nManager.getCurrentLanguage) {
                currentLang = window.i18nManager.getCurrentLanguage();
            }
            // æ–¹æ³•3ï¼šæ£€æŸ¥localStorage
            else if (localStorage.getItem('preferred-language') === 'en') {
                currentLang = 'en';
            }
            
            console.log('getFreeVersionPrompt currentLang:', currentLang); // è°ƒè¯•ç”¨
            
            // ç›´æ¥ä½¿ç”¨è¯­è¨€æ˜ å°„
            const prompts = {
                'zh': {
                    'direction': '\n\nğŸ”“ å‡çº§è‡³Basicç‰ˆ($3.99)è§£é”å®Œæ•´æœå‘åˆ†æ',
                    'layout': '\n\nğŸ”“ å‡çº§è‡³Professionalç‰ˆ($4.99)è§£é”è¯¦ç»†å¸ƒå±€æ–¹æ¡ˆ',
                    'action': '\n\nğŸ”“ å‡çº§è‡³Professionalç‰ˆ($4.99)è·å–å…¨éƒ¨æ”¹å–„å»ºè®®',
                    'notes': '\n\nğŸ”“ å‡çº§è‡³Masterç‰ˆ($29.99)è·å–ä¸“ä¸šé£æ°´æé†’',
                    'default': '\n\nğŸ”“ å‡çº§è§£é”æ›´å¤šè¯¦ç»†å†…å®¹'
                },
                'en': {
                    'direction': '\n\nğŸ”“ Upgrade to Basic ($3.99) for Complete Orientation Analysis',
                    'layout': '\n\nğŸ”“ Upgrade to Professional ($4.99) for Detailed Layout Plans',
                    'action': '\n\nğŸ”“ Upgrade to Professional ($4.99) for Complete Improvement Suggestions',
                    'notes': '\n\nğŸ”“ Upgrade to Master ($29.99) for Professional Feng Shui Insights',
                    'default': '\n\nğŸ”“ Upgrade to unlock more detailed content'
                }
            };
            
            const langPrompts = prompts[currentLang] || prompts['zh'];
            return langPrompts[type] || langPrompts['default'];
        }

        // æ™ºèƒ½æå–æœå‘åˆ†æ
        function getDirectionInfo(result) {
            const classifiedContent = result.classifiedContent || {};
            let content = '';
            
            if (classifiedContent.directionAnalysis) {
                content = formatTextWithBreaks(classifiedContent.directionAnalysis);
            } else {
                // ä»å®Œæ•´åˆ†æä¸­æå–æœå‘ç›¸å…³å†…å®¹
                const analysis = result.analysis || '';
                const directionMatch = analysis.match(/ã€æ–¹ä½åˆ†æã€‘(.*?)ã€/s);
                if (directionMatch) {
                    content = formatTextWithBreaks(directionMatch[1]);
                } else {
                    content = 'æœå‘åˆ†ææ•°æ®æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨åæŸ¥çœ‹';
                }
            }
            
            // å…è´¹ç‰ˆå†…å®¹é™åˆ¶
            if (result.userTier === 'FREE') {
                return truncateContent(content, 80) + getFreeVersionPrompt('direction');
            }
            
            return content;
        }

        // æ™ºèƒ½æå–å¸ƒå±€å»ºè®®
        function getLayoutInfo(result) {
            let content = '';
            
            const classifiedContent = result.classifiedContent || {};
            if (classifiedContent.layoutSuggestions) {
                content = formatTextWithBreaks(classifiedContent.layoutSuggestions);
            } else {
                const analysis = result.analysis || '';
                const layoutMatch = analysis.match(/ã€å¸ƒå±€.*?å»ºè®®ã€‘(.*?)ã€/s);
                if (layoutMatch) {
                    content = formatTextWithBreaks(layoutMatch[1]);
                } else if (result.recommendations) {
                    content = formatTextWithBreaks(result.recommendations);
                } else {
                    content = 'å¸ƒå±€å»ºè®®æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨åæŸ¥çœ‹';
                }
            }
            
            // å…è´¹ç‰ˆå’ŒBasicç‰ˆå†…å®¹é™åˆ¶ - éœ€è¦Professionalç‰ˆ
            if (result.userTier === 'FREE' || result.userTier === 'BASIC') {
                return truncateContent(content, 60) + getFreeVersionPrompt('layout');
            }
            
            return content;
        }

        // æ™ºèƒ½æå–è¡ŒåŠ¨å»ºè®®
        function getActionInfo(result) {
            console.log('ğŸ” æå–è¡ŒåŠ¨å»ºè®®:', result);
            
            // ä¼˜å…ˆä»ä¼˜åŒ–æ–¹æ¡ˆä¸­æå–ç«‹å³è¡ŒåŠ¨å»ºè®®
            if (result.classifiedContent && result.classifiedContent.optimizationPlan) {
                const plan = result.classifiedContent.optimizationPlan;
                if (plan.immediate && plan.immediate.trim() && !plan.immediate.includes('immediate_start')) {
                    return formatTextWithBreaks(plan.immediate);
                }
            }
            
            // ä»urgentActionsæ•°ç»„æˆ–å­—ç¬¦ä¸²ä¸­æå–
            if (result.urgentActions) {
                let actions = '';
                if (Array.isArray(result.urgentActions)) {
                    // å¦‚æœæ˜¯æ•°ç»„ï¼Œå–å‰3æ¡å¹¶è¿‡æ»¤æ‰åŒ…å«å ä½ç¬¦çš„å†…å®¹
                    actions = result.urgentActions
                        .filter(action => action && !action.includes('immediate_start') && !action.includes('å‡çº§åˆ°è¿›é˜¶ç‰ˆ'))
                        .slice(0, 3)
                        .join('ï¼›');
                } else if (typeof result.urgentActions === 'string' && result.urgentActions.trim()) {
                    actions = result.urgentActions.replace(/immediate_start/g, '').trim();
                }
                
                if (actions) {
                    return formatTextWithBreaks(actions);
                }
            }
            
            // ä»åˆ†æå†…å®¹ä¸­æå–æ”¹å–„æªæ–½
            const analysis = result.analysis || '';
            const actionMatch = analysis.match(/ã€å…·ä½“æ”¹å–„æªæ–½ã€‘(.*?)ã€/s);
            if (actionMatch && actionMatch[1].trim()) {
                return formatTextWithBreaks(actionMatch[1]);
            }
            
            // å¤‡é€‰æ–¹æ¡ˆï¼šä»recommendationsä¸­æå–å¹¶æ¸…ç†
            if (result.recommendations) {
                let recs = '';
                if (Array.isArray(result.recommendations)) {
                    recs = result.recommendations
                        .filter(rec => rec && !rec.includes('å‡çº§åˆ°è¿›é˜¶ç‰ˆ'))
                        .join('ï¼›');
                } else if (typeof result.recommendations === 'string') {
                    recs = cleanText(result.recommendations);
                    // ç§»é™¤å‡çº§ç›¸å…³çš„å†…å®¹
                    recs = recs.replace(/ï¼›å‡çº§åˆ°.*?ç‰ˆå¯.*?$/g, '').replace(/ï¼›å‡çº§åˆ°.*?è¯¦ç»†.*?$/g, '');
                }
                
                if (recs && recs.trim()) {
                    const sentences = recs.split(/[.ã€‚;ï¼›]/).filter(s => s.trim());
                    return sentences.slice(0, 3).join('ï¼›');
                }
            }
            
            // åŸºäºæˆ¿å±‹ä¿¡æ¯ç”Ÿæˆå…·ä½“å»ºè®®
            const formData = result.formData || {};
            const direction = formData.direction || '';
            const houseType = formData.houseType || '';
            
            let specificAdvice = '';
            if (direction === 'å—' || direction === 'south') {
                specificAdvice = currentLang === 'en' ? 
                    'Keep the main entrance clean and bright; Place plants near the entrance; Ensure good lighting in the living room' :
                    'ä¿æŒå…¥æˆ·é—¨æ¸…æ´æ˜äº®ï¼›åœ¨å…¥å£å¤„æ‘†æ”¾ç»¿æ¤ï¼›ç¡®ä¿å®¢å…å…‰çº¿å……è¶³';
            } else if (direction === 'åŒ—' || direction === 'north') {
                specificAdvice = currentLang === 'en' ? 
                    'Use warm lighting to enhance energy; Place metal decorations in the north; Keep the entrance area warm and inviting' :
                    'ä½¿ç”¨æš–è‰²ç¯å…‰å¢å¼ºæ°”åœºï¼›åœ¨åŒ—æ–¹ä½æ‘†æ”¾é‡‘å±è£…é¥°ï¼›ä¿æŒå…¥å£åŒºåŸŸæ¸©æš–å®œäºº';
            } else {
                specificAdvice = currentLang === 'en' ? 
                    'Maintain clean and uncluttered spaces; Ensure proper ventilation throughout; Use appropriate lighting for each area' :
                    'ä¿æŒç©ºé—´æ•´æ´æ— æ‚ç‰©ï¼›ç¡®ä¿å…¨å±‹é€šé£è‰¯å¥½ï¼›ä¸ºå„åŒºåŸŸé…ç½®é€‚å½“ç…§æ˜';
            }
            
            // å…è´¹ç‰ˆå’ŒBasicç‰ˆå†…å®¹é™åˆ¶ - éœ€è¦Professionalç‰ˆ
            if (result.userTier === 'FREE' || result.userTier === 'BASIC') {
                return truncateContent(specificAdvice, 70) + getFreeVersionPrompt('action');
            }
            
            return specificAdvice;
        }

        // æ™ºèƒ½æå–æ³¨æ„äº‹é¡¹
        function getNotesInfo(result) {
            let content = '';
            
            const classifiedContent = result.classifiedContent || {};
            if (classifiedContent.importantNotes) {
                content = formatTextWithBreaks(classifiedContent.importantNotes);
            } else {
                const analysis = result.analysis || '';
                const notesMatch = analysis.match(/ã€æ³¨æ„äº‹é¡¹ã€‘(.*?)$/s);
                if (notesMatch) {
                    content = formatTextWithBreaks(notesMatch[1]);
                } else {
                    content = 'é‡è¦æé†’ä¿¡æ¯æ­£åœ¨æ•´ç†ä¸­';
                }
            }
            
            // å…è´¹ç‰ˆã€Basicç‰ˆã€Professionalç‰ˆå†…å®¹é™åˆ¶ - éœ€è¦Masterç‰ˆ
            if (result.userTier !== 'MASTER') {
                return truncateContent(content, 50) + getFreeVersionPrompt('notes');
            }
            
            return content;
        }

        // é‚®ç®±æ”¶é›†åŠŸèƒ½
        function showEmailCollector(message) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                justify-content: center; align-items: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: var(--bg-card); padding: 30px; border-radius: 12px;
                max-width: 450px; width: 90%; text-align: center; border: 2px solid var(--primary-gold);
            `;
            
            content.innerHTML = `
                <div style="color: var(--primary-gold); font-size: 24px; margin-bottom: 15px;">ğŸš€</div>
                <h3 style="color: var(--primary-gold); margin-bottom: 15px;">
                    ${currentLang === 'en' ? 'Get Early Access!' : 'æŠ¢å…ˆä½“éªŒï¼'}
                </h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px; line-height: 1.5;">
                    ${message || (currentLang === 'en' ? 
                        'Be the first to know when paid plans are available!' : 
                        'ä»˜è´¹è®¡åˆ’ä¸Šçº¿æ—¶ç¬¬ä¸€æ—¶é—´é€šçŸ¥æ‚¨ï¼')}
                </p>
                <input type="email" id="email-collector-input" placeholder="${currentLang === 'en' ? 'Enter your email' : 'è¾“å…¥æ‚¨çš„é‚®ç®±'}" 
                       style="width: 100%; padding: 12px; border: 1px solid var(--primary-gold); border-radius: 6px; 
                              background: var(--bg-input); color: var(--text-primary); margin-bottom: 15px;">
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="collectEmail()" 
                            style="background: var(--primary-gold); color: var(--bg-primary); border: none; 
                                   padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        ${currentLang === 'en' ? 'Notify Me' : 'é€šçŸ¥æˆ‘'}
                    </button>
                    <button onclick="this.closest('.email-collector-modal').remove()" 
                            style="background: transparent; color: var(--text-secondary); border: 1px solid var(--text-secondary); 
                                   padding: 12px 20px; border-radius: 6px; cursor: pointer;">
                        ${currentLang === 'en' ? 'Maybe Later' : 'ç¨åå†è¯´'}
                    </button>
                </div>
            `;
            
            modal.className = 'email-collector-modal';
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        function collectEmail() {
            const email = document.getElementById('email-collector-input').value;
            if (!email || !email.includes('@')) {
                alert(currentLang === 'en' ? 'Please enter a valid email address' : 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                return;
            }
            
            // è®°å½•é‚®ç®±åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒåº”å‘é€åˆ°æœåŠ¡å™¨ï¼‰
            const emails = JSON.parse(localStorage.getItem('collected_emails') || '[]');
            emails.push({
                email: email,
                timestamp: new Date().toISOString(),
                source: 'upgrade_prompt'
            });
            localStorage.setItem('collected_emails', JSON.stringify(emails));
            
            // è¿½è¸ªäº‹ä»¶
            trackEvent('email_collected', { source: 'upgrade_prompt' });
            
            alert(currentLang === 'en' ? 'âœ… Thanks! We\'ll notify you soon!' : 'âœ… è°¢è°¢ï¼æˆ‘ä»¬ä¼šå°½å¿«é€šçŸ¥æ‚¨ï¼');
            document.querySelector('.email-collector-modal').remove();
        }

        // ç”Ÿæˆå‡çº§æŒ‰é’®å’Œä»·æ ¼æ–¹æ¡ˆ
        function getUpgradeSection(result) {
            // æ£€æŸ¥æ˜¯å¦æœ‰å‡çº§æç¤ºæ•°æ®
            if (!result.upgradePrompt || !result.upgradePrompt.show) {
                return '';
            }

            const upgrade = result.upgradePrompt;
            const isEn = currentLang === 'en';
            
            return `
                <div style="background: linear-gradient(135deg, rgba(218, 165, 32, 0.15), rgba(255, 204, 0, 0.15)); 
                           padding: 25px; border-radius: 12px; border: 2px solid var(--primary-gold); 
                           margin: 30px 0; position: relative;">
                    
                    <div style="position: absolute; top: -10px; left: 20px; background: var(--bg-card); 
                               padding: 5px 15px; border-radius: 20px; border: 2px solid var(--primary-gold);">
                        <span style="color: var(--primary-gold); font-weight: bold; font-size: 0.9rem;">
                            ${isEn ? 'ğŸš€ Upgrade Available' : 'ğŸš€ å‡çº§å¯ç”¨'}
                        </span>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h3 style="color: var(--primary-gold); margin-bottom: 15px; font-size: 1.3rem;">
                            ${upgrade.title || (isEn ? 'Upgrade to Premium Analysis' : 'å‡çº§åˆ°ä¸“ä¸šç‰ˆåˆ†æ')}
                        </h3>
                        
                        <p style="color: var(--text-secondary); margin-bottom: 20px; line-height: 1.6;">
                            ${upgrade.description || (isEn ? 'Get detailed professional analysis with advanced features' : 'è·å¾—è¯¦ç»†çš„ä¸“ä¸šåˆ†æå’Œé«˜çº§åŠŸèƒ½')}
                        </p>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; justify-content: center;">
                            <!-- åŸºç¡€ç‰ˆ - å¼•å¯¼ç‰ˆæœ¬ -->
                            <div style="background: var(--bg-card); padding: 18px; border-radius: 8px; flex: 1; min-width: 220px; max-width: 300px; border: 1px solid #666; opacity: 0.9;">
                                <h4 style="color: #888; margin-bottom: 10px; font-size: 1rem;">
                                    â­ ${isEn ? 'Basic ($3.99)' : 'åŸºç¡€ç‰ˆ ($3.99)'}
                                </h4>
                                <ul style="color: var(--text-muted); line-height: 1.6; padding-left: 16px; margin: 0; font-size: 0.9rem;">
                                    <li>${isEn ? 'Limited analysis (200-300 words)' : 'ç®€åŒ–åˆ†ææŠ¥å‘Š (200-300å­—)'}</li>
                                    <li>${isEn ? 'Basic layout suggestions' : 'åŸºç¡€å¸ƒå±€å»ºè®®'}</li>
                                    <li>${isEn ? 'Text export only' : 'ä»…æ–‡æœ¬å¯¼å‡º'}</li>
                                    <li style="color: #666;">${isEn ? 'No image analysis' : 'ä¸æ”¯æŒå›¾ç‰‡åˆ†æ'}</li>
                                    <li style="color: #666;">${isEn ? 'No timing guidance' : 'æ— æ—¶é—´æ‹©å‰'}</li>
                                </ul>
                            </div>
                            
                            <!-- ä¸“ä¸šç‰ˆ - ä¸»æ¨ç‰ˆæœ¬ -->
                            <div style="background: var(--bg-card); padding: 20px; border-radius: 8px; flex: 1; min-width: 220px; max-width: 300px; border: 2px solid var(--primary-gold); position: relative; transform: scale(1.05);">
                                <div style="position: absolute; top: -10px; right: 10px; background: var(--primary-gold); color: var(--bg-primary); padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">
                                    ${isEn ? 'RECOMMENDED' : 'æ¨è'}
                                </div>
                                <h4 style="color: var(--primary-gold); margin-bottom: 10px;">
                                    ğŸ’ ${isEn ? 'Professional ($4.99)' : 'ä¸“ä¸šç‰ˆ ($4.99)'}
                                </h4>
                                <ul style="color: var(--text-secondary); line-height: 1.8; padding-left: 20px; margin: 0;">
                                    <li>${isEn ? 'Detailed analysis (800-1200 words)' : 'è¯¦ç»†åˆ†ææŠ¥å‘Š (800-1200å­—)'}</li>
                                    <li>${isEn ? 'Advanced AI image recognition' : 'é«˜çº§æˆ·å‹å›¾AIè¯†åˆ«'}</li>
                                    <li>${isEn ? 'Personalized timing recommendations' : 'ä¸ªæ€§åŒ–æ—¶é—´å»ºè®®å’Œæ‹©å‰'}</li>
                                    <li>${isEn ? 'PDF + image export' : 'PDFå’Œå›¾ç‰‡å¯¼å‡º'}</li>
                                    <li>${isEn ? '30-day unlimited access' : '30å¤©å†…æ— é™æ¬¡æŸ¥çœ‹'}</li>
                                </ul>
                            </div>
                            
                            <!-- å¤§å¸ˆç‰ˆ - é«˜çº§ç‰ˆæœ¬ -->
                            <div style="background: var(--bg-card); padding: 20px; border-radius: 8px; flex: 1; min-width: 220px; max-width: 300px; border: 1px solid #FFD700;">
                                <h4 style="color: #FFD700; margin-bottom: 10px;">
                                    ğŸ‘‘ ${isEn ? 'Master ($29.99)' : 'å¤§å¸ˆç‰ˆ ($29.99)'}
                                </h4>
                                <ul style="color: var(--text-secondary); line-height: 1.8; padding-left: 20px; margin: 0;">
                                    <li>${isEn ? 'Everything in Professional' : 'åŒ…å«ä¸“ä¸šç‰ˆæ‰€æœ‰åŠŸèƒ½'}</li>
                                    <li>${isEn ? 'Multi-angle image analysis' : 'å¤šè§’åº¦å›¾ç‰‡æ·±åº¦åˆ†æ'}</li>
                                    <li>${isEn ? 'Advanced AI modeling & simulation' : 'é«˜çº§AIå»ºæ¨¡å’Œæ¨¡æ‹Ÿ'}</li>
                                    <li>${isEn ? 'Historical trend analysis' : 'å†å²è¿åŠ¿è¶‹åŠ¿åˆ†æ'}</li>
                                    <li>${isEn ? 'Lifetime report access' : 'ç»ˆèº«æŠ¥å‘Šè®¿é—®æƒé™'}</li>
                                    <li>${isEn ? 'Priority AI processing' : 'AIä¼˜å…ˆå¤„ç†é€šé“'}</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                            <!-- åŸºç¡€ç‰ˆæŒ‰é’® - ä½è°ƒæ ·å¼ -->
                            <button onclick="upgradeToTier('BASIC')" 
                                    style="background: linear-gradient(135deg, #666, #777); 
                                           color: white; border: none; padding: 12px 24px; 
                                           border-radius: 20px; font-size: 0.9rem; font-weight: normal; 
                                           cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(102, 102, 102, 0.3);"
                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 102, 102, 0.4)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 102, 102, 0.3)';">
                                â­ ${isEn ? 'Try Basic - $3.99' : 'å°è¯•åŸºç¡€ç‰ˆ - $3.99'}
                            </button>
                            
                            <!-- ä¸“ä¸šç‰ˆæŒ‰é’® - ä¸»æ¨æ ·å¼ -->
                            <button onclick="upgradeToTier('PROFESSIONAL')" 
                                    style="background: linear-gradient(135deg, var(--primary-gold), #ffcc00); 
                                           color: var(--bg-primary); border: none; padding: 16px 32px; 
                                           border-radius: 25px; font-size: 1.1rem; font-weight: bold; 
                                           cursor: pointer; transition: all 0.3s ease; box-shadow: 0 6px 16px rgba(218, 165, 32, 0.4);
                                           transform: scale(1.05);"
                                    onmouseover="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 8px 24px rgba(218, 165, 32, 0.5)';"
                                    onmouseout="this.style.transform='translateY(0) scale(1.05)'; this.style.boxShadow='0 6px 16px rgba(218, 165, 32, 0.4)';">
                                ğŸ’ ${isEn ? 'Get Professional - $4.99' : 'é€‰æ‹©ä¸“ä¸šç‰ˆ - $4.99'}
                            </button>
                            
                            <!-- å¤§å¸ˆç‰ˆæŒ‰é’® -->
                            <button onclick="upgradeToTier('MASTER')" 
                                    style="background: linear-gradient(135deg, #FFD700, #FFA500); 
                                           color: var(--bg-primary); border: none; padding: 15px 30px; 
                                           border-radius: 25px; font-size: 1rem; font-weight: bold; 
                                           cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 215, 0, 0.4)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255, 215, 0, 0.3)';">
                                ğŸ‘‘ ${isEn ? 'Upgrade to Master - $29.99' : 'å‡çº§åˆ°å¤§å¸ˆç‰ˆ - $29.99'}
                            </button>
                        </div>
                        
                        <div style="text-align: center; margin-top: 15px;">
                            <p style="color: var(--text-muted); font-size: 0.85rem;">
                                ${isEn ? 'âœ¨ Secure payment â€¢ 30-day money-back guarantee' : 'âœ¨ å®‰å…¨æ”¯ä»˜ â€¢ 30å¤©é€€æ¬¾ä¿è¯'}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // å¤„ç†å‡çº§åˆ°æŒ‡å®šç­‰çº§
        function upgradeToTier(tier) {
            const isEn = currentLang === 'en';
            const tierNames = {
                'BASIC': isEn ? 'Basic' : 'åŸºç¡€ç‰ˆ',
                'PROFESSIONAL': isEn ? 'Professional' : 'ä¸“ä¸šç‰ˆ',
                'MASTER': isEn ? 'Master' : 'å¤§å¸ˆç‰ˆ'
            };
            const prices = {
                'BASIC': '$3.99',
                'PROFESSIONAL': '$4.99',
                'MASTER': '$29.99'
            };
            
            // ç‰¹åˆ«å¤„ç†åŸºç¡€ç‰ˆ - æç¤ºå‡çº§åˆ°ä¸“ä¸šç‰ˆ
            if (tier === 'BASIC') {
                const basicWarning = isEn ? 
                    `Are you sure you want the Basic version ($3.99)?\n\nâš ï¸ Limited features:\nâ€¢ Only 200-300 words analysis\nâ€¢ No image analysis\nâ€¢ Basic suggestions only\n\nğŸ’¡ Professional version ($4.99) offers much better value with detailed analysis and image recognition!\n\nContinue with Basic?` :
                    `ç¡®å®šé€‰æ‹©åŸºç¡€ç‰ˆ ($3.99)ï¼Ÿ\n\nâš ï¸ åŠŸèƒ½å—é™ï¼š\nâ€¢ ä»…200-300å­—åˆ†æ\nâ€¢ ä¸æ”¯æŒå›¾ç‰‡åˆ†æ\nâ€¢ ä»…åŸºç¡€å»ºè®®\n\nğŸ’¡ ä¸“ä¸šç‰ˆ ($4.99) æ€§ä»·æ¯”æ›´é«˜ï¼ŒåŒ…å«è¯¦ç»†åˆ†æå’Œå›¾ç‰‡è¯†åˆ«ï¼\n\nä»è¦é€‰æ‹©åŸºç¡€ç‰ˆï¼Ÿ`;
                
                if (!confirm(basicWarning)) {
                    // å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œè¯¢é—®æ˜¯å¦è¦ä¸“ä¸šç‰ˆ
                    const upgradeConfirm = isEn ?
                        'Would you like to upgrade to Professional version ($4.99) instead?' :
                        'æ˜¯å¦é€‰æ‹©ä¸“ä¸šç‰ˆ ($4.99)ï¼Ÿ';
                    if (confirm(upgradeConfirm)) {
                        upgradeToTier('PROFESSIONAL');
                    }
                    return;
                }
            }
            
            // ç›´æ¥æ˜¾ç¤ºè”ç³»ä¿¡æ¯ï¼Œä¸éœ€è¦ç¡®è®¤æ¡†
            const contactMsg = isEn ?
                `Upgrade to ${tierNames[tier]} (${prices[tier]})\n\nPayment system integration in progress.\n\nPlease contact support for manual upgrade:\nğŸ“§ Email: 15101623@qq.com\nğŸ’¬ WeChat: Please email for WeChat ID\n\nğŸš€ Coming Soon: Automatic payment system!` :
                `å‡çº§åˆ°${tierNames[tier]} (${prices[tier]})\n\næ”¯ä»˜ç³»ç»Ÿæ­£åœ¨é›†æˆä¸­ã€‚\n\nè¯·è”ç³»å®¢æœè¿›è¡Œæ‰‹åŠ¨å‡çº§ï¼š\nğŸ“§ é‚®ç®±ï¼š15101623@qq.com\nğŸ’¬ å¾®ä¿¡ï¼šè¯·é‚®ä»¶è”ç³»è·å–å¾®ä¿¡å·\n\nğŸš€ Coming Soon: è‡ªåŠ¨æ”¯ä»˜ç³»ç»Ÿå³å°†ä¸Šçº¿ï¼`;
                
                // åˆ›å»ºæ›´å‹å¥½çš„å¼¹çª—
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.8); z-index: 10000;
                    display: flex; justify-content: center; align-items: center;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
                        padding: 30px; border-radius: 15px; max-width: 450px; 
                        color: #f4f4f4; text-align: center; border: 2px solid #DAA520;
                        box-shadow: 0 10px 30px rgba(218, 165, 32, 0.3);
                    ">
                        <h3 style="color: #DAA520; margin-bottom: 20px;">
                            ${isEn ? 'ğŸš€ Coming Soon!' : 'ğŸš€ å³å°†æ¨å‡ºï¼'}
                        </h3>
                        <p style="line-height: 1.6; margin-bottom: 20px; white-space: pre-line;">
                            ${contactMsg}
                        </p>
                        
                        <div style="margin: 20px 0; padding: 15px; background: rgba(218, 165, 32, 0.1); border-radius: 10px; text-align: left;">
                            <p style="margin-bottom: 10px; font-weight: bold; color: #DAA520;">
                                ${isEn ? 'ğŸ“§ Get notified when payment is ready:' : 'ğŸ“§ æ”¯ä»˜ç³»ç»Ÿä¸Šçº¿æ—¶é€šçŸ¥æ‚¨ï¼š'}
                            </p>
                            <input type="email" id="upgrade-email" placeholder="${isEn ? 'Your email address' : 'æ‚¨çš„é‚®ç®±åœ°å€'}" style="
                                width: 100%; padding: 8px; border: 1px solid #DAA520; 
                                border-radius: 5px; background: #2d2d2d; color: #f4f4f4;
                                margin-bottom: 10px;
                            ">
                            <p style="font-size: 12px; color: #999; margin: 0;">
                                ${isEn ? 'Optional - We\'ll email you when automatic payment is available' : 'å¯é€‰ - è‡ªåŠ¨æ”¯ä»˜ä¸Šçº¿æ—¶æˆ‘ä»¬ä¼šé‚®ä»¶é€šçŸ¥æ‚¨'}
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="saveEmailAndClose()" style="
                                background: linear-gradient(45deg, #DAA520, #B8860B);
                                color: white; border: none; padding: 10px 20px;
                                border-radius: 25px; cursor: pointer; font-weight: bold;
                            ">
                                ${isEn ? 'Save & Close' : 'ä¿å­˜å¹¶å…³é—­'}
                            </button>
                            <button onclick="this.closest('div').parentElement.remove()" style="
                                background: #666; color: white; border: none; padding: 10px 20px;
                                border-radius: 25px; cursor: pointer;
                            ">
                                ${isEn ? 'Skip' : 'è·³è¿‡'}
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // æ·»åŠ å…¨å±€å‡½æ•°
                window.saveEmailAndClose = function() {
                    const email = document.getElementById('upgrade-email').value.trim();
                    
                    if (email) {
                        // ç®€å•é‚®ç®±éªŒè¯
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(email)) {
                            alert(isEn ? 'Please enter a valid email address' : 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                            return;
                        }
                        
                        // ä¿å­˜åˆ°localStorageï¼ˆå¯ä»¥åç»­æ”¹ä¸ºå‘é€åˆ°æœåŠ¡å™¨ï¼‰
                        const savedEmails = JSON.parse(localStorage.getItem('upgrade_emails') || '[]');
                        if (!savedEmails.includes(email)) {
                            savedEmails.push(email);
                            localStorage.setItem('upgrade_emails', JSON.stringify(savedEmails));
                        }
                        
                        // è®°å½•å‡çº§æ„å‘
                        const upgradeIntentions = JSON.parse(localStorage.getItem('upgrade_intentions') || '[]');
                        upgradeIntentions.push({
                            email: email,
                            tier: tier,
                            price: prices[tier],
                            timestamp: new Date().toISOString()
                        });
                        localStorage.setItem('upgrade_intentions', JSON.stringify(upgradeIntentions));
                        
                        console.log('å‡çº§æ„å‘å·²è®°å½•:', { email, tier, price: prices[tier] });
                    }
                    
                    // å…³é—­å¼¹çª—
                    modal.remove();
                    
                    // æ˜¾ç¤ºæ„Ÿè°¢ä¿¡æ¯
                    if (email) {
                        const thankYouMsg = isEn ?
                            'âœ… Thank you! We\'ll notify you when automatic payment is available.' :
                            'âœ… è°¢è°¢ï¼æ”¯ä»˜ç³»ç»Ÿä¸Šçº¿æ—¶æˆ‘ä»¬ä¼šé€šçŸ¥æ‚¨ã€‚';
                        
                        // ç®€å•çš„toastæç¤º
                        const toast = document.createElement('div');
                        toast.style.cssText = `
                            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                            background: linear-gradient(45deg, #DAA520, #B8860B); color: white;
                            padding: 15px 25px; border-radius: 25px; z-index: 10001;
                            font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                        `;
                        toast.textContent = thankYouMsg;
                        document.body.appendChild(toast);
                        
                        setTimeout(() => toast.remove(), 3000);
                    }
                };
                
                // å®é™…éƒ¨ç½²æ—¶å¯ä»¥æ›¿æ¢ä¸º:
                // window.location.href = `/payment?tier=${tier}&price=${prices[tier]}`;
        }

        // æ¸…ç†æ–‡æœ¬æ ¼å¼
        function cleanText(text) {
            // ç¡®ä¿è¾“å…¥æ˜¯å­—ç¬¦ä¸²
            if (typeof text !== 'string') {
                return String(text || '');
            }
            
            return text
                .replace(/^[\]ã€ã€‘\s]+/, '') // ç§»é™¤å¼€å¤´çš„ã€‘ã€ç¬¦å·
                .replace(/[\]ã€ã€‘\s]*$/, '') // ç§»é™¤ç»“å°¾çš„ã€‘ã€ç¬¦å·
                .replace(/\n\n+/g, '\n') // åˆå¹¶å¤šä¸ªæ¢è¡Œ
                .trim();
        }

        // æ ¼å¼åŒ–æ–‡æœ¬ä¸ºåˆ†æ®µæ˜¾ç¤ºï¼ˆæ·»åŠ æ¢è¡Œå’Œåˆ†æ®µï¼‰
        function formatTextWithBreaks(text) {
            if (!text || typeof text !== 'string') {
                return '';
            }
            
            let formatted = cleanText(text);
            
            // æ™ºèƒ½åˆ†æ®µå¹¶æ·»åŠ é¡¹ç›®ç¬¦å·
            const sentences = formatted
                .split(/[ï¼›;ã€‚ï¼ï¼Ÿ]/g)  // æŒ‰æ ‡ç‚¹åˆ†å‰²
                .filter(sentence => sentence.trim().length > 3)  // è¿‡æ»¤çŸ­å¥
                .map(sentence => sentence.trim())  // å»é™¤ç©ºæ ¼
                .filter(sentence => sentence);  // ç§»é™¤ç©ºå¥å­
            
            if (sentences.length > 1) {
                // å¤šå¥æ—¶ï¼Œæ¯å¥å‰åŠ é¡¹ç›®ç¬¦å·
                formatted = sentences
                    .map((sentence, index) => {
                        // é€‰æ‹©åˆé€‚çš„é¡¹ç›®ç¬¦å·
                        const bullets = ['ğŸ”¹', 'ğŸ”¸', 'â­', 'ğŸ’«', 'ğŸŒŸ'];
                        const bullet = bullets[index % bullets.length];
                        return `${bullet} ${sentence}`;
                    })
                    .join('<br><br>');
            } else {
                // å•å¥æ—¶ï¼ŒæŒ‰åˆ†å·ã€å¥å·åˆ†æ®µ
                formatted = formatted
                    .replace(/([ã€‚ï¼ï¼Ÿï¼›])\s*/g, '$1<br><br>')
                    .replace(/([ï¼š:])\s*/g, '$1<br>')
                    .replace(/(\d+[\.ã€])/g, '<br>â€¢ $1')
                    .replace(/([â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â‘©])/g, '<br>$1')
                    .replace(/^<br>/, '')
                    .trim();
            }
            
            // æ¸…ç†å¤šä½™çš„æ¢è¡Œ
            formatted = formatted
                .replace(/<br><br><br>/g, '<br><br>')
                .replace(/^<br>/, '')
                .trim();
                
            return formatted;
        }

        // ç®¡ç†é¢æ¿åŠŸèƒ½
        let adminPanelVisible = false;

        // ç›‘å¬ç‰¹æ®ŠæŒ‰é”®ç»„åˆæ‰“å¼€ç®¡ç†é¢æ¿ (Ctrl+Shift+A)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                e.preventDefault();
                toggleAdminPanel();
            }
        });

        // å…³é—­æŒ‰é’®äº‹ä»¶
        document.getElementById('close-admin').addEventListener('click', () => {
            closeAdminPanel();
        });

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        document.getElementById('admin-panel').addEventListener('click', (e) => {
            if (e.target.id === 'admin-panel') {
                closeAdminPanel();
            }
        });

        // è¿›åº¦æŒ‡ç¤ºå™¨æ§åˆ¶å‡½æ•°
        let progressInterval;
        
        function showProgressIndicator() {
            console.log('ğŸš€ æ˜¾ç¤ºè¿›åº¦æŒ‡ç¤ºå™¨');
            
            // éšè—ç»“æœåŒºåŸŸ
            document.getElementById('result-section').style.display = 'none';
            
            // æ˜¾ç¤ºè¿›åº¦å®¹å™¨
            const progressContainer = document.getElementById('progress-container');
            progressContainer.style.display = 'block';
            
            // æ»šåŠ¨åˆ°è¿›åº¦æŒ‡ç¤ºå™¨
            progressContainer.scrollIntoView({ behavior: 'smooth' });
            
            // é‡ç½®è¿›åº¦çŠ¶æ€
            resetProgressState();
            
            // å¼€å§‹è¿›åº¦åŠ¨ç”»
            startProgressAnimation();
        }
        
        function hideProgressIndicator() {
            console.log('ğŸ¯ éšè—è¿›åº¦æŒ‡ç¤ºå™¨');
            
            // åœæ­¢è¿›åº¦åŠ¨ç”»
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            
            // éšè—è¿›åº¦å®¹å™¨
            document.getElementById('progress-container').style.display = 'none';
        }
        
        function resetProgressState() {
            // é‡ç½®è¿›åº¦æ¡
            document.getElementById('progress-fill').style.width = '0%';
            
            // é‡ç½®æ‰€æœ‰æ­¥éª¤çŠ¶æ€
            document.querySelectorAll('.progress-step').forEach(step => {
                step.classList.remove('active');
            });
            
            // æ¿€æ´»ç¬¬ä¸€æ­¥
            document.getElementById('step-1').classList.add('active');
        }
        
        function startProgressAnimation() {
            const progressFill = document.getElementById('progress-fill');
            const steps = ['step-1', 'step-2', 'step-3', 'step-4'];
            const messages = [
                { zh: 'åˆ†ææˆ¿å±‹åŸºç¡€æ•°æ®...', en: 'Analyzing property data...' },
                { zh: 'è®¡ç®—æ–¹ä½å’Œæœå‘å½±å“...', en: 'Calculating orientation effects...' },
                { zh: 'è¯„ä¼°å¸ƒå±€å’Œé£æ°´æ ¼å±€...', en: 'Evaluating layout and Feng Shui patterns...' },
                { zh: 'ç”Ÿæˆä¸“ä¸šå»ºè®®æ–¹æ¡ˆ...', en: 'Generating professional recommendations...' }
            ];
            
            let currentStep = 0;
            let progress = 0;
            
            progressInterval = setInterval(() => {
                // æ›´æ–°è¿›åº¦æ¡ï¼ˆæ¨¡æ‹Ÿè¿›åº¦ï¼Œå®é™…ä¼šæ ¹æ®AIå“åº”æ—¶é—´è°ƒæ•´ï¼‰
                progress += Math.random() * 3 + 2; // æ¯æ¬¡å¢åŠ 2-5%
                if (progress > 100) progress = 100;
                
                progressFill.style.width = progress + '%';
                
                // æ›´æ–°æ­¥éª¤çŠ¶æ€ï¼ˆæ¯25%åˆ‡æ¢ä¸€æ­¥ï¼‰
                const stepIndex = Math.min(Math.floor(progress / 25), 3);
                if (stepIndex > currentStep) {
                    // ç§»é™¤å½“å‰æ­¥éª¤çš„activeçŠ¶æ€
                    if (currentStep < steps.length) {
                        document.getElementById(steps[currentStep]).classList.remove('active');
                    }
                    
                    currentStep = stepIndex;
                    
                    // æ¿€æ´»æ–°æ­¥éª¤
                    if (currentStep < steps.length) {
                        document.getElementById(steps[currentStep]).classList.add('active');
                    }
                }
                
                // æ›´æ–°æ¶ˆæ¯
                if (currentStep < messages.length) {
                    const messageEl = document.getElementById('progress-message');
                    messageEl.textContent = messages[currentStep][currentLang];
                }
                
                // å¦‚æœè¾¾åˆ°95%å°±åœæ­¢è‡ªåŠ¨å¢é•¿ï¼Œç­‰å¾…å®é™…å®Œæˆ
                if (progress >= 95) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                
            }, 200); // æ¯200msæ›´æ–°ä¸€æ¬¡
        }

        // å¯¼å‡ºåŠŸèƒ½å®ç°
        function exportToPDF() {
            console.log('ğŸ“„ å¼€å§‹å¯¼å‡ºPDF');
            
            if (!window.lastAnalysisResult) {
                alert(currentLang === 'en' ? 'No analysis result to export' : 'æ²¡æœ‰å¯å¯¼å‡ºçš„åˆ†æç»“æœ');
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®
            setExportButtonsState(true);
            
            try {
                // åŠ¨æ€åŠ è½½jsPDFåº“
                loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', () => {
                    generatePDF();
                });
            } catch (error) {
                console.error('PDFå¯¼å‡ºå¤±è´¥:', error);
                alert(currentLang === 'en' ? 'PDF export failed' : 'PDFå¯¼å‡ºå¤±è´¥');
                setExportButtonsState(false);
            }
        }
        
        function exportToImage() {
            console.log('ğŸ–¼ï¸ å¼€å§‹å¯¼å‡ºå›¾ç‰‡');
            
            if (!window.lastAnalysisResult) {
                alert(currentLang === 'en' ? 'No analysis result to export' : 'æ²¡æœ‰å¯å¯¼å‡ºçš„åˆ†æç»“æœ');
                return;
            }
            
            setExportButtonsState(true);
            
            try {
                // åŠ¨æ€åŠ è½½html2canvasåº“
                loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js', () => {
                    generateImage();
                });
            } catch (error) {
                console.error('å›¾ç‰‡å¯¼å‡ºå¤±è´¥:', error);
                alert(currentLang === 'en' ? 'Image export failed' : 'å›¾ç‰‡å¯¼å‡ºå¤±è´¥');
                setExportButtonsState(false);
            }
        }
        
        function exportToText() {
            console.log('ğŸ“ å¼€å§‹å¯¼å‡ºæ–‡æœ¬');
            
            if (!window.lastAnalysisResult) {
                alert(currentLang === 'en' ? 'No analysis result to export' : 'æ²¡æœ‰å¯å¯¼å‡ºçš„åˆ†æç»“æœ');
                return;
            }
            
            const result = window.lastAnalysisResult;
            const timestamp = new Date().toLocaleString(currentLang === 'en' ? 'en-US' : 'zh-CN');
            
            let textContent = '';
            
            if (currentLang === 'en') {
                textContent = `AI Feng Shui Analysis Report
Generated on: ${timestamp}

=== OVERALL SCORE ===
${result.score || 'N/A'} Points - ${result.gradeInfo?.name || 'Analysis Complete'}

=== ORIENTATION ANALYSIS ===
${getPlainText(getDirectionInfo(result))}

=== LAYOUT SUGGESTIONS ===
${getPlainText(getLayoutInfo(result))}

=== IMMEDIATE IMPROVEMENTS ===
${getPlainText(getActionInfo(result))}

=== IMPORTANT NOTES ===
${getPlainText(getNotesInfo(result))}

---
Generated by AI Feng Shui Master
This analysis incorporates dynamic factors and should be used as reference only.`;
            } else {
                textContent = `AIé£æ°´åˆ†ææŠ¥å‘Š
ç”Ÿæˆæ—¶é—´ï¼š${timestamp}

=== ç»¼åˆè¯„åˆ† ===
${result.score || 'æ— '}åˆ† - ${result.gradeInfo?.name || 'åˆ†æå®Œæˆ'}

=== æœå‘åˆ†æ ===
${getPlainText(getDirectionInfo(result))}

=== å¸ƒå±€å»ºè®® ===
${getPlainText(getLayoutInfo(result))}

=== ç«‹å³æ”¹å–„å»ºè®® ===
${getPlainText(getActionInfo(result))}

=== é‡è¦æé†’ ===
${getPlainText(getNotesInfo(result))}

---
ç”±AIé£æ°´å¤§å¸ˆç”Ÿæˆ
æ­¤åˆ†æç»“åˆåŠ¨æ€å› ç´ ï¼Œä»…ä¾›å‚è€ƒä½¿ç”¨ã€‚`;
            }
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `é£æ°´åˆ†ææŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            console.log('âœ… æ–‡æœ¬å¯¼å‡ºå®Œæˆ');
        }
        
        function shareResult() {
            console.log('ğŸ”— å¼€å§‹åˆ†äº«ç»“æœ');
            
            if (!window.lastAnalysisResult) {
                alert(currentLang === 'en' ? 'No analysis result to share' : 'æ²¡æœ‰å¯åˆ†äº«çš„åˆ†æç»“æœ');
                return;
            }
            
            const result = window.lastAnalysisResult;
            const shareText = currentLang === 'en' ? 
                `My Feng Shui Analysis Result: ${result.score || 'N/A'} Points - ${result.gradeInfo?.name || 'Analysis Complete'}` :
                `æˆ‘çš„é£æ°´åˆ†æç»“æœï¼š${result.score || 'æ— '}åˆ† - ${result.gradeInfo?.name || 'åˆ†æå®Œæˆ'}`;
            
            const shareUrl = window.location.href;
            
            if (navigator.share) {
                // ä½¿ç”¨Web Share APIï¼ˆç§»åŠ¨ç«¯ï¼‰
                navigator.share({
                    title: currentLang === 'en' ? 'AI Feng Shui Analysis' : 'AIé£æ°´åˆ†æç»“æœ',
                    text: shareText,
                    url: shareUrl
                }).then(() => {
                    console.log('âœ… åˆ†äº«æˆåŠŸ');
                }).catch((error) => {
                    console.log('åˆ†äº«è¢«å–æ¶ˆæˆ–å¤±è´¥:', error);
                    fallbackShare(shareText, shareUrl);
                });
            } else {
                fallbackShare(shareText, shareUrl);
            }
        }
        
        // è¾…åŠ©å‡½æ•°
        function setExportButtonsState(disabled) {
            document.querySelectorAll('.export-btn').forEach(btn => {
                btn.disabled = disabled;
                if (disabled) {
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                } else {
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
        }
        
        function loadScript(src, callback) {
            if (document.querySelector(`script[src="${src}"]`)) {
                callback();
                return;
            }
            
            const script = document.createElement('script');
            script.src = src;
            script.onload = callback;
            script.onerror = () => {
                throw new Error(`Failed to load script: ${src}`);
            };
            document.head.appendChild(script);
        }
        
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // è®¾ç½®ä¸­æ–‡å­—ä½“æ”¯æŒ
            doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
            doc.setFont('Roboto');
            
            const result = window.lastAnalysisResult;
            const timestamp = new Date().toLocaleString(currentLang === 'en' ? 'en-US' : 'zh-CN');
            
            let yPos = 20;
            const lineHeight = 7;
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;
            const maxWidth = pageWidth - 2 * margin;
            
            // æ ‡é¢˜
            doc.setFontSize(18);
            const title = currentLang === 'en' ? 'AI Feng Shui Analysis Report' : 'AIé£æ°´åˆ†ææŠ¥å‘Š';
            doc.text(title, pageWidth / 2, yPos, { align: 'center' });
            yPos += lineHeight * 2;
            
            // ç”Ÿæˆæ—¶é—´
            doc.setFontSize(10);
            const timeText = (currentLang === 'en' ? 'Generated on: ' : 'ç”Ÿæˆæ—¶é—´ï¼š') + timestamp;
            doc.text(timeText, pageWidth / 2, yPos, { align: 'center' });
            yPos += lineHeight * 2;
            
            // è¯„åˆ†
            doc.setFontSize(14);
            const scoreTitle = currentLang === 'en' ? 'OVERALL SCORE' : 'ç»¼åˆè¯„åˆ†';
            doc.text(scoreTitle, margin, yPos);
            yPos += lineHeight;
            
            doc.setFontSize(12);
            const scoreText = `${result.score || 'N/A'} ${currentLang === 'en' ? 'Points' : 'åˆ†'} - ${result.gradeInfo?.name || (currentLang === 'en' ? 'Analysis Complete' : 'åˆ†æå®Œæˆ')}`;
            doc.text(scoreText, margin, yPos);
            yPos += lineHeight * 2;
            
            // å…¶ä»–sections...ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…ä¼šåŒ…å«æ‰€æœ‰å†…å®¹ï¼‰
            const sections = [
                { title: currentLang === 'en' ? 'ORIENTATION ANALYSIS' : 'æœå‘åˆ†æ', content: getPlainText(getDirectionInfo(result)) },
                { title: currentLang === 'en' ? 'LAYOUT SUGGESTIONS' : 'å¸ƒå±€å»ºè®®', content: getPlainText(getLayoutInfo(result)) },
                { title: currentLang === 'en' ? 'IMMEDIATE IMPROVEMENTS' : 'ç«‹å³æ”¹å–„å»ºè®®', content: getPlainText(getActionInfo(result)) }
            ];
            
            sections.forEach(section => {
                doc.setFontSize(14);
                doc.text(section.title, margin, yPos);
                yPos += lineHeight;
                
                doc.setFontSize(10);
                const lines = doc.splitTextToSize(section.content.substring(0, 500) + '...', maxWidth);
                lines.forEach(line => {
                    if (yPos > 270) { // æ¥è¿‘é¡µé¢åº•éƒ¨æ—¶æ¢é¡µ
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(line, margin, yPos);
                    yPos += lineHeight;
                });
                yPos += lineHeight;
            });
            
            // ä¿å­˜PDF
            const filename = `é£æ°´åˆ†ææŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
            
            setExportButtonsState(false);
            console.log('âœ… PDFå¯¼å‡ºå®Œæˆ');
        }
        
        function generateImage() {
            // è·å–æ•´ä¸ªç»“æœåŒºåŸŸï¼Œè€Œä¸ä»…ä»…æ˜¯å†…å®¹åŒºåŸŸ
            const resultSection = document.getElementById('result-section');
            
            // ä¸´æ—¶éšè—å¯¼å‡ºæŒ‰é’®ä»¥é¿å…åœ¨å›¾ç‰‡ä¸­æ˜¾ç¤º
            const exportControls = document.getElementById('export-controls');
            const originalDisplay = exportControls.style.display;
            exportControls.style.display = 'none';
            
            // ç¡®ä¿æ‰€æœ‰å†…å®¹å¯è§
            const originalMaxHeight = resultSection.style.maxHeight;
            resultSection.style.maxHeight = 'none';
            
            html2canvas(resultSection, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#0F1419', // ä½¿ç”¨ç½‘ç«™çš„èƒŒæ™¯è‰²
                width: resultSection.scrollWidth,
                height: resultSection.scrollHeight,
                scrollX: 0,
                scrollY: 0,
                allowTaint: true,
                foreignObjectRendering: true
            }).then(canvas => {
                // æ¢å¤å¯¼å‡ºæŒ‰é’®æ˜¾ç¤º
                exportControls.style.display = originalDisplay;
                resultSection.style.maxHeight = originalMaxHeight;
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.download = `AIé£æ°´åˆ†ææŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setExportButtonsState(false);
                console.log('âœ… å›¾ç‰‡å¯¼å‡ºå®Œæˆ');
            }).catch(error => {
                // æ¢å¤æ˜¾ç¤ºçŠ¶æ€
                exportControls.style.display = originalDisplay;
                resultSection.style.maxHeight = originalMaxHeight;
                
                console.error('å›¾ç‰‡ç”Ÿæˆå¤±è´¥:', error);
                alert(currentLang === 'en' ? 'Image generation failed. Please try PDF export instead.' : 'å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œè¯·å°è¯•PDFå¯¼å‡º');
                setExportButtonsState(false);
            });
        }
        
        function fallbackShare(text, url) {
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            if (navigator.clipboard) {
                const shareContent = `${text}\n${url}`;
                navigator.clipboard.writeText(shareContent).then(() => {
                    alert(currentLang === 'en' ? 'Content copied to clipboard!' : 'å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }).catch(() => {
                    showShareModal(text, url);
                });
            } else {
                showShareModal(text, url);
            }
        }
        
        function showShareModal(text, url) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10001; 
                display: flex; align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: var(--bg-card); padding: 30px; border-radius: 12px; 
                max-width: 500px; width: 90%; text-align: center;
            `;
            
            content.innerHTML = `
                <h3 style="color: var(--primary-gold); margin-bottom: 20px;">
                    ${currentLang === 'en' ? 'Share Analysis Result' : 'åˆ†äº«åˆ†æç»“æœ'}
                </h3>
                <textarea readonly style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: none;">${text}\n${url}</textarea>
                <div style="margin-top: 20px;">
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                            style="background: var(--primary-gold); color: var(--bg-primary); border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                        ${currentLang === 'en' ? 'Close' : 'å…³é—­'}
                    </button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // é€‰ä¸­æ–‡æœ¬
            const textarea = content.querySelector('textarea');
            textarea.select();
        }
        
        function getPlainText(htmlText) {
            const div = document.createElement('div');
            div.innerHTML = htmlText;
            return div.textContent || div.innerText || '';
        }

        function toggleAdminPanel() {
            if (adminPanelVisible) {
                closeAdminPanel();
            } else {
                openAdminPanel();
            }
        }

        function openAdminPanel() {
            adminPanelVisible = true;
            document.getElementById('admin-panel').style.display = 'block';
            document.body.style.overflow = 'hidden';
            loadAdminData();
        }

        function closeAdminPanel() {
            adminPanelVisible = false;
            document.getElementById('admin-panel').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        async function loadAdminData() {
            try {
                // å¹¶è¡Œè·å–å¤šä¸ªæ•°æ®æº
                const [systemStats, aiStats, analytics, parsingStats] = await Promise.all([
                    fetch('/api/system-stats').then(r => r.json()),
                    fetch('/api/ai-stats').then(r => r.json()),
                    fetch('/api/analytics').then(r => r.json()),
                    fetch('/api/parsing-stats').then(r => r.json())
                ]);

                updateTodayStats(analytics.data);
                updateAIPerformance(aiStats.data, parsingStats.data);
                updateUserDistribution(analytics.data);
                updateSystemHealth(systemStats.data);
                updateAIComparison(aiStats.data);
                updateUsageTrends(analytics.data);
                updateRecentFeedback(analytics.data.feedback);

            } catch (error) {
                console.error('åŠ è½½ç®¡ç†æ•°æ®å¤±è´¥:', error);
                showErrorState();
            }
        }

        function updateTodayStats(data) {
            const todayStats = document.getElementById('today-stats');
            todayStats.innerHTML = `
                <div class="stat-item">
                    <span>æ€»åˆ†ææ¬¡æ•°</span>
                    <span class="stat-value">${data.today.totalAnalyses || 0}</span>
                </div>
                <div class="stat-item">
                    <span>ç‹¬ç«‹ç”¨æˆ·</span>
                    <span class="stat-value">${data.today.uniqueUsers || 0}</span>
                </div>
                <div class="stat-item">
                    <span>å›¾ç‰‡ä¸Šä¼ </span>
                    <span class="stat-value">${data.today.uploadTypes.withImage || 0}</span>
                </div>
                <div class="stat-item">
                    <span>çº¯æ–‡æœ¬åˆ†æ</span>
                    <span class="stat-value">${data.today.uploadTypes.textOnly || 0}</span>
                </div>
            `;
        }

        function updateAIPerformance(data, parsingData) {
            const aiPerf = document.getElementById('ai-performance');
            const deepseekRate = data.deepseek.calls > 0 ? ((data.deepseek.calls - data.deepseek.errors) / data.deepseek.calls * 100) : 0;
            const qwen3Rate = data.qwen3.calls > 0 ? ((data.qwen3.calls - data.qwen3.errors) / data.qwen3.calls * 100) : 0;

            aiPerf.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>DeepSeekæˆåŠŸç‡</span>
                        <span class="stat-value">${deepseekRate.toFixed(1)}%</span>
                    </div>
                    <div class="performance-bar">
                        <div class="performance-fill" style="width: ${deepseekRate}%"></div>
                    </div>
                </div>
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Qwen3æˆåŠŸç‡</span>
                        <span class="stat-value">${qwen3Rate.toFixed(1)}%</span>
                    </div>
                    <div class="performance-bar">
                        <div class="performance-fill" style="width: ${qwen3Rate}%"></div>
                    </div>
                </div>
                ${parsingData ? `
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>è§£ææˆåŠŸç‡</span>
                        <span class="stat-value">${parsingData.successRate}%</span>
                    </div>
                    <div class="performance-bar">
                        <div class="performance-fill" style="width: ${parsingData.successRate}%"></div>
                    </div>
                </div>
                <div class="stat-item">
                    <span>æ ‡è®°è§£æç‡</span>
                    <span class="stat-value">${parsingData.markupSuccessRate}%</span>
                </div>
                ` : ''}
            `;
        }

        function updateUserDistribution(data) {
            const userDist = document.getElementById('user-distribution');
            const regions = data.today.userRegions || {};
            let content = '';

            Object.entries(regions).forEach(([region, count]) => {
                content += `
                    <div class="stat-item">
                        <span>${region || 'æœªçŸ¥'}</span>
                        <span class="stat-value">${count}</span>
                    </div>
                `;
            });

            userDist.innerHTML = content || '<div style="color: #666;">æš‚æ— æ•°æ®</div>';
        }

        function updateSystemHealth(data) {
            const health = document.getElementById('system-health');
            const uptime = Math.floor(data.server.uptime / 3600);
            const memoryUsed = Math.round(data.server.memory.heapUsed / 1024 / 1024);

            health.innerHTML = `
                <div class="stat-item">
                    <span>è¿è¡Œæ—¶é—´</span>
                    <span class="stat-value">${uptime}å°æ—¶</span>
                </div>
                <div class="stat-item">
                    <span>å†…å­˜ä½¿ç”¨</span>
                    <span class="stat-value">${memoryUsed}MB</span>
                </div>
                <div class="stat-item">
                    <span>AIçŠ¶æ€</span>
                    <span class="stat-value" style="color: #44ff44;">âœ“ æ­£å¸¸</span>
                </div>
            `;
        }

        function updateAIComparison(data) {
            const comparison = document.getElementById('ai-comparison-table');
            comparison.innerHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="text-align: left; padding: 8px;">æ¨¡å‹</th>
                            <th style="text-align: right; padding: 8px;">è°ƒç”¨æ•°</th>
                            <th style="text-align: right; padding: 8px;">é”™è¯¯æ•°</th>
                            <th style="text-align: right; padding: 8px;">å¹³å‡æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 8px;">DeepSeek</td>
                            <td style="padding: 8px; text-align: right;">${data.deepseek.calls}</td>
                            <td style="padding: 8px; text-align: right;">${data.deepseek.errors}</td>
                            <td style="padding: 8px; text-align: right;">${data.deepseek.avgTime.toFixed(1)}s</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;">Qwen3</td>
                            <td style="padding: 8px; text-align: right;">${data.qwen3.calls}</td>
                            <td style="padding: 8px; text-align: right;">${data.qwen3.errors}</td>
                            <td style="padding: 8px; text-align: right;">${data.qwen3.avgTime.toFixed(1)}s</td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        function updateUsageTrends(data) {
            const trends = document.getElementById('usage-trends');
            const totalShares = data.sharing?.totalShares || 0;
            const avgRating = data.feedback?.averageRating || 0;

            trends.innerHTML = `
                <div class="stat-item">
                    <span>å¹³å‡è¯„åˆ†</span>
                    <span class="stat-value">${avgRating}â­</span>
                </div>
                <div class="stat-item">
                    <span>åˆ†äº«æ¬¡æ•°</span>
                    <span class="stat-value">${totalShares}</span>
                </div>
                <div class="stat-item">
                    <span>æ€»åé¦ˆæ•°</span>
                    <span class="stat-value">${data.feedback?.total || 0}</span>
                </div>
            `;
        }

        function updateRecentFeedback(feedbackData) {
            const feedback = document.getElementById('recent-feedback');
            const recent = feedbackData.recent || [];

            if (recent.length === 0) {
                feedback.innerHTML = '<div style="color: #666;">æš‚æ— åé¦ˆ</div>';
                return;
            }

            let content = '';
            recent.forEach(item => {
                const stars = 'â­'.repeat(item.rating || 0);
                const time = new Date(item.timestamp).toLocaleString('zh-CN');
                content += `
                    <div style="border-bottom: 1px solid var(--border-color); padding: 10px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>${stars}</span>
                            <span style="color: #666; font-size: 0.8rem;">${time}</span>
                        </div>
                        <div style="color: #ccc;">${item.comment || 'æ— è¯„è®º'}</div>
                    </div>
                `;
            });

            feedback.innerHTML = content;
        }

        function showErrorState() {
            document.querySelectorAll('#admin-panel [id$="-stats"], #admin-panel [id$="-performance"], #admin-panel [id$="-distribution"], #admin-panel [id$="-health"]').forEach(el => {
                el.innerHTML = '<div style="color: #ff4444;">âŒ æ•°æ®åŠ è½½å¤±è´¥</div>';
            });
        }
    </script>
</body>
</html>