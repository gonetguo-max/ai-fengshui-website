<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO‰ºòÂåñÔºöÂÖ®ÁêÉ‰∏ì‰∏öÊúçÂä° -->
    <title id="page-title">AI Feng Shui Master | Premium Analysis & Consultation | Êô∫ËÉΩÈ£éÊ∞¥Â§ßÂ∏à</title>
    <meta name="description" content="Professional AI-powered Feng Shui analysis for luxury homes worldwide. Expert consultation starting from $3.99. ‰∏ì‰∏öAIÈ£éÊ∞¥ÂàÜÊûêÊúçÂä°ÔºåÂÖ®ÁêÉÂ•¢Âçé‰ΩèÂÆÖÂ∏ÉÂ±Ä‰ºòÂåñ„ÄÇ">
    <meta name="keywords" content="AI feng shui master, feng shui consultant, luxury home feng shui, premium feng shui consultation, È£éÊ∞¥Â§ßÂ∏à, È£éÊ∞¥ÂàÜÊûê, Êµ∑Â§ñÈ£éÊ∞¥Â∏à, feng shui analysis worldwide">
    
    <!-- Âú∞ÁêÜ‰ΩçÁΩÆSEO -->
    <meta name="geo.region" content="US-CA, US-NY, US-TX, CA-ON, CA-BC">
    <meta name="geo.placename" content="North America">
    
    <!-- ËØ≠Ë®ÄÊîØÊåÅ -->
    <link rel="alternate" hreflang="en" href="?lang=en" id="hreflang-en">
    <link rel="alternate" hreflang="zh" href="?lang=zh" id="hreflang-zh">
    <link rel="alternate" hreflang="x-default" href="?lang=en" id="hreflang-default">
    
    <!-- Open GraphÁ§æ‰∫§Â™í‰Ωì‰ºòÂåñ -->
    <meta property="og:title" content="AI Feng Shui Analysis | Premium Consultation">
    <meta property="og:description" content="Professional AI-powered Feng Shui analysis for luxury homes. Expert consultation starting from $3.99.">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="en_US">
    <meta property="og:locale:alternate" content="zh_CN">
    
    <!-- TwitterÂç°Áâá -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="AI Feng Shui Analysis | Premium Consultation">
    <meta name="twitter:description" content="Professional AI-powered Feng Shui analysis for luxury homes.">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèÆ</text></svg>">
    <link rel="stylesheet" href="v0-style-enhanced.css">
    
    <!-- ÁªìÊûÑÂåñÊï∞ÊçÆ JSON-LD -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "Organization",
          "name": "AI Feng Shui Analysis",
          "alternateName": "Êô∫ËÉΩÈ£éÊ∞¥Â§ßÂ∏à",
          "description": "Professional AI-powered Feng Shui consultation service for luxury homes worldwide",
          "url": "https://aifengshui.com",
          "logo": "https://aifengshui.com/logo.png",
          "serviceArea": {
            "@type": "GeoCircle",
            "geoMidpoint": {
              "@type": "GeoCoordinates",
              "latitude": 40.7128,
              "longitude": -74.0060
            },
            "geoRadius": "5000000"
          }
        },
        {
          "@type": "Service",
          "name": "AI Feng Shui Analysis",
          "description": "Professional AI-powered Feng Shui analysis for luxury homes and offices worldwide",
          "provider": {
            "@type": "Organization",
            "name": "AI Feng Shui Analysis"
          },
          "serviceType": "Feng Shui Consultation",
          "category": "Home & Garden Services",
          "hasOfferCatalog": {
            "@type": "OfferCatalog",
            "name": "Feng Shui Analysis Plans",
            "itemListElement": [
              {
                "@type": "Offer",
                "itemOffered": {
                  "@type": "Service",
                  "name": "Basic Feng Shui Analysis",
                  "description": "Complete directional analysis with basic recommendations"
                },
                "price": "3.99",
                "priceCurrency": "USD",
                "availability": "https://schema.org/InStock"
              },
              {
                "@type": "Offer",
                "itemOffered": {
                  "@type": "Service", 
                  "name": "Professional Feng Shui Analysis",
                  "description": "Detailed layout suggestions and professional improvement advice"
                },
                "price": "4.99",
                "priceCurrency": "USD", 
                "availability": "https://schema.org/InStock"
              },
              {
                "@type": "Offer",
                "itemOffered": {
                  "@type": "Service",
                  "name": "Master Feng Shui Consultation", 
                  "description": "Professional feng shui reminders and personalized customization"
                },
                "price": "29.99",
                "priceCurrency": "USD",
                "availability": "https://schema.org/InStock"
              }
            ]
          },
          "areaServed": [
            {
              "@type": "Country",
              "name": "United States"
            },
            {
              "@type": "Country", 
              "name": "Canada"
            }
          ]
        },
        {
          "@type": "WebSite",
          "url": "https://aifengshui.com",
          "name": "AI Feng Shui Analysis",
          "description": "Professional AI-powered Feng Shui consultation for luxury homes worldwide",
          "inLanguage": ["en", "zh-CN"],
          "potentialAction": {
            "@type": "SearchAction",
            "target": "https://aifengshui.com/?q={search_term_string}",
            "query-input": "required name=search_term_string"
          }
        }
      ]
    }
    </script>
    <style>
        /* ===== Áé∞‰ª£È£éÊ∞¥‰∏ì‰∏öÈ£éÊ†º - Âü∫‰∫év0.devËÆæËÆ°ÁêÜÂøµ ===== */
        
        /* üé® Âü∫Á°ÄÂ≠ó‰Ωì‰∏éÈ¢úËâ≤Á≥ªÁªü */
        :root {
            --primary-gold: #DAA520;
            --primary-gold-light: #F4E4A6;
            --primary-gold-dark: #B8860B;
            
            --bg-primary: #0F1419;
            --bg-secondary: #1A1F2E;
            --bg-card: #212936;
            --bg-input: #2A3441;
            
            --text-primary: #E2E8F0;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;
        }

        /* ÂÖ®Â±ÄÈáçÁΩÆ‰∏éÂü∫Á°ÄÊ†∑Âºè */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Microsoft YaHei', 'ÂæÆËΩØÈõÖÈªë', sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-primary);
        }

        /* È°µÈù¢Âä†ËΩΩÂä®Áîª */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loader-content {
            text-align: center;
        }

        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(218, 165, 32, 0.2);
            border-top: 3px solid var(--primary-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loader-text {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .hero-section {
            text-align: center;
            padding: 60px 0;
        }

        .hero-title {
            font-size: 2.5rem;
            color: var(--primary-gold);
            margin-bottom: 20px;
        }

        .hero-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 40px;
        }

        /* Ë°®ÂçïÊ†∑Âºè */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-gold);
            font-weight: 600;
            font-size: 1rem;
        }

        .form-help {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(218, 165, 32, 0.1);
            border-radius: 4px;
            border-left: 3px solid var(--primary-gold);
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--primary-gold);
            border-radius: 6px;
            color: var(--text-primary);
        }

        /* ÊåâÈíÆÊ†∑Âºè */
        .btn {
            padding: 12px 24px;
            background: var(--primary-gold);
            color: var(--bg-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }

        .btn:hover {
            background: var(--primary-gold-light);
        }

        /* Êñá‰ª∂‰∏ä‰º†Ê†∑Âºè */
        .file-upload-area {
            border: 2px dashed var(--primary-gold);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(218, 165, 32, 0.05);
        }

        .file-upload-area:hover {
            background: rgba(218, 165, 32, 0.1);
            border-color: var(--primary-gold-light);
        }

        .upload-placeholder {
            color: var(--text-secondary);
        }

        .upload-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .file-preview {
            position: relative;
            display: inline-block;
        }

        .remove-file-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-file-btn:hover {
            background: #ff3742;
        }

        /* ËØ≠Ë®ÄÂàáÊç¢Ê†∑Âºè */
        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
        }

        .lang-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--primary-gold);
            color: var(--primary-gold);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .lang-btn:hover,
        .lang-btn.active {
            background: var(--primary-gold);
            color: var(--bg-primary);
        }

        /* ÁßªÂä®Á´ØÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                max-width: 100%;
            }

            .hero-section {
                padding: 40px 20px;
                text-align: center;
            }

            .hero-title {
                font-size: 2rem;
            }

            .hero-subtitle {
                font-size: 1rem;
                margin-top: 10px;
            }

            /* Ë°®ÂçïÂ∏ÉÂ±Ä‰ºòÂåñ */
            .form-section {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            /* ÊåâÈíÆ‰ºòÂåñ */
            .analyze-button {
                padding: 16px 24px;
                font-size: 1.1rem;
                width: 100%;
                margin-top: 20px;
            }

            /* ËØ≠Ë®ÄÂàáÊç¢ÊåâÈíÆ */
            .language-switcher {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
                text-align: center;
            }

            .lang-btn {
                padding: 12px 20px;
                font-size: 1rem;
                margin: 0 5px;
            }

            /* Êñá‰ª∂‰∏ä‰º†Âå∫Âüü */
            .file-upload-area {
                padding: 30px 15px;
                min-height: 120px;
            }

            .upload-placeholder {
                font-size: 0.9rem;
            }

            .file-preview img {
                max-width: 150px;
                max-height: 150px;
            }

            /* Ë°®ÂçïËæìÂÖ•Ê°Ü */
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 14px;
                font-size: 1rem;
            }

            .form-group label {
                font-size: 0.95rem;
                margin-bottom: 8px;
            }

            /* ÁªìÊûúÊòæÁ§∫‰ºòÂåñ */
            #result-section {
                margin-top: 30px;
            }

            #result-content {
                padding: 15px;
                font-size: 0.95rem;
                line-height: 1.6;
            }

            .result-block {
                margin-bottom: 20px;
            }

            .result-block h3 {
                font-size: 1.1rem;
                margin-bottom: 10px;
            }

            /* ÁÆ°ÁêÜÈù¢ÊùøÁßªÂä®Á´ØÈÄÇÈÖç */
            #admin-panel > div {
                width: 95%;
                margin: 10px auto;
                padding: 15px;
                max-height: 95vh;
            }

            #admin-panel .stat-card {
                padding: 12px;
            }

            #admin-panel h2 {
                font-size: 1.2rem;
            }

            #admin-panel h3 {
                font-size: 1rem;
            }

            /* ÁΩëÊ†ºÂ∏ÉÂ±ÄË∞ÉÊï¥ */
            #admin-panel > div > div:first-of-type {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            #admin-panel > div > div:nth-of-type(2) {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            /* ËøõÂ∫¶ÊåáÁ§∫Âô®ÁßªÂä®Á´Ø‰ºòÂåñ */
            .progress-card {
                padding: 20px;
                margin: 0 10px;
            }
            
            .progress-steps {
                gap: 5px;
            }
            
            .step-icon {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            .step-text {
                font-size: 0.75rem;
            }
            
            .progress-message {
                font-size: 0.85rem;
            }
        }

        /* ËøõÂ∫¶ÊåáÁ§∫Âô®Ê†∑Âºè */
        .progress-card {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid rgba(218, 165, 32, 0.2);
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(218, 165, 32, 0.2);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-gold) 0%, #ffcc00 100%);
            border-radius: 4px;
            width: 0%;
            transition: width 0.8s ease;
            animation: progressShimmer 2s infinite;
        }

        @keyframes progressShimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin: 25px 0;
            gap: 10px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            opacity: 0.5;
            transition: all 0.5s ease;
        }

        .progress-step.active {
            opacity: 1;
            transform: scale(1.05);
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(218, 165, 32, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .progress-step.active .step-icon {
            background: var(--primary-gold);
            color: var(--bg-primary);
            animation: pulseIcon 1.5s infinite;
        }

        @keyframes pulseIcon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .step-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .progress-step.active .step-text {
            color: var(--primary-gold);
            font-weight: 600;
        }

        .progress-message {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 20px;
            line-height: 1.5;
            animation: fadeInOut 2s infinite alternate;
        }

        @keyframes fadeInOut {
            0% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* ËØ≠Ë®ÄÂàáÊç¢ÊåâÈíÆÊ†∑Âºè */
        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }

        .lang-btn {
            padding: 8px 16px;
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid rgba(218, 165, 32, 0.3);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .lang-btn:hover {
            background: rgba(218, 165, 32, 0.1);
            color: var(--text-primary);
            border-color: var(--primary-gold);
        }

        .lang-btn.active {
            background: var(--primary-gold);
            color: var(--bg-primary);
            border-color: var(--primary-gold);
            font-weight: bold;
        }

        /* ÂØºÂá∫ÊåâÈíÆÊ†∑Âºè */
        .export-btn {
            background: linear-gradient(135deg, var(--primary-gold), #ffcc00);
            color: var(--bg-primary);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(218, 165, 32, 0.3);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #ffcc00, var(--primary-gold));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(218, 165, 32, 0.4);
        }

        .export-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(218, 165, 32, 0.3);
        }

        .export-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* ÂØºÂá∫ÊéßÂà∂Èù¢ÊùøÂìçÂ∫îÂºè */
        @media (max-width: 768px) {
            #export-controls {
                flex-wrap: wrap;
                justify-content: center;
                width: 100%;
                margin-top: 10px;
            }
            
            .export-btn {
                font-size: 0.75rem;
                padding: 6px 10px;
                flex: 1;
                min-width: 70px;
                justify-content: center;
            }
        }

        /* Â∞èÂ±èÂπïËÆæÂ§á (ÊâãÊú∫Á´ñÂ±è) */
        @media (max-width: 480px) {
            .hero-title {
                font-size: 1.8rem;
            }

            .hero-subtitle {
                font-size: 0.9rem;
            }

            .form-section {
                padding: 15px;
            }

            .analyze-button {
                padding: 18px 20px;
                font-size: 1.2rem;
            }

            .lang-btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            /* Êõ¥Á¥ßÂáëÁöÑÈó¥Ë∑ù */
            .form-group {
                margin-bottom: 15px;
            }

            .file-upload-area {
                padding: 20px 10px;
                min-height: 100px;
            }

            .upload-placeholder {
                font-size: 0.85rem;
            }

            /* ÁªìÊûúÊòæÁ§∫Êõ¥Á¥ßÂáë */
            #result-content {
                padding: 12px;
                font-size: 0.9rem;
            }

            .result-block h3 {
                font-size: 1rem;
            }
        }

        /* Ê®™Â±èÂπ≥ÊùøÈÄÇÈÖç */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 900px;
            }

            .form-grid {
                grid-template-columns: 1fr 1fr;
            }

            .hero-title {
                font-size: 2.5rem;
            }
        }

        /* Ëß¶Êë∏ËÆæÂ§á‰ºòÂåñ */
        @media (hover: none) and (pointer: coarse) {
            .analyze-button,
            .lang-btn,
            .remove-file-btn {
                min-height: 44px;
                min-width: 44px;
            }

            .file-upload-area {
                min-height: 140px;
            }

            /* Â¢ûÂä†ÁÇπÂáªÂå∫Âüü */
            .form-group input,
            .form-group select {
                min-height: 44px;
            }
        }
    </style>
</head>
<body>
    <!-- È°µÈù¢Âä†ËΩΩÂä®Áîª -->
    <div class="page-loader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <div class="loader-text">Ê≠£Âú®Âä†ËΩΩAIÈ£éÊ∞¥Â§ßÂ∏à...</div>
        </div>
    </div>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπ -->
    <div class="container">
        <!-- ËØ≠Ë®ÄÂàáÊç¢ÊåâÈíÆ -->
        <div class="language-switcher">
            <button class="lang-btn active" id="lang-zh" data-lang="zh">‰∏≠Êñá</button>
            <button class="lang-btn" id="lang-en" data-lang="en">English</button>
        </div>

        <section class="hero-section">
            <h1 class="hero-title" data-i18n="title">AIÈ£éÊ∞¥Â§ßÂ∏à</h1>
            <p class="hero-subtitle" data-i18n="subtitle">Êô∫ËÉΩÂàÜÊûêÊÇ®ÁöÑÂ±ÖÂÆ∂ÁéØÂ¢ÉÔºåÊèê‰æõ‰∏ì‰∏öÈ£éÊ∞¥Âª∫ËÆÆ</p>
        </section>

        <form id="fengshui-form">
            <div class="form-group">
                <label class="form-label" for="house-type" data-i18n="houseType">ÊàøÂ±ãÁ±ªÂûã</label>
                <select class="form-select" id="house-type">
                    <option value="" data-i18n="selectHouseType">ËØ∑ÈÄâÊã©ÊàøÂ±ãÁ±ªÂûã</option>
                    <option value="residential" data-i18n="residential">‰ΩèÂÆÖ</option>
                    <option value="office" data-i18n="office">ÂäûÂÖ¨ÂÆ§</option>
                    <option value="shop" data-i18n="shop">ÂïÜÈì∫</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="direction" data-i18n="direction">ÊàøÂ±ãÊúùÂêë</label>
                <p class="form-help" data-i18n="directionHelp">üí° ËØ¥ÊòéÔºöËØ∑ÈÄâÊã©ÂÖ•Êà∑Èó®Èù¢ÂØπÁöÑÊñπÂêëÔºàÂç≥Á´ôÂú®Èó®ÂÜÖÂêëÂ§ñÁúãÁöÑÊñπÂêëÔºâ</p>
                <select class="form-select" id="direction" required>
                    <option value="" data-i18n="selectDirection">ËØ∑ÈÄâÊã©ÂÖ•Êà∑Èó®ÊúùÂêë</option>
                    <option value="north" data-i18n="north">ÂåóÔºàÂÖ•Êà∑Èó®Èù¢ÂêëÂåóÊñπÔºâ</option>
                    <option value="south" data-i18n="south">ÂçóÔºàÂÖ•Êà∑Èó®Èù¢ÂêëÂçóÊñπÔºâ</option>
                    <option value="east" data-i18n="east">‰∏úÔºàÂÖ•Êà∑Èó®Èù¢Âêë‰∏úÊñπÔºâ</option>
                    <option value="west" data-i18n="west">Ë•øÔºàÂÖ•Êà∑Èó®Èù¢ÂêëË•øÊñπÔºâ</option>
                    <option value="northeast" data-i18n="northeast">‰∏úÂåóÔºàÂÖ•Êà∑Èó®Èù¢Âêë‰∏úÂåóÊñπÔºâ</option>
                    <option value="northwest" data-i18n="northwest">Ë•øÂåóÔºàÂÖ•Êà∑Èó®Èù¢ÂêëË•øÂåóÊñπÔºâ</option>
                    <option value="southeast" data-i18n="southeast">‰∏úÂçóÔºàÂÖ•Êà∑Èó®Èù¢Âêë‰∏úÂçóÊñπÔºâ</option>
                    <option value="southwest" data-i18n="southwest">Ë•øÂçóÔºàÂÖ•Êà∑Èó®Èù¢ÂêëË•øÂçóÊñπÔºâ</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="area" data-i18n="area">Èù¢ÁßØÔºàÂπ≥ÊñπÁ±≥Ôºâ</label>
                <input type="number" class="form-input" id="area" placeholder="" data-i18n-placeholder="areaPlaceholder" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="floor-level" data-i18n="floorLevel">ÊâÄÂú®Ê•ºÂ±Ç</label>
                <select class="form-select" id="floor-level">
                    <option value="" data-i18n="selectFloor">ËØ∑ÈÄâÊã©Ê•ºÂ±ÇÔºàÂèØÈÄâÔºâ</option>
                    <option value="1" data-i18n="floor1">1Ê•º</option>
                    <option value="2" data-i18n="floor2">2Ê•º</option>
                    <option value="3" data-i18n="floor3">3Ê•º</option>
                    <option value="4" data-i18n="floor4">4Ê•º</option>
                    <option value="5" data-i18n="floor5">5Ê•º</option>
                    <option value="6-10" data-i18n="floor6to10">6-10Ê•º</option>
                    <option value="11-20" data-i18n="floor11to20">11-20Ê•º</option>
                    <option value="21+" data-i18n="floor21plus">21Ê•º‰ª•‰∏ä</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="room-count" data-i18n="roomCount">ÊàøÈó¥Êï∞Èáè</label>
                <p class="form-help" data-i18n="roomHelp">üí° ËØ¥ÊòéÔºöÊåáÂçßÂÆ§Êï∞ÈáèÔºåÊúâÂä©‰∫éÊèê‰æõÊõ¥Á≤æÂáÜÁöÑÁ©∫Èó¥Â∏ÉÂ±ÄÂª∫ËÆÆÔºàÂèØÈÄâÔºâ</p>
                <select class="form-select" id="room-count">
                    <option value="" data-i18n="selectRooms">ËØ∑ÈÄâÊã©ÊàøÈó¥Êï∞ÔºàÂèØÈÄâÔºâ</option>
                    <option value="1" data-i18n="room1">1ÂÆ§</option>
                    <option value="2" data-i18n="room2">2ÂÆ§</option>
                    <option value="3" data-i18n="room3">3ÂÆ§</option>
                    <option value="4" data-i18n="room4">4ÂÆ§</option>
                    <option value="5+" data-i18n="room5plus">5ÂÆ§‰ª•‰∏ä</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="family-size" data-i18n="familySize">ÂÆ∂Â∫≠‰∫∫Êï∞</label>
                <select class="form-select" id="family-size">
                    <option value="" data-i18n="selectFamily">ËØ∑ÈÄâÊã©ÂÆ∂Â∫≠‰∫∫Êï∞ÔºàÂèØÈÄâÔºâ</option>
                    <option value="1" data-i18n="family1">1‰∫∫</option>
                    <option value="2" data-i18n="family2">2‰∫∫</option>
                    <option value="3" data-i18n="family3">3‰∫∫</option>
                    <option value="4" data-i18n="family4">4‰∫∫</option>
                    <option value="5+" data-i18n="family5plus">5‰∫∫‰ª•‰∏ä</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="house-photo" data-i18n="photoUpload">Êà∑ÂûãÂõæ‰∏ä‰º†</label>
                <p class="form-help" data-i18n="photoHelp">üí° ‰∏ä‰º†Êà∑ÂûãÂõæÂèØËé∑ÂæóÊõ¥Á≤æÂáÜÁöÑÈ£éÊ∞¥ÂàÜÊûêÔºàÂèØÈÄâÔºåÊîØÊåÅJPG„ÄÅPNGÊ†ºÂºèÔºå‰∏çË∂ÖËøá5MBÔºâ</p>
                <div class="file-upload-area" id="file-upload-area">
                    <input type="file" class="file-input" id="house-photo" accept="image/*" style="display: none;">
                    <div class="upload-placeholder" id="upload-placeholder">
                        <div class="upload-icon">üìÅ</div>
                        <p data-i18n="uploadText">ÁÇπÂáªÈÄâÊã©Êà∑ÂûãÂõæÁâáÊàñÊãñÊãΩÂà∞Ê≠§Â§Ñ</p>
                        <small data-i18n="uploadFormat">ÊîØÊåÅ JPG„ÄÅPNG Ê†ºÂºèÔºåÊñá‰ª∂Â§ßÂ∞è‰∏çË∂ÖËøá 5MB</small>
                    </div>
                    <div class="file-preview" id="file-preview" style="display: none;">
                        <img id="preview-image" src="" alt="Êà∑ÂûãÂõæÈ¢ÑËßà" style="max-width: 200px; max-height: 200px; border-radius: 6px;">
                        <button type="button" class="remove-file-btn" id="remove-file-btn">√ó</button>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="description" data-i18n="description">ÊàøÂ±ãÊèèËø∞</label>
                <textarea class="form-input" id="description" rows="4" placeholder="" data-i18n-placeholder="descriptionPlaceholder"></textarea>
            </div>

            <button type="submit" class="btn" id="analyze-btn" data-i18n="analyzeBtn">ÂºÄÂßãÂàÜÊûê</button>
        </form>

        <!-- ÂàÜÊûêËøõÂ∫¶ÊåáÁ§∫Âô® -->
        <div id="progress-container" style="display: none; margin-top: 40px;">
            <div class="progress-card">
                <h3 style="color: var(--primary-gold); text-align: center; margin-bottom: 20px;" data-i18n="analyzingTitle">üîÆ Ê≠£Âú®ËøõË°åÈ£éÊ∞¥ÂàÜÊûê</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-steps">
                    <div class="progress-step active" id="step-1">
                        <div class="step-icon">üìä</div>
                        <div class="step-text" data-i18n="step1">Êï∞ÊçÆÂàÜÊûê</div>
                    </div>
                    <div class="progress-step" id="step-2">
                        <div class="step-icon">üß≠</div>
                        <div class="step-text" data-i18n="step2">Êñπ‰ΩçËÆ°ÁÆó</div>
                    </div>
                    <div class="progress-step" id="step-3">
                        <div class="step-icon">üè†</div>
                        <div class="step-text" data-i18n="step3">Â∏ÉÂ±ÄÂàÜÊûê</div>
                    </div>
                    <div class="progress-step" id="step-4">
                        <div class="step-icon">üí°</div>
                        <div class="step-text" data-i18n="step4">Âª∫ËÆÆÁîüÊàê</div>
                    </div>
                </div>
                <div class="progress-message" id="progress-message" data-i18n="progressMsg">ËØ∑Á®çÂÄôÔºåAIÊ≠£Âú®Ê∑±Â∫¶ÂàÜÊûêÊÇ®ÁöÑ‰ΩèÂÆÖÈ£éÊ∞¥...</div>
            </div>
        </div>

        <!-- ÂàÜÊûêÁªìÊûúÊòæÁ§∫Âå∫Âüü -->
        <div id="result-section" style="display: none; margin-top: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="color: var(--primary-gold); margin: 0;" data-i18n="resultTitle">üîÆ È£éÊ∞¥ÂàÜÊûêÁªìÊûú</h2>
                <div id="export-controls" style="display: flex; gap: 10px; align-items: center;">
                    <button class="export-btn" onclick="exportToPDF()" data-i18n="exportPDF" title="ÂØºÂá∫‰∏∫PDFÊñá‰ª∂">
                        üìÑ PDF
                    </button>
                    <button class="export-btn" onclick="exportToImage()" data-i18n="exportImage" title="ÂØºÂá∫‰∏∫ÂõæÁâá">
                        üñºÔ∏è ÂõæÁâá
                    </button>
                    <button class="export-btn" onclick="exportToText()" data-i18n="exportText" title="ÂØºÂá∫‰∏∫ÊñáÊú¨Êñá‰ª∂">
                        üìù ÊñáÊú¨
                    </button>
                    <button class="export-btn" onclick="shareResult()" data-i18n="shareResult" title="ÂàÜ‰∫´ÂàÜÊûêÁªìÊûú">
                        üîó ÂàÜ‰∫´
                    </button>
                </div>
            </div>
            <div id="result-content" style="background: var(--bg-card); padding: 20px; border-radius: 8px; margin-top: 0;">
                <!-- ÁªìÊûúÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
        </div>
    </div>

    <!-- ËøîÂõûÈ°∂ÈÉ®ÊåâÈíÆÔºàÁßªÂä®Á´ØÔºâ-->
    <div id="back-to-top" style="display: none; position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background: var(--primary-gold); border-radius: 50%; cursor: pointer; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); opacity: 0.8; transition: all 0.3s ease;">
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--bg-primary); font-size: 1.2rem; font-weight: bold;">‚Üë</div>
    </div>

    <!-- ÁÆ°ÁêÜÈù¢ÊùøÔºàÈöêËóèÔºâ-->
    <div id="admin-panel" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000;">
        <div style="position: relative; width: 90%; max-width: 1200px; margin: 20px auto; background: var(--bg-primary); border-radius: 12px; padding: 20px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--primary-gold); padding-bottom: 10px;">
                <h2 style="color: var(--primary-gold); margin: 0;">üîß Á≥ªÁªüÁõëÊéßÈù¢Êùø</h2>
                <button id="close-admin" style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">‚úï ÂÖ≥Èó≠</button>
            </div>
            
            <!-- ÂÆûÊó∂ÁªüËÆ°Âç°Áâá -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="stat-card">
                    <h3>üìä ‰ªäÊó•ÁªüËÆ°</h3>
                    <div id="today-stats">Âä†ËΩΩ‰∏≠...</div>
                </div>
                <div class="stat-card">
                    <h3>ü§ñ AIÊÄßËÉΩ</h3>
                    <div id="ai-performance">Âä†ËΩΩ‰∏≠...</div>
                </div>
                <div class="stat-card">
                    <h3>üåê Áî®Êà∑ÂàÜÂ∏É</h3>
                    <div id="user-distribution">Âä†ËΩΩ‰∏≠...</div>
                </div>
                <div class="stat-card">
                    <h3>‚ö° Á≥ªÁªüÁä∂ÊÄÅ</h3>
                    <div id="system-health">Âä†ËΩΩ‰∏≠...</div>
                </div>
            </div>

            <!-- ËØ¶ÁªÜÂàÜÊûêË°®Ê†º -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3 style="color: var(--primary-gold); border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">üîÑ AIÊ®°ÂûãÂØπÊØî</h3>
                    <div id="ai-comparison-table">Âä†ËΩΩ‰∏≠...</div>
                </div>
                <div>
                    <h3 style="color: var(--primary-gold); border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">üìà ‰ΩøÁî®Ë∂ãÂäø</h3>
                    <div id="usage-trends">Âä†ËΩΩ‰∏≠...</div>
                </div>
            </div>

            <!-- ÊúÄËøëÂèçÈ¶à -->
            <div style="margin-top: 20px;">
                <h3 style="color: var(--primary-gold); border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">üí¨ ÊúÄËøëÁî®Êà∑ÂèçÈ¶à</h3>
                <div id="recent-feedback">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>
    </div>

    <style>
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
        }
        .stat-card h3 {
            color: var(--primary-gold);
            margin: 0 0 10px 0;
            font-size: 1rem;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
        }
        .stat-value {
            color: var(--primary-gold);
            font-weight: bold;
        }
        .performance-bar {
            background: #333;
            border-radius: 10px;
            height: 6px;
            margin: 5px 0;
            overflow: hidden;
        }
        .performance-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444 0%, #ffaa44 50%, #44ff44 100%);
            transition: width 0.3s ease;
        }
    </style>

    <script>
        // Â§öËØ≠Ë®ÄÈÖçÁΩÆ
        const i18n = {
            zh: {
                title: 'Êô∫ËÉΩÈ£éÊ∞¥Â§ßÂ∏à',
                subtitle: '‰∏ì‰∏öAIÈ£éÊ∞¥ÂàÜÊûêÊúçÂä° | Â•¢Âçé‰ΩèÂÆÖÂ∏ÉÂ±Ä‰ºòÂåñ | ÂÖ®ÁêÉ‰∏ì‰∏öÂí®ËØ¢ | $3.99Ëµ∑',
                houseType: 'ÊàøÂ±ãÁ±ªÂûã',
                selectHouseType: 'ËØ∑ÈÄâÊã©ÊàøÂ±ãÁ±ªÂûã',
                residential: '‰ΩèÂÆÖ',
                office: 'ÂäûÂÖ¨ÂÆ§',
                shop: 'ÂïÜÈì∫',
                direction: 'ÊàøÂ±ãÊúùÂêë',
                directionHelp: 'üí° ËØ¥ÊòéÔºöËØ∑ÈÄâÊã©ÂÖ•Êà∑Èó®Èù¢ÂØπÁöÑÊñπÂêëÔºàÂç≥Á´ôÂú®Èó®ÂÜÖÂêëÂ§ñÁúãÁöÑÊñπÂêëÔºâ',
                selectDirection: 'ËØ∑ÈÄâÊã©ÂÖ•Êà∑Èó®ÊúùÂêë',
                north: 'ÂåóÔºàÂÖ•Êà∑Èó®Èù¢ÂêëÂåóÊñπÔºâ',
                south: 'ÂçóÔºàÂÖ•Êà∑Èó®Èù¢ÂêëÂçóÊñπÔºâ',
                east: '‰∏úÔºàÂÖ•Êà∑Èó®Èù¢Âêë‰∏úÊñπÔºâ',
                west: 'Ë•øÔºàÂÖ•Êà∑Èó®Èù¢ÂêëË•øÊñπÔºâ',
                northeast: '‰∏úÂåóÔºàÂÖ•Êà∑Èó®Èù¢Âêë‰∏úÂåóÊñπÔºâ',
                northwest: 'Ë•øÂåóÔºàÂÖ•Êà∑Èó®Èù¢ÂêëË•øÂåóÊñπÔºâ',
                southeast: '‰∏úÂçóÔºàÂÖ•Êà∑Èó®Èù¢Âêë‰∏úÂçóÊñπÔºâ',
                southwest: 'Ë•øÂçóÔºàÂÖ•Êà∑Èó®Èù¢ÂêëË•øÂçóÊñπÔºâ',
                area: 'Èù¢ÁßØÔºàÂπ≥ÊñπÁ±≥Ôºâ',
                areaPlaceholder: 'ËØ∑ËæìÂÖ•ÊàøÂ±ãÈù¢ÁßØ',
                floorLevel: 'ÊâÄÂú®Ê•ºÂ±Ç',
                selectFloor: 'ËØ∑ÈÄâÊã©Ê•ºÂ±ÇÔºàÂèØÈÄâÔºâ',
                floor1: '1Ê•º',
                floor2: '2Ê•º',
                floor3: '3Ê•º',
                floor4: '4Ê•º',
                floor5: '5Ê•º',
                floor6to10: '6-10Ê•º',
                floor11to20: '11-20Ê•º',
                floor21plus: '21Ê•º‰ª•‰∏ä',
                roomCount: 'ÊàøÈó¥Êï∞Èáè',
                roomHelp: 'üí° ËØ¥ÊòéÔºöÊåáÂçßÂÆ§Êï∞ÈáèÔºåÊúâÂä©‰∫éÊèê‰æõÊõ¥Á≤æÂáÜÁöÑÁ©∫Èó¥Â∏ÉÂ±ÄÂª∫ËÆÆÔºàÂèØÈÄâÔºâ',
                selectRooms: 'ËØ∑ÈÄâÊã©ÊàøÈó¥Êï∞ÔºàÂèØÈÄâÔºâ',
                room1: '1ÂÆ§',
                room2: '2ÂÆ§',
                room3: '3ÂÆ§',
                room4: '4ÂÆ§',
                room5plus: '5ÂÆ§‰ª•‰∏ä',
                familySize: 'ÂÆ∂Â∫≠‰∫∫Êï∞',
                selectFamily: 'ËØ∑ÈÄâÊã©ÂÆ∂Â∫≠‰∫∫Êï∞ÔºàÂèØÈÄâÔºâ',
                family1: '1‰∫∫',
                family2: '2‰∫∫',
                family3: '3‰∫∫',
                family4: '4‰∫∫',
                family5plus: '5‰∫∫‰ª•‰∏ä',
                photoUpload: 'Êà∑ÂûãÂõæ‰∏ä‰º†',
                photoHelp: 'üí° ‰∏ä‰º†Êà∑ÂûãÂõæÂèØËé∑ÂæóÊõ¥Á≤æÂáÜÁöÑÈ£éÊ∞¥ÂàÜÊûêÔºàÂèØÈÄâÔºåÊîØÊåÅJPG„ÄÅPNGÊ†ºÂºèÔºå‰∏çË∂ÖËøá5MBÔºâ',
                uploadText: 'ÁÇπÂáªÈÄâÊã©Êà∑ÂûãÂõæÁâáÊàñÊãñÊãΩÂà∞Ê≠§Â§Ñ',
                uploadFormat: 'ÊîØÊåÅ JPG„ÄÅPNG Ê†ºÂºèÔºåÊñá‰ª∂Â§ßÂ∞è‰∏çË∂ÖËøá 5MB',
                description: 'ÊàøÂ±ãÊèèËø∞',
                descriptionPlaceholder: 'ËØ∑ÊèèËø∞ÊàøÂ±ãÁöÑÂÖ∑‰ΩìÊÉÖÂÜµÔºåÂ¶ÇÔºöË£Ö‰øÆÈ£éÊ†º„ÄÅÂÆ∂ÂÖ∑ÊëÜÊîæÁ≠â',
                analyzeBtn: 'üîÆ Ëé∑Âèñ‰∏ì‰∏öÈ£éÊ∞¥ÂàÜÊûê',
                analyzing: 'ÂàÜÊûê‰∏≠...',
                resultTitle: 'üîÆ È£éÊ∞¥ÂàÜÊûêÁªìÊûú',
                scoreTitle: 'ÁªºÂêàËØÑÂàÜ',
                directionTitle: 'ÊúùÂêëÂàÜÊûê',
                layoutTitle: 'Â∏ÉÂ±ÄÂª∫ËÆÆ',
                actionTitle: 'Á´ãÂç≥ÊîπÂñÑÂª∫ËÆÆ',
                notesTitle: 'ÈáçË¶ÅÊèêÈÜí',
                explanationTitle: 'üí° ÂàÜÊûêËØ¥Êòé',
                explanationText: 'È£éÊ∞¥ÂàÜÊûê‰ºöÁªìÂêàÂΩìÂâçÊó∂Èó¥„ÄÅËøêÂäøÂë®ÊúüÁ≠âÂä®ÊÄÅÂõ†Á¥†ÔºåÂõ†Ê≠§ÂêåÊ†∑Êù°‰ª∂‰∏ãÂèØËÉΩ‰∫ßÁîüËΩªÂæÆÂ∑ÆÂºÇ„ÄÇËøô‰ΩìÁé∞‰∫Ü‰º†ÁªüÈ£éÊ∞¥Â≠¶"Âõ†Êó∂Âà∂ÂÆú"ÁöÑÊ†∏ÂøÉÁêÜÂøµÔºåÂª∫ËÆÆ‰ª•ÁªºÂêàË∂ãÂäø‰∏∫ÂáÜ„ÄÇ',
                analyzingTitle: 'üîÆ Ê≠£Âú®ËøõË°åÈ£éÊ∞¥ÂàÜÊûê',
                step1: 'Êï∞ÊçÆÂàÜÊûê',
                step2: 'Êñπ‰ΩçËÆ°ÁÆó',
                step3: 'Â∏ÉÂ±ÄÂàÜÊûê',
                step4: 'Âª∫ËÆÆÁîüÊàê',
                progressMsg: 'ËØ∑Á®çÂÄôÔºåAIÊ≠£Âú®Ê∑±Â∫¶ÂàÜÊûêÊÇ®ÁöÑ‰ΩèÂÆÖÈ£éÊ∞¥...',
                exportPDF: 'üìÑ PDF',
                exportImage: 'üñºÔ∏è ÂõæÁâá',
                exportText: 'üìù ÊñáÊú¨',
                shareResult: 'üîó ÂàÜ‰∫´'
            },
            en: {
                title: 'AI Feng Shui Master',
                subtitle: 'Professional AI-Powered Feng Shui Analysis | Luxury Home & Office Worldwide | From $3.99',
                houseType: 'Property Type',
                selectHouseType: 'Please select property type',
                residential: 'Residential',
                office: 'Office',
                shop: 'Shop',
                direction: 'House Orientation',
                directionHelp: 'üí° Note: Please select the direction your main entrance faces (the direction you see when standing inside looking out)',
                selectDirection: 'Please select main entrance direction',
                north: 'North (Entrance facing north)',
                south: 'South (Entrance facing south)',
                east: 'East (Entrance facing east)',
                west: 'West (Entrance facing west)',
                northeast: 'Northeast (Entrance facing northeast)',
                northwest: 'Northwest (Entrance facing northwest)',
                southeast: 'Southeast (Entrance facing southeast)',
                southwest: 'Southwest (Entrance facing southwest)',
                area: 'Area (Square Meters)',
                areaPlaceholder: 'Please enter property area',
                floorLevel: 'Floor Level',
                selectFloor: 'Please select floor (Optional)',
                floor1: '1st Floor',
                floor2: '2nd Floor',
                floor3: '3rd Floor',
                floor4: '4th Floor',
                floor5: '5th Floor',
                floor6to10: '6-10 Floors',
                floor11to20: '11-20 Floors',
                floor21plus: '21+ Floors',
                roomCount: 'Number of Rooms',
                roomHelp: 'üí° Note: Refers to bedroom count, helps provide more precise layout suggestions (Optional)',
                selectRooms: 'Please select rooms (Optional)',
                room1: '1 Room',
                room2: '2 Rooms',
                room3: '3 Rooms',
                room4: '4 Rooms',
                room5plus: '5+ Rooms',
                familySize: 'Family Size',
                selectFamily: 'Please select family size (Optional)',
                family1: '1 Person',
                family2: '2 People',
                family3: '3 People',
                family4: '4 People',
                family5plus: '5+ People',
                photoUpload: 'Floor Plan Upload',
                photoHelp: 'üí° Upload floor plan for more accurate Feng Shui analysis (Optional, supports JPG, PNG format, max 5MB)',
                uploadText: 'Click to select floor plan or drag here',
                uploadFormat: 'Supports JPG, PNG format, max 5MB',
                description: 'Property Description',
                descriptionPlaceholder: 'Please describe your property details, such as: decoration style, furniture arrangement, etc.',
                analyzeBtn: 'üîÆ Get Premium Feng Shui Analysis',
                analyzing: 'Analyzing...',
                resultTitle: 'üîÆ Feng Shui Analysis Result',
                scoreTitle: 'Overall Score',
                directionTitle: 'Orientation Analysis',
                layoutTitle: 'Layout Suggestions',
                actionTitle: 'Immediate Improvements',
                notesTitle: 'Important Notes',
                explanationTitle: 'üí° Analysis Note',
                explanationText: 'Feng Shui analysis incorporates dynamic factors such as current time and fortune cycles, so slight variations may occur under the same conditions. This reflects the core concept of traditional Feng Shui "adapting to time and circumstances". Please focus on the overall trends.',
                analyzingTitle: 'üîÆ Feng Shui Analysis in Progress',
                step1: 'Data Analysis',
                step2: 'Direction Calculation',
                step3: 'Layout Analysis',
                step4: 'Recommendation Generation',
                progressMsg: 'Please wait, AI is deeply analyzing your residential Feng Shui...',
                exportPDF: 'üìÑ PDF',
                exportImage: 'üñºÔ∏è Image',
                exportText: 'üìù Text',
                shareResult: 'üîó Share'
            }
        };

        let currentLang = 'zh';
        
        // ‰∫ã‰ª∂ËøΩË∏™Á≥ªÁªü
        function trackEvent(eventName, properties = {}) {
            const eventData = {
                event: eventName,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href,
                language: currentLang,
                ...properties
            };
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®ÔºàÁîü‰∫ßÁéØÂ¢ÉÂ∫îÂèëÈÄÅÂà∞ÂàÜÊûêÊúçÂä°Ôºâ
            const events = JSON.parse(localStorage.getItem('analytics_events') || '[]');
            events.push(eventData);
            localStorage.setItem('analytics_events', JSON.stringify(events));
            
            // ËæìÂá∫Âà∞ÊéßÂà∂Âè∞Áî®‰∫éË∞ÉËØï
            console.log('üìä Event Tracked:', eventData);
        }

        // ËØ≠Ë®ÄÂàáÊç¢ÂáΩÊï∞
        function switchLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            
            // Êõ¥Êñ∞URLÂèÇÊï∞
            const url = new URL(window.location);
            url.searchParams.set('lang', lang);
            window.history.replaceState({}, '', url);
            
            // Êõ¥Êñ∞hreflangÈìæÊé•
            document.getElementById('hreflang-en').href = window.location.pathname + '?lang=en';
            document.getElementById('hreflang-zh').href = window.location.pathname + '?lang=zh';
            document.getElementById('hreflang-default').href = window.location.pathname + '?lang=en';
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`lang-${lang}`).classList.add('active');

            // Êõ¥Êñ∞ÊâÄÊúâÂ∏¶Êúâ data-i18n ÁöÑÂÖÉÁ¥†
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang][key]) {
                    el.textContent = i18n[lang][key];
                }
            });

            // Êõ¥Êñ∞placeholder
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (i18n[lang][key]) {
                    el.placeholder = i18n[lang][key];
                }
            });

            // ‰øùÂ≠òËØ≠Ë®ÄÈÄâÊã©
            localStorage.setItem('selectedLanguage', lang);
            
            // Â¶ÇÊûúÊúâÊòæÁ§∫ÁöÑÂàÜÊûêÁªìÊûúÔºåÈáçÊñ∞Ê∏≤ÊüìÂÜÖÂÆπ
            const resultSection = document.getElementById('result-section');
            if (resultSection && resultSection.style.display !== 'none' && window.lastAnalysisResult) {
                displayResult(window.lastAnalysisResult);
            }
        }

        // ÁßªÂä®Á´Ø‰ºòÂåñÂäüËÉΩ
        function initMobileOptimizations() {
            // Ê£ÄÊµãÁßªÂä®ËÆæÂ§á
            const isMobile = window.innerWidth <= 768;
            const isTouchDevice = 'ontouchstart' in window;

            if (isMobile || isTouchDevice) {
                // ‰ºòÂåñË°®ÂçïÊªöÂä®Ë°å‰∏∫
                const formInputs = document.querySelectorAll('input, select, textarea');
                formInputs.forEach(input => {
                    input.addEventListener('focus', (e) => {
                        // Âª∂ËøüÊªöÂä®ÔºåÈÅøÂÖçËôöÊãüÈîÆÁõòÂΩ±Âìç
                        setTimeout(() => {
                            e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    });
                });

                // ‰ºòÂåñÊñá‰ª∂‰∏ä‰º†Âå∫ÂüüÁöÑËß¶Êë∏ÂèçÈ¶à
                const uploadArea = document.getElementById('file-upload-area');
                if (uploadArea) {
                    let touchStartTime = 0;
                    
                    uploadArea.addEventListener('touchstart', (e) => {
                        touchStartTime = Date.now();
                        uploadArea.style.transform = 'scale(0.98)';
                        uploadArea.style.transition = 'transform 0.1s ease';
                    });

                    uploadArea.addEventListener('touchend', (e) => {
                        uploadArea.style.transform = 'scale(1)';
                        
                        // Â¶ÇÊûúÊòØÂø´ÈÄüÁÇπÂáªÔºåËß¶ÂèëÊñá‰ª∂ÈÄâÊã©
                        if (Date.now() - touchStartTime < 200) {
                            document.getElementById('house-photo').click();
                        }
                    });

                    uploadArea.addEventListener('touchcancel', (e) => {
                        uploadArea.style.transform = 'scale(1)';
                    });
                }

                // ‰ºòÂåñÊåâÈíÆËß¶Êë∏ÂèçÈ¶à
                const buttons = document.querySelectorAll('.analyze-button, .lang-btn, .remove-file-btn');
                buttons.forEach(button => {
                    button.addEventListener('touchstart', (e) => {
                        button.style.transform = 'scale(0.95)';
                        button.style.transition = 'transform 0.1s ease';
                    });

                    button.addEventListener('touchend', (e) => {
                        setTimeout(() => {
                            button.style.transform = 'scale(1)';
                        }, 100);
                    });

                    button.addEventListener('touchcancel', (e) => {
                        button.style.transform = 'scale(1)';
                    });
                });

                // Èò≤Ê≠¢ÁßªÂä®Á´ØÂèåÂáªÁº©ÊîæÔºàÂú®ÂàÜÊûêÊåâÈíÆ‰∏äÔºâ
                const analyzeButton = document.getElementById('analyze-button');
                if (analyzeButton) {
                    analyzeButton.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        setTimeout(() => {
                            analyzeButton.click();
                        }, 100);
                    });
                }

                // ‰ºòÂåñÁªìÊûúÂå∫ÂüüÁöÑÊªöÂä®
                const resultSection = document.getElementById('result-section');
                if (resultSection) {
                    const observer = new MutationObserver(() => {
                        if (resultSection.style.display === 'block') {
                            setTimeout(() => {
                                resultSection.scrollIntoView({ 
                                    behavior: 'smooth', 
                                    block: 'start',
                                    inline: 'nearest'
                                });
                            }, 500);
                        }
                    });
                    
                    observer.observe(resultSection, { 
                        attributes: true, 
                        attributeFilter: ['style'] 
                    });
                }
            }

            // Ê∑ªÂä†ÁßªÂä®Á´Ø‰∏ìÁî®ÁöÑswipeÊâãÂäøÔºàÁî®‰∫éÁÆ°ÁêÜÈù¢ÊùøÔºâ
            if (isTouchDevice) {
                let startY = 0;
                let startX = 0;

                document.addEventListener('touchstart', (e) => {
                    startY = e.touches[0].clientY;
                    startX = e.touches[0].clientX;
                });

                document.addEventListener('touchend', (e) => {
                    if (!adminPanelVisible) return;

                    const endY = e.changedTouches[0].clientY;
                    const endX = e.changedTouches[0].clientX;
                    const diffY = startY - endY;
                    const diffX = startX - endX;

                    // Âêë‰∏ãÊªëÂä®ÂÖ≥Èó≠ÁÆ°ÁêÜÈù¢Êùø
                    if (diffY < -100 && Math.abs(diffX) < 50) {
                        closeAdminPanel();
                    }
                });
            }
        }

        // Ê∑ªÂä†ÁßªÂä®Á´ØÁöÑËßÜÁ™óÂèòÂåñÁõëÂê¨
        function handleViewportChange() {
            // Â§ÑÁêÜÁßªÂä®Á´ØËΩØÈîÆÁõòÊòæÁ§∫/ÈöêËóè
            const visualViewport = window.visualViewport;
            if (visualViewport) {
                visualViewport.addEventListener('resize', () => {
                    document.documentElement.style.setProperty(
                        '--vh', 
                        `${visualViewport.height * 0.01}px`
                    );
                });
            }

            // Â§ÑÁêÜÂ±èÂπïÊñπÂêëÂèòÂåñ
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    // ÈáçÊñ∞ËÆ°ÁÆóÂ∏ÉÂ±Ä
                    window.dispatchEvent(new Event('resize'));
                    
                    // Â¶ÇÊûúÁÆ°ÁêÜÈù¢ÊùøÂºÄÂêØÔºåË∞ÉÊï¥ÂÖ∂Â§ßÂ∞è
                    if (adminPanelVisible) {
                        const adminPanel = document.getElementById('admin-panel');
                        if (adminPanel) {
                            adminPanel.style.height = '100vh';
                        }
                    }
                }, 500);
            });
        }

        // Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÁßªÈô§Âä†ËΩΩÂä®ÁîªÂíåÂàùÂßãÂåñËØ≠Ë®Ä
        window.addEventListener('load', () => {
            // ÂàùÂßãÂåñÁßªÂä®Á´Ø‰ºòÂåñ
            initMobileOptimizations();
            handleViewportChange();
            const loader = document.querySelector('.page-loader');
            if (loader) {
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);
            }

            // ÂàùÂßãÂåñËØ≠Ë®ÄÔºà‰ºòÂÖà‰ΩøÁî®URLÂèÇÊï∞ÔºåÁÑ∂ÂêéÁî®Êà∑‰πãÂâçÁöÑÈÄâÊã©Ôºâ
            const urlParams = new URLSearchParams(window.location.search);
            const urlLang = urlParams.get('lang');
            const savedLang = localStorage.getItem('selectedLanguage') || 'zh';
            const initialLang = urlLang || savedLang;
            
            if (initialLang !== 'zh') {
                switchLanguage(initialLang);
            }

            // ÁªëÂÆöËØ≠Ë®ÄÂàáÊç¢‰∫ã‰ª∂
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    switchLanguage(btn.getAttribute('data-lang'));
                });
            });
        });

        // Êñá‰ª∂‰∏ä‰º†Â§ÑÁêÜ
        const fileInput = document.getElementById('house-photo');
        const uploadArea = document.getElementById('file-upload-area');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const filePreview = document.getElementById('file-preview');
        const previewImage = document.getElementById('preview-image');
        const removeFileBtn = document.getElementById('remove-file-btn');

        // ÁÇπÂáª‰∏ä‰º†Âå∫ÂüüËß¶ÂèëÊñá‰ª∂ÈÄâÊã©
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // Êñá‰ª∂ÈÄâÊã©Â§ÑÁêÜ
        fileInput.addEventListener('change', handleFileSelect);
        
        // ÊãñÊãΩ‰∏ä‰º†Â§ÑÁêÜ
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--primary-gold-light)';
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--primary-gold)';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--primary-gold)';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect({ target: { files: files } });
            }
        });

        // Âà†Èô§Êñá‰ª∂Â§ÑÁêÜ
        removeFileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.value = '';
            uploadPlaceholder.style.display = 'block';
            filePreview.style.display = 'none';
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
            if (!file.type.startsWith('image/')) {
                alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
                return;
            }

            // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Êñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá5MB');
                return;
            }

            // ÊòæÁ§∫È¢ÑËßà
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                uploadPlaceholder.style.display = 'none';
                filePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // Ë°®ÂçïËæìÂÖ•È™åËØÅ
        function validateForm() {
            // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
            const houseType = document.getElementById('house-type').value;
            const direction = document.getElementById('direction').value;
            const area = document.getElementById('area').value;
            
            if (!houseType) {
                const errorMsg = currentLang === 'en' ? 
                    'Please select property type' : 
                    'ËØ∑ÈÄâÊã©ÊàøÂ±ãÁ±ªÂûã';
                alert(errorMsg);
                return false;
            }
            
            if (!direction) {
                const errorMsg = currentLang === 'en' ? 
                    'Please select house orientation' : 
                    'ËØ∑ÈÄâÊã©ÊàøÂ±ãÊúùÂêë';
                alert(errorMsg);
                return false;
            }
            
            const areaValue = parseFloat(area);
            if (!area || isNaN(areaValue) || areaValue < 1 || areaValue > 10000) {
                const errorMsg = currentLang === 'en' ? 
                    'Area must be between 1 and 10,000 square meters' : 
                    'Èù¢ÁßØÂøÖÈ°ªÂú®1Âà∞10000Âπ≥ÊñπÁ±≥‰πãÈó¥';
                alert(errorMsg);
                document.getElementById('area').focus();
                return false;
            }
            
            return true;
        }

        // ÂâçÁ´ØÂàÜÊûêÂºïÊìé - ÂÖúÂ∫ïÊñπÊ°à
        async function generateLocalAnalysis(formData, language = 'zh') {
            const isEnglish = language === 'en';
            
            // ÊàøÂ±ãÊúùÂêëËØÑÂàÜË°®
            const directionScores = {
                'Ê≠£Âçó': 92, '‰∏úÂçó': 88, 'Ê≠£‰∏ú': 85, 'Ë•øÂçó': 82,
                'Ê≠£Âåó': 78, '‰∏úÂåó': 75, 'Ê≠£Ë•ø': 72, 'Ë•øÂåó': 70,
                '‰∏çÁ°ÆÂÆö': 75
            };
            
            const score = directionScores[formData.direction] || 75;
            
            function getScoreLevel(score) {
                if (score >= 90) return isEnglish ? "Excellent" : "ÊûÅÂêâÊ†ºÂ±Ä";
                if (score >= 85) return isEnglish ? "Very Good" : "Â§ßÂêâÊ†ºÂ±Ä";
                if (score >= 80) return isEnglish ? "Good" : "ÂêâÂà©Ê†ºÂ±Ä";
                if (score >= 75) return isEnglish ? "Above Average" : "ËæÉ‰∏∫ÂêâÂà©";
                return isEnglish ? "Average" : "‰∏≠Á≠âÊ∞¥Âπ≥";
            }

            const level = getScoreLevel(score);
            
            const analysisResult = {
                analysis: isEnglish ? 
                    `üè† Professional Feng Shui Analysis

Property Details:
- Type: ${formData.houseType || 'Residential'}
- Direction: ${formData.direction || 'Unknown'}
- Area: ${formData.area || 'Not specified'}

‚≠ê Overall Score: ${score}/100 (${level})

üß≠ Directional Analysis: ${formData.direction || 'Unknown'} direction ${score >= 80 ? 'provides excellent feng shui energy for prosperity and harmony' : 'offers good potential with some optimization opportunities'}.

üí° Recommendations: ${score >= 85 ? 'Maintain current layout and add green plants for enhanced positive energy.' : 'Consider improving lighting and optimizing furniture arrangement for better energy flow.'}

üìã Important Notes: This analysis is based on traditional feng shui principles combined with modern living considerations.` :

                    `üîÆ AIÈ£éÊ∞¥Â§ßÂ∏à‰∏ì‰∏öÂàÜÊûêÊä•Âëä

üè† ÊàøÂ±ãÂü∫Êú¨‰ø°ÊÅØÔºö
- ÊàøÂ±ãÁ±ªÂûãÔºö${formData.houseType || '‰ΩèÂÆÖ'}
- ÊàøÂ±ãÊúùÂêëÔºö${formData.direction || '‰∏çÁ°ÆÂÆö'}
- ÊàøÂ±ãÈù¢ÁßØÔºö${formData.area || '‰∏çËØ¶'}

‚≠ê ÁªºÂêàËØÑÂàÜÔºö${score}/100 (${level})

üß≠ ÊúùÂêëÂàÜÊûêÔºö${formData.direction || '‰∏çÁ°ÆÂÆö'}ÊúùÂêë${score >= 80 ? 'È£éÊ∞¥Ê†ºÂ±ÄÊûÅ‰Ω≥ÔºåÊúâÂà©‰∫é‰∫ã‰∏öÂèëÂ±ïÂíåÂÆ∂Â∫≠ÂíåË∞ê' : 'È£éÊ∞¥Ê†ºÂ±ÄËâØÂ•ΩÔºåÈÄöËøáÂêàÁêÜÂ∏ÉÁΩÆÂèØËøõ‰∏ÄÊ≠•ÊèêÂçá'}„ÄÇ

üí° ÊîπÂñÑÂª∫ËÆÆÔºö${score >= 85 ? '‰øùÊåÅÁé∞ÊúâÊ†ºÂ±ÄÔºåÂÆöÊúüÊï¥ÁêÜÔºåÈÄÇÂΩìÊ∑ªÂä†ÁªøÊ§çÊèêÂçáÁîüÊ∞î„ÄÇ' : 'Âª∫ËÆÆ‰ºòÂåñÂÆ§ÂÜÖÁÖßÊòéÔºåË∞ÉÊï¥ÂÆ∂ÂÖ∑ÊëÜÊîæÔºåÁ°Æ‰øùÈÄöÈÅìÈ°∫ÁïÖ„ÄÇ'}

üìã ÈáçË¶ÅÊèêÈÜíÔºöÊú¨ÂàÜÊûêÂü∫‰∫é‰º†ÁªüÈ£éÊ∞¥ÁêÜËÆ∫ÁªìÂêàÁé∞‰ª£Â±Ö‰ΩèÈúÄÊ±ÇÔºåÂª∫ËÆÆÁªìÂêàÂÆûÈôÖÊÉÖÂÜµÁªºÂêàÂà§Êñ≠„ÄÇ`,

                recommendations: isEnglish ? 
                    "Focus on natural lighting, keep spaces organized, and consider adding plants for positive energy." :
                    "Ê≥®ÈáçËá™ÁÑ∂ÈááÂÖâÔºå‰øùÊåÅÁ©∫Èó¥Êï¥Ê¥ÅÊúâÂ∫èÔºåÂèØÈÄÇÂΩìÊ∑ªÂä†ÁªøÊ§çÊèêÂçáÊ≠£ËÉΩÈáè„ÄÇ",

                importantNotes: isEnglish ?
                    "For major decisions, consider consulting with professional feng shui practitioners." :
                    "ÈáçÂ§ßÂÜ≥Á≠ñÂª∫ËÆÆÂí®ËØ¢‰∏ì‰∏öÈ£éÊ∞¥Â∏àËøõË°åÂÆûÂú∞ÊåáÂØº„ÄÇ",

                analysisData: {
                    score: score,
                    level: level,
                    direction: formData.direction || '‰∏çÁ°ÆÂÆö',
                    houseType: formData.houseType || '‰ΩèÂÆÖ',
                    area: formData.area || '‰∏çËØ¶',
                    timestamp: new Date().toISOString()
                },

                type: 'full',
                watermark: false,
                freeAccess: true,
                userTier: 'FREE',
                upgradeMessage: 'üöÄ Coming Soon! Professional analysis for $3.99+',
                showUpgradePrompt: true,
                message: isEnglish ? 'Now completely free, thank you for using our service!' : 'Áé∞Âú®ÂÆåÂÖ®ÂÖçË¥πÔºåÊÑüË∞¢ÊÇ®ÁöÑ‰ΩøÁî®ÔºÅ',

                userStatus: {
                    fingerprint: 'frontend_' + Date.now(),
                    dailyUsage: 1,
                    hasFreeAccess: true,
                    lastUsed: new Date().toISOString()
                }
            };

            // Ê®°ÊãüÂàÜÊûêÂª∂ËøüÔºåÊèêÂçáÁî®Êà∑‰ΩìÈ™å
            await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 1500));
            
            return analysisResult;
        }

        // Ë°®ÂçïÊèê‰∫§Â§ÑÁêÜ
        document.getElementById('fengshui-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // È™åËØÅË°®Âçï
            if (!validateForm()) {
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const btn = document.getElementById('analyze-btn');
            const originalText = btn.textContent;
            btn.textContent = i18n[currentLang].analyzing;
            btn.disabled = true;
            
            // ÊòæÁ§∫ËøõÂ∫¶ÊåáÁ§∫Âô®
            showProgressIndicator();

            try {
                // ÂàõÂª∫FormDataÂØπË±°‰ª•ÊîØÊåÅÊñá‰ª∂‰∏ä‰º†
                const formData = new FormData();
                formData.append('houseType', document.getElementById('house-type').value);
                formData.append('direction', document.getElementById('direction').value);
                formData.append('area', document.getElementById('area').value);
                formData.append('floorLevel', document.getElementById('floor-level').value);
                formData.append('roomCount', document.getElementById('room-count').value);
                formData.append('familySize', document.getElementById('family-size').value);
                formData.append('description', document.getElementById('description').value);
                formData.append('language', currentLang); // Ê∑ªÂä†ÂΩìÂâçËØ≠Ë®Ä
                
                // Ê∑ªÂä†Êñá‰ª∂ÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
                const fileInput = document.getElementById('house-photo');
                if (fileInput.files[0]) {
                    formData.append('photo', fileInput.files[0]);
                }

                // Â∞ùËØïË∞ÉÁî®ÂêéÁ´ØAPIÔºåÂ¶ÇÊûúÂ§±Ë¥•Âàô‰ΩøÁî®ÂâçÁ´ØÂàÜÊûê
                let analysisResult;
                
                try {
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            analysisResult = data.data;
                            console.log('‚úÖ ‰ΩøÁî®ÂêéÁ´ØAPIÂàÜÊûê');
                        } else {
                            throw new Error('APIËøîÂõûÈîôËØØ');
                        }
                    } else {
                        throw new Error('APIËØ∑Ê±ÇÂ§±Ë¥•');
                    }
                } catch (apiError) {
                    console.log('‚ö†Ô∏è ÂêéÁ´ØAPI‰∏çÂèØÁî®Ôºå‰ΩøÁî®ÂâçÁ´ØÂàÜÊûêÂºïÊìé');
                    
                    // ‰ΩøÁî®ÂâçÁ´ØÂÜÖÁΩÆÂàÜÊûêÂºïÊìé
                    const formDataObj = {};
                    for (let [key, value] of formData.entries()) {
                        formDataObj[key] = value;
                    }
                    
                    analysisResult = await generateLocalAnalysis(formDataObj, currentLang);
                }

                // ÊòæÁ§∫ÂàÜÊûêÁªìÊûú
                console.log('üìä ÂàÜÊûêÁªìÊûúÊï∞ÊçÆ:', analysisResult);
                hideProgressIndicator();
                displayResult(analysisResult);
                
            } catch (error) {
                console.error('ÂàÜÊûêËØ∑Ê±ÇÂ§±Ë¥•:', error);
                const errorMsg = currentLang === 'en' ? 
                    'Analysis failed, please try again: ' + error.message : 
                    'ÂàÜÊûêËØ∑Ê±ÇÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØïÔºö' + error.message;
                alert(errorMsg);
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                btn.textContent = originalText;
                btn.disabled = false;
                // Á°Æ‰øùÂú®ÈîôËØØÊÉÖÂÜµ‰∏ã‰πüÈöêËóèËøõÂ∫¶ÊåáÁ§∫Âô®
                hideProgressIndicator();
            }
        });

        // ÊòæÁ§∫ÂàÜÊûêÁªìÊûú
        function displayResult(result) {
            // ‰øùÂ≠òÁªìÊûú‰æõËØ≠Ë®ÄÂàáÊç¢Êó∂ÈáçÊñ∞Ê∏≤Êüì
            window.lastAnalysisResult = result;
            
            const resultSection = document.getElementById('result-section');
            const resultContent = document.getElementById('result-content');
            
            console.log('üìä ÂÆåÊï¥ÁªìÊûúÊï∞ÊçÆ:', result);
            
            // Êõ¥Êô∫ËÉΩÁöÑÊï∞ÊçÆÊèêÂèñÂíåÊòæÁ§∫
            const scoreInfo = getScoreInfo(result);
            const directionInfo = getDirectionInfo(result);
            const layoutInfo = getLayoutInfo(result);
            const actionInfo = getActionInfo(result);
            const notesInfo = getNotesInfo(result);
            
            resultContent.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary-gold); margin-bottom: 10px;" data-i18n="scoreTitle">ÁªºÂêàËØÑÂàÜ</h3>
                    <div style="font-size: 1.5em; color: var(--text-primary);">${scoreInfo}</div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary-gold); margin-bottom: 10px;" data-i18n="directionTitle">ÊúùÂêëÂàÜÊûê</h3>
                    <p style="color: var(--text-secondary); line-height: 1.6; white-space: pre-line;">${directionInfo}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary-gold); margin-bottom: 10px;" data-i18n="layoutTitle">Â∏ÉÂ±ÄÂª∫ËÆÆ</h3>
                    <p style="color: var(--text-secondary); line-height: 1.6; white-space: pre-line;">${layoutInfo}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary-gold); margin-bottom: 10px;" data-i18n="actionTitle">Á´ãÂç≥ÊîπÂñÑÂª∫ËÆÆ</h3>
                    <p style="color: var(--text-secondary); line-height: 1.6; white-space: pre-line;">${actionInfo}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary-gold); margin-bottom: 10px;" data-i18n="notesTitle">ÈáçË¶ÅÊèêÈÜí</h3>
                    <p style="color: var(--text-secondary); line-height: 1.6; white-space: pre-line;">${notesInfo}</p>
                </div>
                
${getUpgradeSection(result)}
                
                <div style="background: rgba(218, 165, 32, 0.1); padding: 15px; border-radius: 6px; border-left: 3px solid var(--primary-gold);">
                    <h4 style="color: var(--primary-gold); margin-bottom: 8px; font-size: 0.9rem;" data-i18n="explanationTitle">üí° ÂàÜÊûêËØ¥Êòé</h4>
                    <p style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.4;" data-i18n="explanationText">
                        È£éÊ∞¥ÂàÜÊûê‰ºöÁªìÂêàÂΩìÂâçÊó∂Èó¥„ÄÅËøêÂäøÂë®ÊúüÁ≠âÂä®ÊÄÅÂõ†Á¥†ÔºåÂõ†Ê≠§ÂêåÊ†∑Êù°‰ª∂‰∏ãÂèØËÉΩ‰∫ßÁîüËΩªÂæÆÂ∑ÆÂºÇ„ÄÇËøô‰ΩìÁé∞‰∫Ü‰º†ÁªüÈ£éÊ∞¥Â≠¶"Âõ†Êó∂Âà∂ÂÆú"ÁöÑÊ†∏ÂøÉÁêÜÂøµÔºåÂª∫ËÆÆ‰ª•ÁªºÂêàË∂ãÂäø‰∏∫ÂáÜ„ÄÇ
                    </p>
                </div>
            `;
            
            // ÈáçÊñ∞Â∫îÁî®Â§öËØ≠Ë®ÄÁøªËØëÂà∞Êñ∞ÁîüÊàêÁöÑÂÜÖÂÆπ
            document.querySelectorAll('#result-section [data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[currentLang][key]) {
                    el.textContent = i18n[currentLang][key];
                }
            });
            
            // ‰øùÂ≠òÂéüÂßãÂàÜÊûêÊï∞ÊçÆÂíåÂΩìÂâçËØ≠Ë®ÄÔºå‰ª•‰æøËØ≠Ë®ÄÂàáÊç¢Êó∂ÈáçÊñ∞Ê∏≤Êüì
            resultSection.setAttribute('data-original-result', JSON.stringify(result));
            resultSection.setAttribute('data-result-lang', currentLang);
            
            // ËøΩË∏™ÂàÜÊûêÂÆåÊàê‰∫ã‰ª∂
            trackEvent('analysis_completed', { 
                tier: result.userTier || 'FREE', 
                score: result.score,
                hasImage: !!result.formData?.photo 
            });
            
            // ÁßªÈô§Ëá™Âä®ÈÇÆÁÆ±Êî∂ÈõÜÂºπÁ™ó - Â∑≤Êï¥ÂêàÂà∞ÂçáÁ∫ßÊµÅÁ®ã‰∏≠
            // ÂÖçË¥πÁî®Êà∑ÁöÑÈÇÆÁÆ±Êî∂ÈõÜÁé∞Âú®Âú®ÂçáÁ∫ßÊåâÈíÆÁÇπÂáªÊó∂Ëß¶Âèë
            
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Êô∫ËÉΩÊèêÂèñËØÑÂàÜ‰ø°ÊÅØ
        function getScoreInfo(result) {
            const scoreUnit = currentLang === 'en' ? ' Points' : 'ÂàÜ';
            
            if (result.gradeInfo && result.gradeInfo.name && result.score) {
                return `${result.score}${scoreUnit} - ${result.gradeInfo.name}`;
            } else if (result.score) {
                // Ê†πÊçÆÂàÜÊï∞Êé®ÂØºÁ≠âÁ∫ß
                const grade = getGradeByScore(result.score);
                return `${result.score}${scoreUnit} - ${grade}`;
            } else if (result.fengshuiScore) {
                return `${result.fengshuiScore}${scoreUnit}`;
            } else {
                return currentLang === 'en' ? 'Analysis Complete' : 'ÂàÜÊûêÂÆåÊàê';
            }
        }

        // Ê†πÊçÆÂàÜÊï∞Á°ÆÂÆöÁ≠âÁ∫ßÔºàÊîØÊåÅÂ§öËØ≠Ë®ÄÔºâ
        function getGradeByScore(score) {
            const currentLang = document.documentElement.lang || 'zh';
            
            // ‰øÆÊ≠£Á≠âÁ∫ßËåÉÂõ¥ÂíåÈ°∫Â∫è
            const gradeRanges = [
                { min: 85, zh: 'ÊûÅÂêâÊ†ºÂ±Ä', en: 'Extremely Auspicious' },
                { min: 75, zh: '‰∏äÂêâÊ†ºÂ±Ä', en: 'Very Auspicious' },
                { min: 65, zh: '‰∏≠ÂêâÊ†ºÂ±Ä', en: 'Moderately Auspicious' },
                { min: 55, zh: 'Â∞èÂêâÊ†ºÂ±Ä', en: 'Slightly Auspicious' },
                { min: 45, zh: '‰∏≠Âπ≥Ê†ºÂ±Ä', en: 'Neutral' },
                { min: 35, zh: 'Â∞èÂá∂Ê†ºÂ±Ä', en: 'Slightly Inauspicious' },
                { min: 25, zh: 'Â§ßÂá∂Ê†ºÂ±Ä', en: 'Very Inauspicious' },
                { min: 0, zh: 'Âá∂Èô©Ê†ºÂ±Ä', en: 'Extremely Inauspicious' }
            ];
            
            for (let range of gradeRanges) {
                if (score >= range.min) {
                    return range[currentLang];
                }
            }
            
            // ÈªòËÆ§ËøîÂõûÊúÄ‰ΩéÁ≠âÁ∫ß
            return currentLang === 'en' ? 'Extremely Inauspicious' : 'Âá∂Èô©Ê†ºÂ±Ä';
        }

        // ÂÖçË¥πÁâàÂÜÖÂÆπÊà™Êñ≠ËæÖÂä©ÂáΩÊï∞
        function truncateContent(content, maxLength) {
            if (content.length <= maxLength) return content;
            return content.substring(0, maxLength) + '...';
        }

        // ÂÖçË¥πÁâàÂçáÁ∫ßÊèêÁ§∫
        function getFreeVersionPrompt(type) {
            // ÊîπËøõËØ≠Ë®ÄÊ£ÄÊµãÔºö‰ºòÂÖàÊ£ÄÊü•DOMËØ≠Ë®ÄÂ±ûÊÄß
            let currentLang = 'zh'; // ÈªòËÆ§‰∏≠Êñá
            
            // ÊñπÊ≥ï1ÔºöÊ£ÄÊü•HTML langÂ±ûÊÄß
            if (document.documentElement.lang && document.documentElement.lang.startsWith('en')) {
                currentLang = 'en';
            }
            // ÊñπÊ≥ï2ÔºöÊ£ÄÊü•i18nManager
            else if (window.i18nManager && window.i18nManager.getCurrentLanguage) {
                currentLang = window.i18nManager.getCurrentLanguage();
            }
            // ÊñπÊ≥ï3ÔºöÊ£ÄÊü•localStorage
            else if (localStorage.getItem('preferred-language') === 'en') {
                currentLang = 'en';
            }
            
            console.log('getFreeVersionPrompt currentLang:', currentLang); // Ë∞ÉËØïÁî®
            
            // Áõ¥Êé•‰ΩøÁî®ËØ≠Ë®ÄÊò†Â∞Ñ
            const prompts = {
                'zh': {
                    'direction': '\n\nüîì ÂçáÁ∫ßËá≥BasicÁâà($3.99)Ëß£ÈîÅÂÆåÊï¥ÊúùÂêëÂàÜÊûê',
                    'layout': '\n\nüîì ÂçáÁ∫ßËá≥ProfessionalÁâà($4.99)Ëß£ÈîÅËØ¶ÁªÜÂ∏ÉÂ±ÄÊñπÊ°à',
                    'action': '\n\nüîì ÂçáÁ∫ßËá≥ProfessionalÁâà($4.99)Ëé∑ÂèñÂÖ®ÈÉ®ÊîπÂñÑÂª∫ËÆÆ',
                    'notes': '\n\nüîì ÂçáÁ∫ßËá≥MasterÁâà($29.99)Ëé∑Âèñ‰∏ì‰∏öÈ£éÊ∞¥ÊèêÈÜí',
                    'default': '\n\nüîì ÂçáÁ∫ßËß£ÈîÅÊõ¥Â§öËØ¶ÁªÜÂÜÖÂÆπ'
                },
                'en': {
                    'direction': '\n\nüîì Upgrade to Basic ($3.99) for Complete Orientation Analysis',
                    'layout': '\n\nüîì Upgrade to Professional ($4.99) for Detailed Layout Plans',
                    'action': '\n\nüîì Upgrade to Professional ($4.99) for Complete Improvement Suggestions',
                    'notes': '\n\nüîì Upgrade to Master ($29.99) for Professional Feng Shui Insights',
                    'default': '\n\nüîì Upgrade to unlock more detailed content'
                }
            };
            
            const langPrompts = prompts[currentLang] || prompts['zh'];
            return langPrompts[type] || langPrompts['default'];
        }

        // Êô∫ËÉΩÊèêÂèñÊúùÂêëÂàÜÊûê
        function getDirectionInfo(result) {
            const classifiedContent = result.classifiedContent || {};
            let content = '';
            
            if (classifiedContent.directionAnalysis) {
                content = formatTextWithBreaks(classifiedContent.directionAnalysis);
            } else {
                // ‰ªéÂÆåÊï¥ÂàÜÊûê‰∏≠ÊèêÂèñÊúùÂêëÁõ∏ÂÖ≥ÂÜÖÂÆπ
                const analysis = result.analysis || '';
                const directionMatch = analysis.match(/„ÄêÊñπ‰ΩçÂàÜÊûê„Äë(.*?)„Äê/s);
                if (directionMatch) {
                    content = formatTextWithBreaks(directionMatch[1]);
                } else {
                    content = 'ÊúùÂêëÂàÜÊûêÊï∞ÊçÆÊ≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑Á®çÂêéÊü•Áúã';
                }
            }
            
            // ÂÖçË¥πÁâàÂÜÖÂÆπÈôêÂà∂
            if (result.userTier === 'FREE') {
                return truncateContent(content, 80) + getFreeVersionPrompt('direction');
            }
            
            return content;
        }

        // Êô∫ËÉΩÊèêÂèñÂ∏ÉÂ±ÄÂª∫ËÆÆ
        function getLayoutInfo(result) {
            let content = '';
            
            const classifiedContent = result.classifiedContent || {};
            if (classifiedContent.layoutSuggestions) {
                content = formatTextWithBreaks(classifiedContent.layoutSuggestions);
            } else {
                const analysis = result.analysis || '';
                const layoutMatch = analysis.match(/„ÄêÂ∏ÉÂ±Ä.*?Âª∫ËÆÆ„Äë(.*?)„Äê/s);
                if (layoutMatch) {
                    content = formatTextWithBreaks(layoutMatch[1]);
                } else if (result.recommendations) {
                    content = formatTextWithBreaks(result.recommendations);
                } else {
                    content = 'Â∏ÉÂ±ÄÂª∫ËÆÆÊ≠£Âú®ÁîüÊàê‰∏≠ÔºåËØ∑Á®çÂêéÊü•Áúã';
                }
            }
            
            // ÂÖçË¥πÁâàÂíåBasicÁâàÂÜÖÂÆπÈôêÂà∂ - ÈúÄË¶ÅProfessionalÁâà
            if (result.userTier === 'FREE' || result.userTier === 'BASIC') {
                return truncateContent(content, 60) + getFreeVersionPrompt('layout');
            }
            
            return content;
        }

        // Êô∫ËÉΩÊèêÂèñË°åÂä®Âª∫ËÆÆ
        function getActionInfo(result) {
            console.log('üîç ÊèêÂèñË°åÂä®Âª∫ËÆÆ:', result);
            
            // ‰ºòÂÖà‰ªé‰ºòÂåñÊñπÊ°à‰∏≠ÊèêÂèñÁ´ãÂç≥Ë°åÂä®Âª∫ËÆÆ
            if (result.classifiedContent && result.classifiedContent.optimizationPlan) {
                const plan = result.classifiedContent.optimizationPlan;
                if (plan.immediate && plan.immediate.trim() && !plan.immediate.includes('immediate_start')) {
                    return formatTextWithBreaks(plan.immediate);
                }
            }
            
            // ‰ªéurgentActionsÊï∞ÁªÑÊàñÂ≠óÁ¨¶‰∏≤‰∏≠ÊèêÂèñ
            if (result.urgentActions) {
                let actions = '';
                if (Array.isArray(result.urgentActions)) {
                    // Â¶ÇÊûúÊòØÊï∞ÁªÑÔºåÂèñÂâç3Êù°Âπ∂ËøáÊª§ÊéâÂåÖÂê´Âç†‰ΩçÁ¨¶ÁöÑÂÜÖÂÆπ
                    actions = result.urgentActions
                        .filter(action => action && !action.includes('immediate_start') && !action.includes('ÂçáÁ∫ßÂà∞ËøõÈò∂Áâà'))
                        .slice(0, 3)
                        .join('Ôºõ');
                } else if (typeof result.urgentActions === 'string' && result.urgentActions.trim()) {
                    actions = result.urgentActions.replace(/immediate_start/g, '').trim();
                }
                
                if (actions) {
                    return formatTextWithBreaks(actions);
                }
            }
            
            // ‰ªéÂàÜÊûêÂÜÖÂÆπ‰∏≠ÊèêÂèñÊîπÂñÑÊé™ÊñΩ
            const analysis = result.analysis || '';
            const actionMatch = analysis.match(/„ÄêÂÖ∑‰ΩìÊîπÂñÑÊé™ÊñΩ„Äë(.*?)„Äê/s);
            if (actionMatch && actionMatch[1].trim()) {
                return formatTextWithBreaks(actionMatch[1]);
            }
            
            // Â§áÈÄâÊñπÊ°àÔºö‰ªérecommendations‰∏≠ÊèêÂèñÂπ∂Ê∏ÖÁêÜ
            if (result.recommendations) {
                let recs = '';
                if (Array.isArray(result.recommendations)) {
                    recs = result.recommendations
                        .filter(rec => rec && !rec.includes('ÂçáÁ∫ßÂà∞ËøõÈò∂Áâà'))
                        .join('Ôºõ');
                } else if (typeof result.recommendations === 'string') {
                    recs = cleanText(result.recommendations);
                    // ÁßªÈô§ÂçáÁ∫ßÁõ∏ÂÖ≥ÁöÑÂÜÖÂÆπ
                    recs = recs.replace(/ÔºõÂçáÁ∫ßÂà∞.*?ÁâàÂèØ.*?$/g, '').replace(/ÔºõÂçáÁ∫ßÂà∞.*?ËØ¶ÁªÜ.*?$/g, '');
                }
                
                if (recs && recs.trim()) {
                    const sentences = recs.split(/[.„ÄÇ;Ôºõ]/).filter(s => s.trim());
                    return sentences.slice(0, 3).join('Ôºõ');
                }
            }
            
            // Âü∫‰∫éÊàøÂ±ã‰ø°ÊÅØÁîüÊàêÂÖ∑‰ΩìÂª∫ËÆÆ
            const formData = result.formData || {};
            const direction = formData.direction || '';
            const houseType = formData.houseType || '';
            
            let specificAdvice = '';
            if (direction === 'Âçó' || direction === 'south') {
                specificAdvice = currentLang === 'en' ? 
                    'Keep the main entrance clean and bright; Place plants near the entrance; Ensure good lighting in the living room' :
                    '‰øùÊåÅÂÖ•Êà∑Èó®Ê∏ÖÊ¥ÅÊòé‰∫ÆÔºõÂú®ÂÖ•Âè£Â§ÑÊëÜÊîæÁªøÊ§çÔºõÁ°Æ‰øùÂÆ¢ÂéÖÂÖâÁ∫øÂÖÖË∂≥';
            } else if (direction === 'Âåó' || direction === 'north') {
                specificAdvice = currentLang === 'en' ? 
                    'Use warm lighting to enhance energy; Place metal decorations in the north; Keep the entrance area warm and inviting' :
                    '‰ΩøÁî®ÊöñËâ≤ÁÅØÂÖâÂ¢ûÂº∫Ê∞îÂú∫ÔºõÂú®ÂåóÊñπ‰ΩçÊëÜÊîæÈáëÂ±ûË£ÖÈ•∞Ôºõ‰øùÊåÅÂÖ•Âè£Âå∫ÂüüÊ∏©ÊöñÂÆú‰∫∫';
            } else {
                specificAdvice = currentLang === 'en' ? 
                    'Maintain clean and uncluttered spaces; Ensure proper ventilation throughout; Use appropriate lighting for each area' :
                    '‰øùÊåÅÁ©∫Èó¥Êï¥Ê¥ÅÊó†ÊùÇÁâ©ÔºõÁ°Æ‰øùÂÖ®Â±ãÈÄöÈ£éËâØÂ•ΩÔºõ‰∏∫ÂêÑÂå∫ÂüüÈÖçÁΩÆÈÄÇÂΩìÁÖßÊòé';
            }
            
            // ÂÖçË¥πÁâàÂíåBasicÁâàÂÜÖÂÆπÈôêÂà∂ - ÈúÄË¶ÅProfessionalÁâà
            if (result.userTier === 'FREE' || result.userTier === 'BASIC') {
                return truncateContent(specificAdvice, 70) + getFreeVersionPrompt('action');
            }
            
            return specificAdvice;
        }

        // Êô∫ËÉΩÊèêÂèñÊ≥®ÊÑè‰∫ãÈ°π
        function getNotesInfo(result) {
            let content = '';
            
            const classifiedContent = result.classifiedContent || {};
            if (classifiedContent.importantNotes) {
                content = formatTextWithBreaks(classifiedContent.importantNotes);
            } else {
                const analysis = result.analysis || '';
                const notesMatch = analysis.match(/„ÄêÊ≥®ÊÑè‰∫ãÈ°π„Äë(.*?)$/s);
                if (notesMatch) {
                    content = formatTextWithBreaks(notesMatch[1]);
                } else {
                    content = 'ÈáçË¶ÅÊèêÈÜí‰ø°ÊÅØÊ≠£Âú®Êï¥ÁêÜ‰∏≠';
                }
            }
            
            // ÂÖçË¥πÁâà„ÄÅBasicÁâà„ÄÅProfessionalÁâàÂÜÖÂÆπÈôêÂà∂ - ÈúÄË¶ÅMasterÁâà
            if (result.userTier !== 'MASTER') {
                return truncateContent(content, 50) + getFreeVersionPrompt('notes');
            }
            
            return content;
        }

        // ÈÇÆÁÆ±Êî∂ÈõÜÂäüËÉΩ
        function showEmailCollector(message) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                justify-content: center; align-items: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: var(--bg-card); padding: 30px; border-radius: 12px;
                max-width: 450px; width: 90%; text-align: center; border: 2px solid var(--primary-gold);
            `;
            
            content.innerHTML = `
                <div style="color: var(--primary-gold); font-size: 24px; margin-bottom: 15px;">üöÄ</div>
                <h3 style="color: var(--primary-gold); margin-bottom: 15px;">
                    ${currentLang === 'en' ? 'Get Early Access!' : 'Êä¢ÂÖà‰ΩìÈ™åÔºÅ'}
                </h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px; line-height: 1.5;">
                    ${message || (currentLang === 'en' ? 
                        'Be the first to know when paid plans are available!' : 
                        '‰ªòË¥πËÆ°Âàí‰∏äÁ∫øÊó∂Á¨¨‰∏ÄÊó∂Èó¥ÈÄöÁü•ÊÇ®ÔºÅ')}
                </p>
                <input type="email" id="email-collector-input" placeholder="${currentLang === 'en' ? 'Enter your email' : 'ËæìÂÖ•ÊÇ®ÁöÑÈÇÆÁÆ±'}" 
                       style="width: 100%; padding: 12px; border: 1px solid var(--primary-gold); border-radius: 6px; 
                              background: var(--bg-input); color: var(--text-primary); margin-bottom: 15px;">
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="collectEmail()" 
                            style="background: var(--primary-gold); color: var(--bg-primary); border: none; 
                                   padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        ${currentLang === 'en' ? 'Notify Me' : 'ÈÄöÁü•Êàë'}
                    </button>
                    <button onclick="this.closest('.email-collector-modal').remove()" 
                            style="background: transparent; color: var(--text-secondary); border: 1px solid var(--text-secondary); 
                                   padding: 12px 20px; border-radius: 6px; cursor: pointer;">
                        ${currentLang === 'en' ? 'Maybe Later' : 'Á®çÂêéÂÜçËØ¥'}
                    </button>
                </div>
            `;
            
            modal.className = 'email-collector-modal';
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        function collectEmail() {
            const email = document.getElementById('email-collector-input').value;
            if (!email || !email.includes('@')) {
                alert(currentLang === 'en' ? 'Please enter a valid email address' : 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈÇÆÁÆ±Âú∞ÂùÄ');
                return;
            }
            
            // ËÆ∞ÂΩïÈÇÆÁÆ±Âà∞Êú¨Âú∞Â≠òÂÇ®ÔºàÁîü‰∫ßÁéØÂ¢ÉÂ∫îÂèëÈÄÅÂà∞ÊúçÂä°Âô®Ôºâ
            const emails = JSON.parse(localStorage.getItem('collected_emails') || '[]');
            emails.push({
                email: email,
                timestamp: new Date().toISOString(),
                source: 'upgrade_prompt'
            });
            localStorage.setItem('collected_emails', JSON.stringify(emails));
            
            // ËøΩË∏™‰∫ã‰ª∂
            trackEvent('email_collected', { source: 'upgrade_prompt' });
            
            alert(currentLang === 'en' ? '‚úÖ Thanks! We\'ll notify you soon!' : '‚úÖ Ë∞¢Ë∞¢ÔºÅÊàë‰ª¨‰ºöÂ∞ΩÂø´ÈÄöÁü•ÊÇ®ÔºÅ');
            document.querySelector('.email-collector-modal').remove();
        }

        // ÁîüÊàêÂçáÁ∫ßÊåâÈíÆÂíå‰ª∑Ê†ºÊñπÊ°à
        function getUpgradeSection(result) {
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÂçáÁ∫ßÊèêÁ§∫Êï∞ÊçÆ
            if (!result.upgradePrompt || !result.upgradePrompt.show) {
                return '';
            }

            const upgrade = result.upgradePrompt;
            const isEn = currentLang === 'en';
            
            return `
                <div style="background: linear-gradient(135deg, rgba(218, 165, 32, 0.15), rgba(255, 204, 0, 0.15)); 
                           padding: 25px; border-radius: 12px; border: 2px solid var(--primary-gold); 
                           margin: 30px 0; position: relative;">
                    
                    <div style="position: absolute; top: -10px; left: 20px; background: var(--bg-card); 
                               padding: 5px 15px; border-radius: 20px; border: 2px solid var(--primary-gold);">
                        <span style="color: var(--primary-gold); font-weight: bold; font-size: 0.9rem;">
                            ${isEn ? 'üöÄ Upgrade Available' : 'üöÄ ÂçáÁ∫ßÂèØÁî®'}
                        </span>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h3 style="color: var(--primary-gold); margin-bottom: 15px; font-size: 1.3rem;">
                            ${upgrade.title || (isEn ? 'Upgrade to Premium Analysis' : 'ÂçáÁ∫ßÂà∞‰∏ì‰∏öÁâàÂàÜÊûê')}
                        </h3>
                        
                        <p style="color: var(--text-secondary); margin-bottom: 20px; line-height: 1.6;">
                            ${upgrade.description || (isEn ? 'Get detailed professional analysis with advanced features' : 'Ëé∑ÂæóËØ¶ÁªÜÁöÑ‰∏ì‰∏öÂàÜÊûêÂíåÈ´òÁ∫ßÂäüËÉΩ')}
                        </p>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; justify-content: center;">
                            <!-- Âü∫Á°ÄÁâà - ÂºïÂØºÁâàÊú¨ -->
                            <div style="background: var(--bg-card); padding: 18px; border-radius: 8px; flex: 1; min-width: 220px; max-width: 300px; border: 1px solid #666; opacity: 0.9;">
                                <h4 style="color: #888; margin-bottom: 10px; font-size: 1rem;">
                                    ‚≠ê ${isEn ? 'Basic ($3.99)' : 'Âü∫Á°ÄÁâà ($3.99)'}
                                </h4>
                                <ul style="color: var(--text-muted); line-height: 1.6; padding-left: 16px; margin: 0; font-size: 0.9rem;">
                                    <li>${isEn ? 'Limited analysis (200-300 words)' : 'ÁÆÄÂåñÂàÜÊûêÊä•Âëä (200-300Â≠ó)'}</li>
                                    <li>${isEn ? 'Basic layout suggestions' : 'Âü∫Á°ÄÂ∏ÉÂ±ÄÂª∫ËÆÆ'}</li>
                                    <li>${isEn ? 'Text export only' : '‰ªÖÊñáÊú¨ÂØºÂá∫'}</li>
                                    <li style="color: #666;">${isEn ? 'No image analysis' : '‰∏çÊîØÊåÅÂõæÁâáÂàÜÊûê'}</li>
                                    <li style="color: #666;">${isEn ? 'No timing guidance' : 'Êó†Êó∂Èó¥Êã©Âêâ'}</li>
                                </ul>
                            </div>
                            
                            <!-- ‰∏ì‰∏öÁâà - ‰∏ªÊé®ÁâàÊú¨ -->
                            <div style="background: var(--bg-card); padding: 20px; border-radius: 8px; flex: 1; min-width: 220px; max-width: 300px; border: 2px solid var(--primary-gold); position: relative; transform: scale(1.05);">
                                <div style="position: absolute; top: -10px; right: 10px; background: var(--primary-gold); color: var(--bg-primary); padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">
                                    ${isEn ? 'RECOMMENDED' : 'Êé®Ëçê'}
                                </div>
                                <h4 style="color: var(--primary-gold); margin-bottom: 10px;">
                                    üíé ${isEn ? 'Professional ($4.99)' : '‰∏ì‰∏öÁâà ($4.99)'}
                                </h4>
                                <ul style="color: var(--text-secondary); line-height: 1.8; padding-left: 20px; margin: 0;">
                                    <li>${isEn ? 'Detailed analysis (800-1200 words)' : 'ËØ¶ÁªÜÂàÜÊûêÊä•Âëä (800-1200Â≠ó)'}</li>
                                    <li>${isEn ? 'Advanced AI image recognition' : 'È´òÁ∫ßÊà∑ÂûãÂõæAIËØÜÂà´'}</li>
                                    <li>${isEn ? 'Personalized timing recommendations' : '‰∏™ÊÄßÂåñÊó∂Èó¥Âª∫ËÆÆÂíåÊã©Âêâ'}</li>
                                    <li>${isEn ? 'PDF + image export' : 'PDFÂíåÂõæÁâáÂØºÂá∫'}</li>
                                    <li>${isEn ? '30-day unlimited access' : '30Â§©ÂÜÖÊó†ÈôêÊ¨°Êü•Áúã'}</li>
                                </ul>
                            </div>
                            
                            <!-- Â§ßÂ∏àÁâà - È´òÁ∫ßÁâàÊú¨ -->
                            <div style="background: var(--bg-card); padding: 20px; border-radius: 8px; flex: 1; min-width: 220px; max-width: 300px; border: 1px solid #FFD700;">
                                <h4 style="color: #FFD700; margin-bottom: 10px;">
                                    üëë ${isEn ? 'Master ($29.99)' : 'Â§ßÂ∏àÁâà ($29.99)'}
                                </h4>
                                <ul style="color: var(--text-secondary); line-height: 1.8; padding-left: 20px; margin: 0;">
                                    <li>${isEn ? 'Everything in Professional' : 'ÂåÖÂê´‰∏ì‰∏öÁâàÊâÄÊúâÂäüËÉΩ'}</li>
                                    <li>${isEn ? 'Multi-angle image analysis' : 'Â§öËßíÂ∫¶ÂõæÁâáÊ∑±Â∫¶ÂàÜÊûê'}</li>
                                    <li>${isEn ? 'Advanced AI modeling & simulation' : 'È´òÁ∫ßAIÂª∫Ê®°ÂíåÊ®°Êãü'}</li>
                                    <li>${isEn ? 'Historical trend analysis' : 'ÂéÜÂè≤ËøêÂäøË∂ãÂäøÂàÜÊûê'}</li>
                                    <li>${isEn ? 'Lifetime report access' : 'ÁªàË∫´Êä•ÂëäËÆøÈóÆÊùÉÈôê'}</li>
                                    <li>${isEn ? 'Priority AI processing' : 'AI‰ºòÂÖàÂ§ÑÁêÜÈÄöÈÅì'}</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                            <!-- Âü∫Á°ÄÁâàÊåâÈíÆ - ‰ΩéË∞ÉÊ†∑Âºè -->
                            <button onclick="upgradeToTier('BASIC')" 
                                    style="background: linear-gradient(135deg, #666, #777); 
                                           color: white; border: none; padding: 12px 24px; 
                                           border-radius: 20px; font-size: 0.9rem; font-weight: normal; 
                                           cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(102, 102, 102, 0.3);"
                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 102, 102, 0.4)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 102, 102, 0.3)';">
                                ‚≠ê ${isEn ? 'Try Basic - $3.99' : 'Â∞ùËØïÂü∫Á°ÄÁâà - $3.99'}
                            </button>
                            
                            <!-- ‰∏ì‰∏öÁâàÊåâÈíÆ - ‰∏ªÊé®Ê†∑Âºè -->
                            <button onclick="upgradeToTier('PROFESSIONAL')" 
                                    style="background: linear-gradient(135deg, var(--primary-gold), #ffcc00); 
                                           color: var(--bg-primary); border: none; padding: 16px 32px; 
                                           border-radius: 25px; font-size: 1.1rem; font-weight: bold; 
                                           cursor: pointer; transition: all 0.3s ease; box-shadow: 0 6px 16px rgba(218, 165, 32, 0.4);
                                           transform: scale(1.05);"
                                    onmouseover="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 8px 24px rgba(218, 165, 32, 0.5)';"
                                    onmouseout="this.style.transform='translateY(0) scale(1.05)'; this.style.boxShadow='0 6px 16px rgba(218, 165, 32, 0.4)';">
                                üíé ${isEn ? 'Get Professional - $4.99' : 'ÈÄâÊã©‰∏ì‰∏öÁâà - $4.99'}
                            </button>
                            
                            <!-- Â§ßÂ∏àÁâàÊåâÈíÆ -->
                            <button onclick="upgradeToTier('MASTER')" 
                                    style="background: linear-gradient(135deg, #FFD700, #FFA500); 
                                           color: var(--bg-primary); border: none; padding: 15px 30px; 
                                           border-radius: 25px; font-size: 1rem; font-weight: bold; 
                                           cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 215, 0, 0.4)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255, 215, 0, 0.3)';">
                                üëë ${isEn ? 'Upgrade to Master - $29.99' : 'ÂçáÁ∫ßÂà∞Â§ßÂ∏àÁâà - $29.99'}
                            </button>
                        </div>
                        
                        <div style="text-align: center; margin-top: 15px;">
                            <p style="color: var(--text-muted); font-size: 0.85rem;">
                                ${isEn ? '‚ú® Secure payment ‚Ä¢ 30-day money-back guarantee' : '‚ú® ÂÆâÂÖ®ÊîØ‰ªò ‚Ä¢ 30Â§©ÈÄÄÊ¨æ‰øùËØÅ'}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Â§ÑÁêÜÂçáÁ∫ßÂà∞ÊåáÂÆöÁ≠âÁ∫ß
        function upgradeToTier(tier) {
            const isEn = currentLang === 'en';
            const tierNames = {
                'BASIC': isEn ? 'Basic' : 'Âü∫Á°ÄÁâà',
                'PROFESSIONAL': isEn ? 'Professional' : '‰∏ì‰∏öÁâà',
                'MASTER': isEn ? 'Master' : 'Â§ßÂ∏àÁâà'
            };
            const prices = {
                'BASIC': '$3.99',
                'PROFESSIONAL': '$4.99',
                'MASTER': '$29.99'
            };
            
            // ÁâπÂà´Â§ÑÁêÜÂü∫Á°ÄÁâà - ÊèêÁ§∫ÂçáÁ∫ßÂà∞‰∏ì‰∏öÁâà
            if (tier === 'BASIC') {
                const basicWarning = isEn ? 
                    `Are you sure you want the Basic version ($3.99)?\n\n‚ö†Ô∏è Limited features:\n‚Ä¢ Only 200-300 words analysis\n‚Ä¢ No image analysis\n‚Ä¢ Basic suggestions only\n\nüí° Professional version ($4.99) offers much better value with detailed analysis and image recognition!\n\nContinue with Basic?` :
                    `Á°ÆÂÆöÈÄâÊã©Âü∫Á°ÄÁâà ($3.99)Ôºü\n\n‚ö†Ô∏è ÂäüËÉΩÂèóÈôêÔºö\n‚Ä¢ ‰ªÖ200-300Â≠óÂàÜÊûê\n‚Ä¢ ‰∏çÊîØÊåÅÂõæÁâáÂàÜÊûê\n‚Ä¢ ‰ªÖÂü∫Á°ÄÂª∫ËÆÆ\n\nüí° ‰∏ì‰∏öÁâà ($4.99) ÊÄß‰ª∑ÊØîÊõ¥È´òÔºåÂåÖÂê´ËØ¶ÁªÜÂàÜÊûêÂíåÂõæÁâáËØÜÂà´ÔºÅ\n\n‰ªçË¶ÅÈÄâÊã©Âü∫Á°ÄÁâàÔºü`;
                
                if (!confirm(basicWarning)) {
                    // Â¶ÇÊûúÁî®Êà∑ÂèñÊ∂àÔºåËØ¢ÈóÆÊòØÂê¶Ë¶Å‰∏ì‰∏öÁâà
                    const upgradeConfirm = isEn ?
                        'Would you like to upgrade to Professional version ($4.99) instead?' :
                        'ÊòØÂê¶ÈÄâÊã©‰∏ì‰∏öÁâà ($4.99)Ôºü';
                    if (confirm(upgradeConfirm)) {
                        upgradeToTier('PROFESSIONAL');
                    }
                    return;
                }
            }
            
            // Áõ¥Êé•ÊòæÁ§∫ËÅîÁ≥ª‰ø°ÊÅØÔºå‰∏çÈúÄË¶ÅÁ°ÆËÆ§Ê°Ü
            const contactMsg = isEn ?
                `Upgrade to ${tierNames[tier]} (${prices[tier]})\n\nPayment system integration in progress.\n\nPlease contact support for manual upgrade:\nüìß Email: 15101623@qq.com\nüí¨ WeChat: Please email for WeChat ID\n\nüöÄ Coming Soon: Automatic payment system!` :
                `ÂçáÁ∫ßÂà∞${tierNames[tier]} (${prices[tier]})\n\nÊîØ‰ªòÁ≥ªÁªüÊ≠£Âú®ÈõÜÊàê‰∏≠„ÄÇ\n\nËØ∑ËÅîÁ≥ªÂÆ¢ÊúçËøõË°åÊâãÂä®ÂçáÁ∫ßÔºö\nüìß ÈÇÆÁÆ±Ôºö15101623@qq.com\nüí¨ ÂæÆ‰ø°ÔºöËØ∑ÈÇÆ‰ª∂ËÅîÁ≥ªËé∑ÂèñÂæÆ‰ø°Âè∑\n\nüöÄ Coming Soon: Ëá™Âä®ÊîØ‰ªòÁ≥ªÁªüÂç≥Â∞Ü‰∏äÁ∫øÔºÅ`;
                
                // ÂàõÂª∫Êõ¥ÂèãÂ•ΩÁöÑÂºπÁ™ó
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.8); z-index: 10000;
                    display: flex; justify-content: center; align-items: center;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
                        padding: 30px; border-radius: 15px; max-width: 450px; 
                        color: #f4f4f4; text-align: center; border: 2px solid #DAA520;
                        box-shadow: 0 10px 30px rgba(218, 165, 32, 0.3);
                    ">
                        <h3 style="color: #DAA520; margin-bottom: 20px;">
                            ${isEn ? 'üöÄ Coming Soon!' : 'üöÄ Âç≥Â∞ÜÊé®Âá∫ÔºÅ'}
                        </h3>
                        <p style="line-height: 1.6; margin-bottom: 20px; white-space: pre-line;">
                            ${contactMsg}
                        </p>
                        
                        <div style="margin: 20px 0; padding: 15px; background: rgba(218, 165, 32, 0.1); border-radius: 10px; text-align: left;">
                            <p style="margin-bottom: 10px; font-weight: bold; color: #DAA520;">
                                ${isEn ? 'üìß Get notified when payment is ready:' : 'üìß ÊîØ‰ªòÁ≥ªÁªü‰∏äÁ∫øÊó∂ÈÄöÁü•ÊÇ®Ôºö'}
                            </p>
                            <input type="email" id="upgrade-email" placeholder="${isEn ? 'Your email address' : 'ÊÇ®ÁöÑÈÇÆÁÆ±Âú∞ÂùÄ'}" style="
                                width: 100%; padding: 8px; border: 1px solid #DAA520; 
                                border-radius: 5px; background: #2d2d2d; color: #f4f4f4;
                                margin-bottom: 10px;
                            ">
                            <p style="font-size: 12px; color: #999; margin: 0;">
                                ${isEn ? 'Optional - We\'ll email you when automatic payment is available' : 'ÂèØÈÄâ - Ëá™Âä®ÊîØ‰ªò‰∏äÁ∫øÊó∂Êàë‰ª¨‰ºöÈÇÆ‰ª∂ÈÄöÁü•ÊÇ®'}
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="saveEmailAndClose()" style="
                                background: linear-gradient(45deg, #DAA520, #B8860B);
                                color: white; border: none; padding: 10px 20px;
                                border-radius: 25px; cursor: pointer; font-weight: bold;
                            ">
                                ${isEn ? 'Save & Close' : '‰øùÂ≠òÂπ∂ÂÖ≥Èó≠'}
                            </button>
                            <button onclick="this.closest('div').parentElement.remove()" style="
                                background: #666; color: white; border: none; padding: 10px 20px;
                                border-radius: 25px; cursor: pointer;
                            ">
                                ${isEn ? 'Skip' : 'Ë∑≥Ëøá'}
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Ê∑ªÂä†ÂÖ®Â±ÄÂáΩÊï∞
                window.saveEmailAndClose = function() {
                    const email = document.getElementById('upgrade-email').value.trim();
                    
                    if (email) {
                        // ÁÆÄÂçïÈÇÆÁÆ±È™åËØÅ
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(email)) {
                            alert(isEn ? 'Please enter a valid email address' : 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈÇÆÁÆ±Âú∞ÂùÄ');
                            return;
                        }
                        
                        // ‰øùÂ≠òÂà∞localStorageÔºàÂèØ‰ª•ÂêéÁª≠Êîπ‰∏∫ÂèëÈÄÅÂà∞ÊúçÂä°Âô®Ôºâ
                        const savedEmails = JSON.parse(localStorage.getItem('upgrade_emails') || '[]');
                        if (!savedEmails.includes(email)) {
                            savedEmails.push(email);
                            localStorage.setItem('upgrade_emails', JSON.stringify(savedEmails));
                        }
                        
                        // ËÆ∞ÂΩïÂçáÁ∫ßÊÑèÂêë
                        const upgradeIntentions = JSON.parse(localStorage.getItem('upgrade_intentions') || '[]');
                        upgradeIntentions.push({
                            email: email,
                            tier: tier,
                            price: prices[tier],
                            timestamp: new Date().toISOString()
                        });
                        localStorage.setItem('upgrade_intentions', JSON.stringify(upgradeIntentions));
                        
                        console.log('ÂçáÁ∫ßÊÑèÂêëÂ∑≤ËÆ∞ÂΩï:', { email, tier, price: prices[tier] });
                    }
                    
                    // ÂÖ≥Èó≠ÂºπÁ™ó
                    modal.remove();
                    
                    // ÊòæÁ§∫ÊÑüË∞¢‰ø°ÊÅØ
                    if (email) {
                        const thankYouMsg = isEn ?
                            '‚úÖ Thank you! We\'ll notify you when automatic payment is available.' :
                            '‚úÖ Ë∞¢Ë∞¢ÔºÅÊîØ‰ªòÁ≥ªÁªü‰∏äÁ∫øÊó∂Êàë‰ª¨‰ºöÈÄöÁü•ÊÇ®„ÄÇ';
                        
                        // ÁÆÄÂçïÁöÑtoastÊèêÁ§∫
                        const toast = document.createElement('div');
                        toast.style.cssText = `
                            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                            background: linear-gradient(45deg, #DAA520, #B8860B); color: white;
                            padding: 15px 25px; border-radius: 25px; z-index: 10001;
                            font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                        `;
                        toast.textContent = thankYouMsg;
                        document.body.appendChild(toast);
                        
                        setTimeout(() => toast.remove(), 3000);
                    }
                };
                
                // ÂÆûÈôÖÈÉ®ÁΩ≤Êó∂ÂèØ‰ª•ÊõøÊç¢‰∏∫:
                // window.location.href = `/payment?tier=${tier}&price=${prices[tier]}`;
        }

        // Ê∏ÖÁêÜÊñáÊú¨Ê†ºÂºè
        function cleanText(text) {
            // Á°Æ‰øùËæìÂÖ•ÊòØÂ≠óÁ¨¶‰∏≤
            if (typeof text !== 'string') {
                return String(text || '');
            }
            
            return text
                .replace(/^[\]„Äê„Äë\s]+/, '') // ÁßªÈô§ÂºÄÂ§¥ÁöÑ„Äë„ÄêÁ¨¶Âè∑
                .replace(/[\]„Äê„Äë\s]*$/, '') // ÁßªÈô§ÁªìÂ∞æÁöÑ„Äë„ÄêÁ¨¶Âè∑
                .replace(/\n\n+/g, '\n') // ÂêàÂπ∂Â§ö‰∏™Êç¢Ë°å
                .trim();
        }

        // Ê†ºÂºèÂåñÊñáÊú¨‰∏∫ÂàÜÊÆµÊòæÁ§∫ÔºàÊ∑ªÂä†Êç¢Ë°åÂíåÂàÜÊÆµÔºâ
        function formatTextWithBreaks(text) {
            if (!text || typeof text !== 'string') {
                return '';
            }
            
            let formatted = cleanText(text);
            
            // Êô∫ËÉΩÂàÜÊÆµÂπ∂Ê∑ªÂä†È°πÁõÆÁ¨¶Âè∑
            const sentences = formatted
                .split(/[Ôºõ;„ÄÇÔºÅÔºü]/g)  // ÊåâÊ†áÁÇπÂàÜÂâ≤
                .filter(sentence => sentence.trim().length > 3)  // ËøáÊª§Áü≠Âè•
                .map(sentence => sentence.trim())  // ÂéªÈô§Á©∫Ê†º
                .filter(sentence => sentence);  // ÁßªÈô§Á©∫Âè•Â≠ê
            
            if (sentences.length > 1) {
                // Â§öÂè•Êó∂ÔºåÊØèÂè•ÂâçÂä†È°πÁõÆÁ¨¶Âè∑
                formatted = sentences
                    .map((sentence, index) => {
                        // ÈÄâÊã©ÂêàÈÄÇÁöÑÈ°πÁõÆÁ¨¶Âè∑
                        const bullets = ['üîπ', 'üî∏', '‚≠ê', 'üí´', 'üåü'];
                        const bullet = bullets[index % bullets.length];
                        return `${bullet} ${sentence}`;
                    })
                    .join('<br><br>');
            } else {
                // ÂçïÂè•Êó∂ÔºåÊåâÂàÜÂè∑„ÄÅÂè•Âè∑ÂàÜÊÆµ
                formatted = formatted
                    .replace(/([„ÄÇÔºÅÔºüÔºõ])\s*/g, '$1<br><br>')
                    .replace(/([Ôºö:])\s*/g, '$1<br>')
                    .replace(/(\d+[\.„ÄÅ])/g, '<br>‚Ä¢ $1')
                    .replace(/([‚ë†‚ë°‚ë¢‚ë£‚ë§‚ë•‚ë¶‚ëß‚ë®‚ë©])/g, '<br>$1')
                    .replace(/^<br>/, '')
                    .trim();
            }
            
            // Ê∏ÖÁêÜÂ§ö‰ΩôÁöÑÊç¢Ë°å
            formatted = formatted
                .replace(/<br><br><br>/g, '<br><br>')
                .replace(/^<br>/, '')
                .trim();
                
            return formatted;
        }

        // ÁÆ°ÁêÜÈù¢ÊùøÂäüËÉΩ
        let adminPanelVisible = false;

        // ÁõëÂê¨ÁâπÊÆäÊåâÈîÆÁªÑÂêàÊâìÂºÄÁÆ°ÁêÜÈù¢Êùø (Ctrl+Shift+A)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                e.preventDefault();
                toggleAdminPanel();
            }
        });

        // ÂÖ≥Èó≠ÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('close-admin').addEventListener('click', () => {
            closeAdminPanel();
        });

        // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
        document.getElementById('admin-panel').addEventListener('click', (e) => {
            if (e.target.id === 'admin-panel') {
                closeAdminPanel();
            }
        });

        // ËøõÂ∫¶ÊåáÁ§∫Âô®ÊéßÂà∂ÂáΩÊï∞
        let progressInterval;
        
        function showProgressIndicator() {
            console.log('üöÄ ÊòæÁ§∫ËøõÂ∫¶ÊåáÁ§∫Âô®');
            
            // ÈöêËóèÁªìÊûúÂå∫Âüü
            document.getElementById('result-section').style.display = 'none';
            
            // ÊòæÁ§∫ËøõÂ∫¶ÂÆπÂô®
            const progressContainer = document.getElementById('progress-container');
            progressContainer.style.display = 'block';
            
            // ÊªöÂä®Âà∞ËøõÂ∫¶ÊåáÁ§∫Âô®
            progressContainer.scrollIntoView({ behavior: 'smooth' });
            
            // ÈáçÁΩÆËøõÂ∫¶Áä∂ÊÄÅ
            resetProgressState();
            
            // ÂºÄÂßãËøõÂ∫¶Âä®Áîª
            startProgressAnimation();
        }
        
        function hideProgressIndicator() {
            console.log('üéØ ÈöêËóèËøõÂ∫¶ÊåáÁ§∫Âô®');
            
            // ÂÅúÊ≠¢ËøõÂ∫¶Âä®Áîª
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            
            // ÈöêËóèËøõÂ∫¶ÂÆπÂô®
            document.getElementById('progress-container').style.display = 'none';
        }
        
        function resetProgressState() {
            // ÈáçÁΩÆËøõÂ∫¶Êù°
            document.getElementById('progress-fill').style.width = '0%';
            
            // ÈáçÁΩÆÊâÄÊúâÊ≠•È™§Áä∂ÊÄÅ
            document.querySelectorAll('.progress-step').forEach(step => {
                step.classList.remove('active');
            });
            
            // ÊøÄÊ¥ªÁ¨¨‰∏ÄÊ≠•
            document.getElementById('step-1').classList.add('active');
        }
        
        function startProgressAnimation() {
            const progressFill = document.getElementById('progress-fill');
            const steps = ['step-1', 'step-2', 'step-3', 'step-4'];
            const messages = [
                { zh: 'ÂàÜÊûêÊàøÂ±ãÂü∫Á°ÄÊï∞ÊçÆ...', en: 'Analyzing property data...' },
                { zh: 'ËÆ°ÁÆóÊñπ‰ΩçÂíåÊúùÂêëÂΩ±Âìç...', en: 'Calculating orientation effects...' },
                { zh: 'ËØÑ‰º∞Â∏ÉÂ±ÄÂíåÈ£éÊ∞¥Ê†ºÂ±Ä...', en: 'Evaluating layout and Feng Shui patterns...' },
                { zh: 'ÁîüÊàê‰∏ì‰∏öÂª∫ËÆÆÊñπÊ°à...', en: 'Generating professional recommendations...' }
            ];
            
            let currentStep = 0;
            let progress = 0;
            
            progressInterval = setInterval(() => {
                // Êõ¥Êñ∞ËøõÂ∫¶Êù°ÔºàÊ®°ÊãüËøõÂ∫¶ÔºåÂÆûÈôÖ‰ºöÊ†πÊçÆAIÂìçÂ∫îÊó∂Èó¥Ë∞ÉÊï¥Ôºâ
                progress += Math.random() * 3 + 2; // ÊØèÊ¨°Â¢ûÂä†2-5%
                if (progress > 100) progress = 100;
                
                progressFill.style.width = progress + '%';
                
                // Êõ¥Êñ∞Ê≠•È™§Áä∂ÊÄÅÔºàÊØè25%ÂàáÊç¢‰∏ÄÊ≠•Ôºâ
                const stepIndex = Math.min(Math.floor(progress / 25), 3);
                if (stepIndex > currentStep) {
                    // ÁßªÈô§ÂΩìÂâçÊ≠•È™§ÁöÑactiveÁä∂ÊÄÅ
                    if (currentStep < steps.length) {
                        document.getElementById(steps[currentStep]).classList.remove('active');
                    }
                    
                    currentStep = stepIndex;
                    
                    // ÊøÄÊ¥ªÊñ∞Ê≠•È™§
                    if (currentStep < steps.length) {
                        document.getElementById(steps[currentStep]).classList.add('active');
                    }
                }
                
                // Êõ¥Êñ∞Ê∂àÊÅØ
                if (currentStep < messages.length) {
                    const messageEl = document.getElementById('progress-message');
                    messageEl.textContent = messages[currentStep][currentLang];
                }
                
                // Â¶ÇÊûúËææÂà∞95%Â∞±ÂÅúÊ≠¢Ëá™Âä®Â¢ûÈïøÔºåÁ≠âÂæÖÂÆûÈôÖÂÆåÊàê
                if (progress >= 95) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                
            }, 200); // ÊØè200msÊõ¥Êñ∞‰∏ÄÊ¨°
        }

        // ÂØºÂá∫ÂäüËÉΩÂÆûÁé∞
        function exportToPDF() {
            console.log('üìÑ ÂºÄÂßãÂØºÂá∫PDF');
            
            if (!window.lastAnalysisResult) {
                alert(currentLang === 'en' ? 'No analysis result to export' : 'Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÂàÜÊûêÁªìÊûú');
                return;
            }
            
            // Á¶ÅÁî®ÊåâÈíÆ
            setExportButtonsState(true);
            
            try {
                // Âä®ÊÄÅÂä†ËΩΩjsPDFÂ∫ì
                loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', () => {
                    generatePDF();
                });
            } catch (error) {
                console.error('PDFÂØºÂá∫Â§±Ë¥•:', error);
                alert(currentLang === 'en' ? 'PDF export failed' : 'PDFÂØºÂá∫Â§±Ë¥•');
                setExportButtonsState(false);
            }
        }
        
        function exportToImage() {
            console.log('üñºÔ∏è ÂºÄÂßãÂØºÂá∫ÂõæÁâá');
            
            if (!window.lastAnalysisResult) {
                alert(currentLang === 'en' ? 'No analysis result to export' : 'Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÂàÜÊûêÁªìÊûú');
                return;
            }
            
            setExportButtonsState(true);
            
            try {
                // Âä®ÊÄÅÂä†ËΩΩhtml2canvasÂ∫ì
                loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js', () => {
                    generateImage();
                });
            } catch (error) {
                console.error('ÂõæÁâáÂØºÂá∫Â§±Ë¥•:', error);
                alert(currentLang === 'en' ? 'Image export failed' : 'ÂõæÁâáÂØºÂá∫Â§±Ë¥•');
                setExportButtonsState(false);
            }
        }
        
        function exportToText() {
            console.log('üìù ÂºÄÂßãÂØºÂá∫ÊñáÊú¨');
            
            if (!window.lastAnalysisResult) {
                alert(currentLang === 'en' ? 'No analysis result to export' : 'Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÂàÜÊûêÁªìÊûú');
                return;
            }
            
            const result = window.lastAnalysisResult;
            const timestamp = new Date().toLocaleString(currentLang === 'en' ? 'en-US' : 'zh-CN');
            
            let textContent = '';
            
            if (currentLang === 'en') {
                textContent = `AI Feng Shui Analysis Report
Generated on: ${timestamp}

=== OVERALL SCORE ===
${result.score || 'N/A'} Points - ${result.gradeInfo?.name || 'Analysis Complete'}

=== ORIENTATION ANALYSIS ===
${getPlainText(getDirectionInfo(result))}

=== LAYOUT SUGGESTIONS ===
${getPlainText(getLayoutInfo(result))}

=== IMMEDIATE IMPROVEMENTS ===
${getPlainText(getActionInfo(result))}

=== IMPORTANT NOTES ===
${getPlainText(getNotesInfo(result))}

---
Generated by AI Feng Shui Master
This analysis incorporates dynamic factors and should be used as reference only.`;
            } else {
                textContent = `AIÈ£éÊ∞¥ÂàÜÊûêÊä•Âëä
ÁîüÊàêÊó∂Èó¥Ôºö${timestamp}

=== ÁªºÂêàËØÑÂàÜ ===
${result.score || 'Êó†'}ÂàÜ - ${result.gradeInfo?.name || 'ÂàÜÊûêÂÆåÊàê'}

=== ÊúùÂêëÂàÜÊûê ===
${getPlainText(getDirectionInfo(result))}

=== Â∏ÉÂ±ÄÂª∫ËÆÆ ===
${getPlainText(getLayoutInfo(result))}

=== Á´ãÂç≥ÊîπÂñÑÂª∫ËÆÆ ===
${getPlainText(getActionInfo(result))}

=== ÈáçË¶ÅÊèêÈÜí ===
${getPlainText(getNotesInfo(result))}

---
Áî±AIÈ£éÊ∞¥Â§ßÂ∏àÁîüÊàê
Ê≠§ÂàÜÊûêÁªìÂêàÂä®ÊÄÅÂõ†Á¥†Ôºå‰ªÖ‰æõÂèÇËÄÉ‰ΩøÁî®„ÄÇ`;
            }
            
            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `È£éÊ∞¥ÂàÜÊûêÊä•Âëä_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            console.log('‚úÖ ÊñáÊú¨ÂØºÂá∫ÂÆåÊàê');
        }
        
        function shareResult() {
            console.log('üîó ÂºÄÂßãÂàÜ‰∫´ÁªìÊûú');
            
            if (!window.lastAnalysisResult) {
                alert(currentLang === 'en' ? 'No analysis result to share' : 'Ê≤°ÊúâÂèØÂàÜ‰∫´ÁöÑÂàÜÊûêÁªìÊûú');
                return;
            }
            
            const result = window.lastAnalysisResult;
            const shareText = currentLang === 'en' ? 
                `My Feng Shui Analysis Result: ${result.score || 'N/A'} Points - ${result.gradeInfo?.name || 'Analysis Complete'}` :
                `ÊàëÁöÑÈ£éÊ∞¥ÂàÜÊûêÁªìÊûúÔºö${result.score || 'Êó†'}ÂàÜ - ${result.gradeInfo?.name || 'ÂàÜÊûêÂÆåÊàê'}`;
            
            const shareUrl = window.location.href;
            
            if (navigator.share) {
                // ‰ΩøÁî®Web Share APIÔºàÁßªÂä®Á´ØÔºâ
                navigator.share({
                    title: currentLang === 'en' ? 'AI Feng Shui Analysis' : 'AIÈ£éÊ∞¥ÂàÜÊûêÁªìÊûú',
                    text: shareText,
                    url: shareUrl
                }).then(() => {
                    console.log('‚úÖ ÂàÜ‰∫´ÊàêÂäü');
                }).catch((error) => {
                    console.log('ÂàÜ‰∫´Ë¢´ÂèñÊ∂àÊàñÂ§±Ë¥•:', error);
                    fallbackShare(shareText, shareUrl);
                });
            } else {
                fallbackShare(shareText, shareUrl);
            }
        }
        
        // ËæÖÂä©ÂáΩÊï∞
        function setExportButtonsState(disabled) {
            document.querySelectorAll('.export-btn').forEach(btn => {
                btn.disabled = disabled;
                if (disabled) {
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                } else {
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
        }
        
        function loadScript(src, callback) {
            if (document.querySelector(`script[src="${src}"]`)) {
                callback();
                return;
            }
            
            const script = document.createElement('script');
            script.src = src;
            script.onload = callback;
            script.onerror = () => {
                throw new Error(`Failed to load script: ${src}`);
            };
            document.head.appendChild(script);
        }
        
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // ËÆæÁΩÆ‰∏≠ÊñáÂ≠ó‰ΩìÊîØÊåÅ
            doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
            doc.setFont('Roboto');
            
            const result = window.lastAnalysisResult;
            const timestamp = new Date().toLocaleString(currentLang === 'en' ? 'en-US' : 'zh-CN');
            
            let yPos = 20;
            const lineHeight = 7;
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;
            const maxWidth = pageWidth - 2 * margin;
            
            // Ê†áÈ¢ò
            doc.setFontSize(18);
            const title = currentLang === 'en' ? 'AI Feng Shui Analysis Report' : 'AIÈ£éÊ∞¥ÂàÜÊûêÊä•Âëä';
            doc.text(title, pageWidth / 2, yPos, { align: 'center' });
            yPos += lineHeight * 2;
            
            // ÁîüÊàêÊó∂Èó¥
            doc.setFontSize(10);
            const timeText = (currentLang === 'en' ? 'Generated on: ' : 'ÁîüÊàêÊó∂Èó¥Ôºö') + timestamp;
            doc.text(timeText, pageWidth / 2, yPos, { align: 'center' });
            yPos += lineHeight * 2;
            
            // ËØÑÂàÜ
            doc.setFontSize(14);
            const scoreTitle = currentLang === 'en' ? 'OVERALL SCORE' : 'ÁªºÂêàËØÑÂàÜ';
            doc.text(scoreTitle, margin, yPos);
            yPos += lineHeight;
            
            doc.setFontSize(12);
            const scoreText = `${result.score || 'N/A'} ${currentLang === 'en' ? 'Points' : 'ÂàÜ'} - ${result.gradeInfo?.name || (currentLang === 'en' ? 'Analysis Complete' : 'ÂàÜÊûêÂÆåÊàê')}`;
            doc.text(scoreText, margin, yPos);
            yPos += lineHeight * 2;
            
            // ÂÖ∂‰ªñsections...ÔºàÁÆÄÂåñÁâàÊú¨ÔºåÂÆûÈôÖ‰ºöÂåÖÂê´ÊâÄÊúâÂÜÖÂÆπÔºâ
            const sections = [
                { title: currentLang === 'en' ? 'ORIENTATION ANALYSIS' : 'ÊúùÂêëÂàÜÊûê', content: getPlainText(getDirectionInfo(result)) },
                { title: currentLang === 'en' ? 'LAYOUT SUGGESTIONS' : 'Â∏ÉÂ±ÄÂª∫ËÆÆ', content: getPlainText(getLayoutInfo(result)) },
                { title: currentLang === 'en' ? 'IMMEDIATE IMPROVEMENTS' : 'Á´ãÂç≥ÊîπÂñÑÂª∫ËÆÆ', content: getPlainText(getActionInfo(result)) }
            ];
            
            sections.forEach(section => {
                doc.setFontSize(14);
                doc.text(section.title, margin, yPos);
                yPos += lineHeight;
                
                doc.setFontSize(10);
                const lines = doc.splitTextToSize(section.content.substring(0, 500) + '...', maxWidth);
                lines.forEach(line => {
                    if (yPos > 270) { // Êé•ËøëÈ°µÈù¢Â∫ïÈÉ®Êó∂Êç¢È°µ
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(line, margin, yPos);
                    yPos += lineHeight;
                });
                yPos += lineHeight;
            });
            
            // ‰øùÂ≠òPDF
            const filename = `È£éÊ∞¥ÂàÜÊûêÊä•Âëä_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
            
            setExportButtonsState(false);
            console.log('‚úÖ PDFÂØºÂá∫ÂÆåÊàê');
        }
        
        function generateImage() {
            // Ëé∑ÂèñÊï¥‰∏™ÁªìÊûúÂå∫ÂüüÔºåËÄå‰∏ç‰ªÖ‰ªÖÊòØÂÜÖÂÆπÂå∫Âüü
            const resultSection = document.getElementById('result-section');
            
            // ‰∏¥Êó∂ÈöêËóèÂØºÂá∫ÊåâÈíÆ‰ª•ÈÅøÂÖçÂú®ÂõæÁâá‰∏≠ÊòæÁ§∫
            const exportControls = document.getElementById('export-controls');
            const originalDisplay = exportControls.style.display;
            exportControls.style.display = 'none';
            
            // Á°Æ‰øùÊâÄÊúâÂÜÖÂÆπÂèØËßÅ
            const originalMaxHeight = resultSection.style.maxHeight;
            resultSection.style.maxHeight = 'none';
            
            html2canvas(resultSection, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#0F1419', // ‰ΩøÁî®ÁΩëÁ´ôÁöÑËÉåÊôØËâ≤
                width: resultSection.scrollWidth,
                height: resultSection.scrollHeight,
                scrollX: 0,
                scrollY: 0,
                allowTaint: true,
                foreignObjectRendering: true
            }).then(canvas => {
                // ÊÅ¢Â§çÂØºÂá∫ÊåâÈíÆÊòæÁ§∫
                exportControls.style.display = originalDisplay;
                resultSection.style.maxHeight = originalMaxHeight;
                
                // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                const link = document.createElement('a');
                link.download = `AIÈ£éÊ∞¥ÂàÜÊûêÊä•Âëä_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setExportButtonsState(false);
                console.log('‚úÖ ÂõæÁâáÂØºÂá∫ÂÆåÊàê');
            }).catch(error => {
                // ÊÅ¢Â§çÊòæÁ§∫Áä∂ÊÄÅ
                exportControls.style.display = originalDisplay;
                resultSection.style.maxHeight = originalMaxHeight;
                
                console.error('ÂõæÁâáÁîüÊàêÂ§±Ë¥•:', error);
                alert(currentLang === 'en' ? 'Image generation failed. Please try PDF export instead.' : 'ÂõæÁâáÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Â∞ùËØïPDFÂØºÂá∫');
                setExportButtonsState(false);
            });
        }
        
        function fallbackShare(text, url) {
            // Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
            if (navigator.clipboard) {
                const shareContent = `${text}\n${url}`;
                navigator.clipboard.writeText(shareContent).then(() => {
                    alert(currentLang === 'en' ? 'Content copied to clipboard!' : 'ÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ');
                }).catch(() => {
                    showShareModal(text, url);
                });
            } else {
                showShareModal(text, url);
            }
        }
        
        function showShareModal(text, url) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10001; 
                display: flex; align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: var(--bg-card); padding: 30px; border-radius: 12px; 
                max-width: 500px; width: 90%; text-align: center;
            `;
            
            content.innerHTML = `
                <h3 style="color: var(--primary-gold); margin-bottom: 20px;">
                    ${currentLang === 'en' ? 'Share Analysis Result' : 'ÂàÜ‰∫´ÂàÜÊûêÁªìÊûú'}
                </h3>
                <textarea readonly style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: none;">${text}\n${url}</textarea>
                <div style="margin-top: 20px;">
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                            style="background: var(--primary-gold); color: var(--bg-primary); border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                        ${currentLang === 'en' ? 'Close' : 'ÂÖ≥Èó≠'}
                    </button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // ÈÄâ‰∏≠ÊñáÊú¨
            const textarea = content.querySelector('textarea');
            textarea.select();
        }
        
        function getPlainText(htmlText) {
            const div = document.createElement('div');
            div.innerHTML = htmlText;
            return div.textContent || div.innerText || '';
        }

        function toggleAdminPanel() {
            if (adminPanelVisible) {
                closeAdminPanel();
            } else {
                openAdminPanel();
            }
        }

        function openAdminPanel() {
            adminPanelVisible = true;
            document.getElementById('admin-panel').style.display = 'block';
            document.body.style.overflow = 'hidden';
            loadAdminData();
        }

        function closeAdminPanel() {
            adminPanelVisible = false;
            document.getElementById('admin-panel').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        async function loadAdminData() {
            try {
                // Âπ∂Ë°åËé∑ÂèñÂ§ö‰∏™Êï∞ÊçÆÊ∫ê
                const [systemStats, aiStats, analytics, parsingStats] = await Promise.all([
                    fetch('/api/system-stats').then(r => r.json()),
                    fetch('/api/ai-stats').then(r => r.json()),
                    fetch('/api/analytics').then(r => r.json()),
                    fetch('/api/parsing-stats').then(r => r.json())
                ]);

                updateTodayStats(analytics.data);
                updateAIPerformance(aiStats.data, parsingStats.data);
                updateUserDistribution(analytics.data);
                updateSystemHealth(systemStats.data);
                updateAIComparison(aiStats.data);
                updateUsageTrends(analytics.data);
                updateRecentFeedback(analytics.data.feedback);

            } catch (error) {
                console.error('Âä†ËΩΩÁÆ°ÁêÜÊï∞ÊçÆÂ§±Ë¥•:', error);
                showErrorState();
            }
        }

        function updateTodayStats(data) {
            const todayStats = document.getElementById('today-stats');
            todayStats.innerHTML = `
                <div class="stat-item">
                    <span>ÊÄªÂàÜÊûêÊ¨°Êï∞</span>
                    <span class="stat-value">${data.today.totalAnalyses || 0}</span>
                </div>
                <div class="stat-item">
                    <span>Áã¨Á´ãÁî®Êà∑</span>
                    <span class="stat-value">${data.today.uniqueUsers || 0}</span>
                </div>
                <div class="stat-item">
                    <span>ÂõæÁâá‰∏ä‰º†</span>
                    <span class="stat-value">${data.today.uploadTypes.withImage || 0}</span>
                </div>
                <div class="stat-item">
                    <span>Á∫ØÊñáÊú¨ÂàÜÊûê</span>
                    <span class="stat-value">${data.today.uploadTypes.textOnly || 0}</span>
                </div>
            `;
        }

        function updateAIPerformance(data, parsingData) {
            const aiPerf = document.getElementById('ai-performance');
            const deepseekRate = data.deepseek.calls > 0 ? ((data.deepseek.calls - data.deepseek.errors) / data.deepseek.calls * 100) : 0;
            const qwen3Rate = data.qwen3.calls > 0 ? ((data.qwen3.calls - data.qwen3.errors) / data.qwen3.calls * 100) : 0;

            aiPerf.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>DeepSeekÊàêÂäüÁéá</span>
                        <span class="stat-value">${deepseekRate.toFixed(1)}%</span>
                    </div>
                    <div class="performance-bar">
                        <div class="performance-fill" style="width: ${deepseekRate}%"></div>
                    </div>
                </div>
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Qwen3ÊàêÂäüÁéá</span>
                        <span class="stat-value">${qwen3Rate.toFixed(1)}%</span>
                    </div>
                    <div class="performance-bar">
                        <div class="performance-fill" style="width: ${qwen3Rate}%"></div>
                    </div>
                </div>
                ${parsingData ? `
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Ëß£ÊûêÊàêÂäüÁéá</span>
                        <span class="stat-value">${parsingData.successRate}%</span>
                    </div>
                    <div class="performance-bar">
                        <div class="performance-fill" style="width: ${parsingData.successRate}%"></div>
                    </div>
                </div>
                <div class="stat-item">
                    <span>Ê†áËÆ∞Ëß£ÊûêÁéá</span>
                    <span class="stat-value">${parsingData.markupSuccessRate}%</span>
                </div>
                ` : ''}
            `;
        }

        function updateUserDistribution(data) {
            const userDist = document.getElementById('user-distribution');
            const regions = data.today.userRegions || {};
            let content = '';

            Object.entries(regions).forEach(([region, count]) => {
                content += `
                    <div class="stat-item">
                        <span>${region || 'Êú™Áü•'}</span>
                        <span class="stat-value">${count}</span>
                    </div>
                `;
            });

            userDist.innerHTML = content || '<div style="color: #666;">ÊöÇÊó†Êï∞ÊçÆ</div>';
        }

        function updateSystemHealth(data) {
            const health = document.getElementById('system-health');
            const uptime = Math.floor(data.server.uptime / 3600);
            const memoryUsed = Math.round(data.server.memory.heapUsed / 1024 / 1024);

            health.innerHTML = `
                <div class="stat-item">
                    <span>ËøêË°åÊó∂Èó¥</span>
                    <span class="stat-value">${uptime}Â∞èÊó∂</span>
                </div>
                <div class="stat-item">
                    <span>ÂÜÖÂ≠ò‰ΩøÁî®</span>
                    <span class="stat-value">${memoryUsed}MB</span>
                </div>
                <div class="stat-item">
                    <span>AIÁä∂ÊÄÅ</span>
                    <span class="stat-value" style="color: #44ff44;">‚úì Ê≠£Â∏∏</span>
                </div>
            `;
        }

        function updateAIComparison(data) {
            const comparison = document.getElementById('ai-comparison-table');
            comparison.innerHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="text-align: left; padding: 8px;">Ê®°Âûã</th>
                            <th style="text-align: right; padding: 8px;">Ë∞ÉÁî®Êï∞</th>
                            <th style="text-align: right; padding: 8px;">ÈîôËØØÊï∞</th>
                            <th style="text-align: right; padding: 8px;">Âπ≥ÂùáÊó∂Èó¥</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 8px;">DeepSeek</td>
                            <td style="padding: 8px; text-align: right;">${data.deepseek.calls}</td>
                            <td style="padding: 8px; text-align: right;">${data.deepseek.errors}</td>
                            <td style="padding: 8px; text-align: right;">${data.deepseek.avgTime.toFixed(1)}s</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;">Qwen3</td>
                            <td style="padding: 8px; text-align: right;">${data.qwen3.calls}</td>
                            <td style="padding: 8px; text-align: right;">${data.qwen3.errors}</td>
                            <td style="padding: 8px; text-align: right;">${data.qwen3.avgTime.toFixed(1)}s</td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        function updateUsageTrends(data) {
            const trends = document.getElementById('usage-trends');
            const totalShares = data.sharing?.totalShares || 0;
            const avgRating = data.feedback?.averageRating || 0;

            trends.innerHTML = `
                <div class="stat-item">
                    <span>Âπ≥ÂùáËØÑÂàÜ</span>
                    <span class="stat-value">${avgRating}‚≠ê</span>
                </div>
                <div class="stat-item">
                    <span>ÂàÜ‰∫´Ê¨°Êï∞</span>
                    <span class="stat-value">${totalShares}</span>
                </div>
                <div class="stat-item">
                    <span>ÊÄªÂèçÈ¶àÊï∞</span>
                    <span class="stat-value">${data.feedback?.total || 0}</span>
                </div>
            `;
        }

        function updateRecentFeedback(feedbackData) {
            const feedback = document.getElementById('recent-feedback');
            const recent = feedbackData.recent || [];

            if (recent.length === 0) {
                feedback.innerHTML = '<div style="color: #666;">ÊöÇÊó†ÂèçÈ¶à</div>';
                return;
            }

            let content = '';
            recent.forEach(item => {
                const stars = '‚≠ê'.repeat(item.rating || 0);
                const time = new Date(item.timestamp).toLocaleString('zh-CN');
                content += `
                    <div style="border-bottom: 1px solid var(--border-color); padding: 10px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>${stars}</span>
                            <span style="color: #666; font-size: 0.8rem;">${time}</span>
                        </div>
                        <div style="color: #ccc;">${item.comment || 'Êó†ËØÑËÆ∫'}</div>
                    </div>
                `;
            });

            feedback.innerHTML = content;
        }

        function showErrorState() {
            document.querySelectorAll('#admin-panel [id$="-stats"], #admin-panel [id$="-performance"], #admin-panel [id$="-distribution"], #admin-panel [id$="-health"]').forEach(el => {
                el.innerHTML = '<div style="color: #ff4444;">‚ùå Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•</div>';
            });
        }
    </script>
</body>
</html>