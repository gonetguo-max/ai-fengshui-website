// 智能支付路由器 - 根据用户地区选择支付方式
const PayJSManager = require('./payment-manager-china');
const CreemManager = require('./payment-manager-creem');

class PaymentRouter {
  constructor() {
    this.payjs = new PayJSManager();
    this.creem = new CreemManager();
    
    // 地区映射
    this.regionMap = {
      'CN': 'domestic',    // 中国大陆 -> PayJS
      'HK': 'international', // 香港 -> Creem  
      'TW': 'international', // 台湾 -> Creem
      'US': 'international', // 美国 -> Creem
      'CA': 'international', // 加拿大 -> Creem
      'AU': 'international', // 澳洲 -> Creem
      'GB': 'international', // 英国 -> Creem
      'DE': 'international', // 德国 -> Creem
      'JP': 'international', // 日本 -> Creem
      'KR': 'international', // 韩国 -> Creem
      'SG': 'international'  // 新加坡 -> Creem
    };
  }

  /**
   * 智能选择支付方式
   */
  async createPayment(productType, userFingerprint, userIP, userAgent) {
    try {
      // 1. 检测用户地区
      const region = await this.detectUserRegion(userIP, userAgent);
      const paymentType = this.regionMap[region] || 'international';
      
      console.log(`🌍 用户地区: ${region}, 支付类型: ${paymentType}`);

      // 2. 根据地区选择支付方式
      if (paymentType === 'domestic') {
        // 中国大陆用户 -> PayJS (微信/支付宝)
        return await this.createDomesticPayment(productType, userFingerprint);
      } else {
        // 海外用户 -> Creem (信用卡/PayPal)
        return await this.createInternationalPayment(productType, userFingerprint);
      }

    } catch (error) {
      console.error('智能支付路由失败:', error);
      // 默认使用国际支付
      return await this.createInternationalPayment(productType, userFingerprint);
    }
  }

  /**
   * 创建国内支付 (PayJS)
   */
  async createDomesticPayment(productType, userFingerprint) {
    const result = await this.payjs.createPayment(productType, userFingerprint, 'alipay');
    
    return {
      ...result,
      paymentProvider: 'payjs',
      region: 'domestic',
      price: '￥29.9',
      currency: 'CNY',
      methods: ['支付宝', '微信支付']
    };
  }

  /**
   * 创建国际支付 (Creem)
   */
  async createInternationalPayment(productType, userFingerprint) {
    const result = await this.creem.createPayment(productType, userFingerprint);
    
    return {
      ...result,
      paymentProvider: 'creem',
      region: 'international', 
      price: '$4.99',
      currency: 'USD',
      methods: ['Credit Card', 'PayPal', 'Apple Pay']
    };
  }

  /**
   * 检测用户地区
   */
  async detectUserRegion(userIP, userAgent) {
    try {
      // 方法1: 通过IP地址检测 (免费API)
      const response = await fetch(`http://ip-api.com/json/${userIP}`);
      const data = await response.json();
      
      if (data.status === 'success') {
        return data.countryCode;
      }

      // 方法2: 通过浏览器语言检测 (备用方案)
      const acceptLanguage = userAgent.includes('zh-CN') || userAgent.includes('zh');
      if (acceptLanguage) {
        return 'CN';
      }

      // 默认返回国际
      return 'US';

    } catch (error) {
      console.error('地区检测失败:', error);
      return 'US'; // 默认国际用户
    }
  }

  /**
   * 统一的支付验证
   */
  async verifyPayment(provider, paymentData) {
    switch (provider) {
      case 'payjs':
        return await this.payjs.verifyPayment(paymentData);
      case 'creem':
        return await this.creem.verifyPayment(paymentData);
      default:
        throw new Error('Unknown payment provider');
    }
  }

  /**
   * 获取产品信息 (多地区版本)
   */
  getProducts(region = 'international') {
    if (region === 'domestic') {
      return {
        detailed_report: {
          name: '详细风水分析报告',
          price: '￥29.9',
          originalPrice: 2990, // 分
          currency: 'CNY',
          features: [
            '完整六区域深度分析',
            '详细改善建议方案', 
            'PDF报告下载',
            '24小时无限制访问',
            '无水印专业报告'
          ],
          paymentMethods: ['支付宝', '微信支付'],
          provider: 'PayJS'
        }
      };
    } else {
      return {
        detailed_report: {
          name: 'Detailed Feng Shui Analysis Report',
          price: '$4.99',
          originalPrice: 499, // cents
          currency: 'USD',
          features: [
            'Complete 6-area in-depth analysis',
            'Detailed improvement suggestions',
            'PDF report download',
            '24-hour unlimited access',
            'Professional report without watermark'
          ],
          paymentMethods: ['Credit Card', 'PayPal', 'Apple Pay'],
          provider: 'Creem'
        }
      };
    }
  }

  /**
   * 获取用户支付历史
   */
  async getPaymentHistory(userFingerprint) {
    try {
      // 查询两个平台的支付记录
      const [domesticHistory, internationalHistory] = await Promise.all([
        this.payjs.getPaymentHistory(userFingerprint).catch(() => []),
        this.creem.getPaymentHistory(userFingerprint).catch(() => [])
      ]);

      return {
        domestic: domesticHistory,
        international: internationalHistory,
        total: domesticHistory.length + internationalHistory.length
      };
    } catch (error) {
      console.error('获取支付历史失败:', error);
      return { domestic: [], international: [], total: 0 };
    }
  }
}

module.exports = PaymentRouter;

