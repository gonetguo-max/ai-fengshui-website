// æ™ºèƒ½æ”¯ä»˜è·¯ç”±å™¨ - æ ¹æ®ç”¨æˆ·åœ°åŒºé€‰æ‹©æ”¯ä»˜æ–¹å¼
const PayJSManager = require('./payment-manager-china');
const CreemManager = require('./payment-manager-creem');

class PaymentRouter {
  constructor() {
    this.payjs = new PayJSManager();
    this.creem = new CreemManager();
    
    // åœ°åŒºæ˜ å°„
    this.regionMap = {
      'CN': 'domestic',    // ä¸­å›½å¤§é™† -> PayJS
      'HK': 'international', // é¦™æ¸¯ -> Creem  
      'TW': 'international', // å°æ¹¾ -> Creem
      'US': 'international', // ç¾å›½ -> Creem
      'CA': 'international', // åŠ æ‹¿å¤§ -> Creem
      'AU': 'international', // æ¾³æ´² -> Creem
      'GB': 'international', // è‹±å›½ -> Creem
      'DE': 'international', // å¾·å›½ -> Creem
      'JP': 'international', // æ—¥æœ¬ -> Creem
      'KR': 'international', // éŸ©å›½ -> Creem
      'SG': 'international'  // æ–°åŠ å¡ -> Creem
    };
  }

  /**
   * æ™ºèƒ½é€‰æ‹©æ”¯ä»˜æ–¹å¼
   */
  async createPayment(productType, userFingerprint, userIP, userAgent) {
    try {
      // 1. æ£€æµ‹ç”¨æˆ·åœ°åŒº
      const region = await this.detectUserRegion(userIP, userAgent);
      const paymentType = this.regionMap[region] || 'international';
      
      console.log(`ğŸŒ ç”¨æˆ·åœ°åŒº: ${region}, æ”¯ä»˜ç±»å‹: ${paymentType}`);

      // 2. æ ¹æ®åœ°åŒºé€‰æ‹©æ”¯ä»˜æ–¹å¼
      if (paymentType === 'domestic') {
        // ä¸­å›½å¤§é™†ç”¨æˆ· -> PayJS (å¾®ä¿¡/æ”¯ä»˜å®)
        return await this.createDomesticPayment(productType, userFingerprint);
      } else {
        // æµ·å¤–ç”¨æˆ· -> Creem (ä¿¡ç”¨å¡/PayPal)
        return await this.createInternationalPayment(productType, userFingerprint);
      }

    } catch (error) {
      console.error('æ™ºèƒ½æ”¯ä»˜è·¯ç”±å¤±è´¥:', error);
      // é»˜è®¤ä½¿ç”¨å›½é™…æ”¯ä»˜
      return await this.createInternationalPayment(productType, userFingerprint);
    }
  }

  /**
   * åˆ›å»ºå›½å†…æ”¯ä»˜ (PayJS)
   */
  async createDomesticPayment(productType, userFingerprint) {
    const result = await this.payjs.createPayment(productType, userFingerprint, 'alipay');
    
    return {
      ...result,
      paymentProvider: 'payjs',
      region: 'domestic',
      price: 'ï¿¥29.9',
      currency: 'CNY',
      methods: ['æ”¯ä»˜å®', 'å¾®ä¿¡æ”¯ä»˜']
    };
  }

  /**
   * åˆ›å»ºå›½é™…æ”¯ä»˜ (Creem)
   */
  async createInternationalPayment(productType, userFingerprint) {
    const result = await this.creem.createPayment(productType, userFingerprint);
    
    return {
      ...result,
      paymentProvider: 'creem',
      region: 'international', 
      price: '$4.99',
      currency: 'USD',
      methods: ['Credit Card', 'PayPal', 'Apple Pay']
    };
  }

  /**
   * æ£€æµ‹ç”¨æˆ·åœ°åŒº
   */
  async detectUserRegion(userIP, userAgent) {
    try {
      // æ–¹æ³•1: é€šè¿‡IPåœ°å€æ£€æµ‹ (å…è´¹API)
      const response = await fetch(`http://ip-api.com/json/${userIP}`);
      const data = await response.json();
      
      if (data.status === 'success') {
        return data.countryCode;
      }

      // æ–¹æ³•2: é€šè¿‡æµè§ˆå™¨è¯­è¨€æ£€æµ‹ (å¤‡ç”¨æ–¹æ¡ˆ)
      const acceptLanguage = userAgent.includes('zh-CN') || userAgent.includes('zh');
      if (acceptLanguage) {
        return 'CN';
      }

      // é»˜è®¤è¿”å›å›½é™…
      return 'US';

    } catch (error) {
      console.error('åœ°åŒºæ£€æµ‹å¤±è´¥:', error);
      return 'US'; // é»˜è®¤å›½é™…ç”¨æˆ·
    }
  }

  /**
   * ç»Ÿä¸€çš„æ”¯ä»˜éªŒè¯
   */
  async verifyPayment(provider, paymentData) {
    switch (provider) {
      case 'payjs':
        return await this.payjs.verifyPayment(paymentData);
      case 'creem':
        return await this.creem.verifyPayment(paymentData);
      default:
        throw new Error('Unknown payment provider');
    }
  }

  /**
   * è·å–äº§å“ä¿¡æ¯ (å¤šåœ°åŒºç‰ˆæœ¬)
   */
  getProducts(region = 'international') {
    if (region === 'domestic') {
      return {
        detailed_report: {
          name: 'è¯¦ç»†é£æ°´åˆ†ææŠ¥å‘Š',
          price: 'ï¿¥29.9',
          originalPrice: 2990, // åˆ†
          currency: 'CNY',
          features: [
            'å®Œæ•´å…­åŒºåŸŸæ·±åº¦åˆ†æ',
            'è¯¦ç»†æ”¹å–„å»ºè®®æ–¹æ¡ˆ', 
            'PDFæŠ¥å‘Šä¸‹è½½',
            '24å°æ—¶æ— é™åˆ¶è®¿é—®',
            'æ— æ°´å°ä¸“ä¸šæŠ¥å‘Š'
          ],
          paymentMethods: ['æ”¯ä»˜å®', 'å¾®ä¿¡æ”¯ä»˜'],
          provider: 'PayJS'
        }
      };
    } else {
      return {
        detailed_report: {
          name: 'Detailed Feng Shui Analysis Report',
          price: '$4.99',
          originalPrice: 499, // cents
          currency: 'USD',
          features: [
            'Complete 6-area in-depth analysis',
            'Detailed improvement suggestions',
            'PDF report download',
            '24-hour unlimited access',
            'Professional report without watermark'
          ],
          paymentMethods: ['Credit Card', 'PayPal', 'Apple Pay'],
          provider: 'Creem'
        }
      };
    }
  }

  /**
   * è·å–ç”¨æˆ·æ”¯ä»˜å†å²
   */
  async getPaymentHistory(userFingerprint) {
    try {
      // æŸ¥è¯¢ä¸¤ä¸ªå¹³å°çš„æ”¯ä»˜è®°å½•
      const [domesticHistory, internationalHistory] = await Promise.all([
        this.payjs.getPaymentHistory(userFingerprint).catch(() => []),
        this.creem.getPaymentHistory(userFingerprint).catch(() => [])
      ]);

      return {
        domestic: domesticHistory,
        international: internationalHistory,
        total: domesticHistory.length + internationalHistory.length
      };
    } catch (error) {
      console.error('è·å–æ”¯ä»˜å†å²å¤±è´¥:', error);
      return { domestic: [], international: [], total: 0 };
    }
  }
}

module.exports = PaymentRouter;

