# AI风水分析网站 - 技术文档

## 1. 技术架构

### 1.1 整体架构图

```
用户端 (Web界面)
    ↓
Express.js 服务器
    ↓
AI管理器 (双模型系统)
    ├── DeepSeek-R1 (主模型)
    └── Qwen3 (备用模型)
    ↓
风水分析引擎
    ↓
数据存储 & 用户管理
```

### 1.2 核心技术栈

- **后端框架**：Node.js + Express.js
- **AI服务**：DeepSeek API + Qwen3 API
- **文件处理**：Multer (图片上传)
- **用户识别**：指纹识别 (无需注册)
- **数据存储**：内存存储 + 文件系统
- **前端**：原生HTML/JS + CSS

## 2. AI双模型系统

### 2.1 模型选择策略

```javascript
// AI模型配置 (config.js)
aiStrategy: {
    primaryProvider: 'qwen3',       // 主力模型
    fallbackProvider: 'deepseek',  // 备用模型
    enableFallback: true,          // 自动切换
    performanceOptimized: true     // 性能优先
}
```

### 2.2 智能切换逻辑

```javascript
// AI管理器核心逻辑
class AIManager {
    async analyzeFengshui(query, context) {
        // 1. 尝试主模型
        try {
            return await this.primaryModel.analyze(query, context);
        } catch (error) {
            // 2. 自动切换备用模型
            if (this.enableFallback) {
                return await this.fallbackModel.analyze(query, context);
            }
            throw error;
        }
    }
}
```

## 3. 三档产品技术实现

### 3.1 分析等级控制

```javascript
// 风水分析器 - 分级逻辑
class FengshuiAnalyzer {
    async analyze(formData, language, tier = 'free') {
        switch(tier) {
            case 'free':
                return this.generateBasicAnalysis(formData, language);
            case 'standard':
                return this.generateStandardAnalysis(formData, language);
            case 'premium':
                return this.generatePremiumAnalysis(formData, language);
        }
    }
    
    generateBasicAnalysis(data, lang) {
        // 免费版：识别3个关键问题
        const issues = this.detectCriticalIssues(data, 3);
        return {
            problems: issues,
            grade: this.calculateBasicGrade(issues),
            suggestions: this.getEmergencySolutions(issues, 2),
            upgradePrompt: this.generateUpgradeMessage(lang)
        };
    }
}
```

### 3.2 报告生成逻辑

```javascript
// 报告分级生成
generateReport(analysis, tier) {
    const baseReport = {
        summary: analysis.summary,
        grade: analysis.grade,
        timestamp: new Date().toISOString()
    };
    
    switch(tier) {
        case 'free':
            return {
                ...baseReport,
                problems: analysis.problems.slice(0, 3),
                suggestions: analysis.suggestions.slice(0, 2),
                upgrade: {
                    available: true,
                    message: "升级到标准版获得完整分析",
                    features: ["全面问题识别", "详细改善方案", "PDF报告"]
                }
            };
            
        case 'standard':
            return {
                ...baseReport,
                problems: analysis.problems,
                suggestions: analysis.suggestions,
                scores: analysis.roomScores,
                downloadUrl: `/reports/${analysis.id}.pdf`
            };
            
        case 'premium':
            return {
                ...baseReport,
                problems: analysis.problems,
                suggestions: analysis.suggestions,
                scores: analysis.roomScores,
                personalizedAdvice: analysis.personalizedAdvice,
                actionPlan: analysis.phaseBasedPlan,
                downloadUrl: `/reports/${analysis.id}.pdf`,
                consultationAccess: true
            };
    }
}
```

## 4. 用户管理系统

### 4.1 无注册用户识别

```javascript
// 用户管理器 - 指纹识别
class UserManager {
    generateFingerprint(req) {
        const ip = this.getClientIP(req);
        const userAgent = req.headers['user-agent'];
        const acceptLanguage = req.headers['accept-language'];
        
        return crypto.createHash('sha256')
            .update(ip + userAgent + acceptLanguage)
            .digest('hex').substring(0, 16);
    }
    
    // 用户使用统计
    recordUsage(fingerprint, metadata) {
        const user = this.getOrCreateUser(fingerprint);
        user.usageCount++;
        user.lastUsed = new Date();
        user.metadata.push(metadata);
        this.updateUser(fingerprint, user);
    }
}
```

### 4.2 付费意愿收集

```javascript
// 验证期间的付费意愿测试
app.post('/api/upgrade-intent', (req, res) => {
    const { tier, email } = req.body;
    const fingerprint = userManager.generateFingerprint(req);
    
    // 记录用户付费意愿
    userManager.recordUpgradeIntent(fingerprint, {
        targetTier: tier,
        email: email,
        timestamp: new Date()
    });
    
    res.json({
        success: true,
        message: "感谢关注！开放时将第一时间通知您",
        eta: "预计2周内开放"
    });
});
```

## 5. 性能优化

### 5.1 AI调用优化

```javascript
// AI性能监控
class PerformanceMonitor {
    trackCall(provider, startTime, endTime, success) {
        const duration = endTime - startTime;
        this.stats[provider].totalTime += duration;
        this.stats[provider].calls++;
        if (!success) this.stats[provider].errors++;
        
        // 动态调整主模型选择
        if (this.shouldSwitchPrimary()) {
            this.switchPrimaryProvider();
        }
    }
    
    shouldSwitchPrimary() {
        const deepseekAvg = this.getAverageTime('deepseek');
        const qwenAvg = this.getAverageTime('qwen3');
        
        // 如果性能差异>30%，考虑切换
        return Math.abs(deepseekAvg - qwenAvg) / Math.min(deepseekAvg, qwenAvg) > 0.3;
    }
}
```

### 5.2 缓存策略

```javascript
// 简单缓存系统
class AnalysisCache {
    constructor() {
        this.cache = new Map();
        this.maxSize = 1000;
        this.ttl = 3600000; // 1小时
    }
    
    get(key) {
        const item = this.cache.get(key);
        if (!item) return null;
        
        if (Date.now() - item.timestamp > this.ttl) {
            this.cache.delete(key);
            return null;
        }
        
        return item.data;
    }
    
    set(key, data) {
        // 简单LRU实现
        if (this.cache.size >= this.maxSize) {
            const firstKey = this.cache.keys().next().value;
            this.cache.delete(firstKey);
        }
        
        this.cache.set(key, {
            data: data,
            timestamp: Date.now()
        });
    }
}
```

## 6. 数据收集与分析

### 6.1 用户行为追踪

```javascript
// 行为数据收集
app.use('/api', (req, res, next) => {
    const fingerprint = userManager.generateFingerprint(req);
    const eventData = {
        endpoint: req.path,
        method: req.method,
        timestamp: new Date(),
        userAgent: req.headers['user-agent']
    };
    
    userManager.recordEvent(fingerprint, eventData);
    next();
});

// 页面停留时间追踪
app.post('/api/page-time', (req, res) => {
    const { page, duration } = req.body;
    const fingerprint = userManager.generateFingerprint(req);
    
    userManager.recordPageTime(fingerprint, page, duration);
    res.json({ success: true });
});
```

### 6.2 转化漏斗分析

```javascript
// 转化漏斗数据
class ConversionFunnel {
    getStats() {
        const events = userManager.getAllEvents();
        
        return {
            visitors: this.countUniqueUsers(events),
            analyzed: this.countEvent(events, '/api/analyze'),
            upgradeClicks: this.countEvent(events, '/api/upgrade-intent'),
            emailSubmissions: this.countEmailSubmissions(events),
            conversionRate: this.calculateConversionRate(events)
        };
    }
    
    calculateConversionRate(events) {
        const visitors = this.countUniqueUsers(events);
        const upgradeIntents = this.countEvent(events, '/api/upgrade-intent');
        
        return visitors > 0 ? (upgradeIntents / visitors * 100).toFixed(2) : 0;
    }
}
```

## 7. 部署与运维

### 7.1 环境配置

```javascript
// config.js 环境管理
const config = {
    server: {
        port: process.env.PORT || 3000,
        env: process.env.NODE_ENV || 'development'
    },
    
    // AI服务配置
    deepseek: {
        apiKey: process.env.DEEPSEEK_API_KEY,
        baseURL: process.env.DEEPSEEK_BASE_URL || 'https://api.deepseek.com'
    },
    
    qwen3: {
        apiKey: process.env.QWEN3_API_KEY,
        baseURL: process.env.QWEN3_BASE_URL
    },
    
    // 验证期特殊配置
    validation: {
        enablePayment: process.env.ENABLE_PAYMENT === 'true',
        collectEmails: process.env.COLLECT_EMAILS === 'true',
        maxFreeUsage: parseInt(process.env.MAX_FREE_USAGE) || 999999
    }
};
```

### 7.2 监控指标

```javascript
// 系统监控
app.get('/api/system-health', (req, res) => {
    const stats = {
        server: {
            uptime: process.uptime(),
            memory: process.memoryUsage(),
            timestamp: new Date().toISOString()
        },
        ai: analyzer.aiManager.getPerformanceStats(),
        users: userManager.getSystemStats(),
        conversion: funnelAnalyzer.getStats()
    };
    
    res.json({ success: true, data: stats });
});
```

## 8. 验证期特殊功能

### 8.1 付费功能预览

```javascript
// 验证期的"伪付费"功能
app.post('/api/simulate-payment', (req, res) => {
    const { tier, email } = req.body;
    const fingerprint = userManager.generateFingerprint(req);
    
    // 记录付费意愿但不实际收费
    userManager.recordPaymentIntent(fingerprint, {
        tier: tier,
        amount: tier === 'standard' ? 19.99 : 49.99,
        email: email,
        timestamp: new Date()
    });
    
    // 返回"支付成功"但实际是模拟
    res.json({
        success: true,
        message: "验证期间免费体验高级功能",
        report: analyzer.generateReport(data, tier), // 实际给高级报告
        note: "正式版本将收费，感谢测试！"
    });
});
```

### 8.2 A/B测试框架

```javascript
// 简单的A/B测试系统
class ABTestManager {
    getVariant(fingerprint, testName) {
        const hash = crypto.createHash('md5').update(fingerprint + testName).digest('hex');
        const num = parseInt(hash.substring(0, 8), 16);
        return num % 2 === 0 ? 'A' : 'B';
    }
    
    recordConversion(fingerprint, testName, variant, converted) {
        this.results[testName] = this.results[testName] || { A: {views: 0, conversions: 0}, B: {views: 0, conversions: 0} };
        this.results[testName][variant].views++;
        if (converted) this.results[testName][variant].conversions++;
    }
}
```

## 9. 安全考虑

### 9.1 数据保护

```javascript
// 用户数据加密存储
class DataProtection {
    encryptSensitiveData(data) {
        const cipher = crypto.createCipher('aes-256-cbc', process.env.ENCRYPTION_KEY);
        let encrypted = cipher.update(JSON.stringify(data), 'utf8', 'hex');
        encrypted += cipher.final('hex');
        return encrypted;
    }
    
    // 自动清理过期数据
    cleanupExpiredData() {
        const cutoff = Date.now() - (30 * 24 * 60 * 60 * 1000); // 30天前
        this.removeDataOlderThan(cutoff);
    }
}
```

### 9.2 请求限制

```javascript
// 简单的请求限制
const requestLimiter = new Map();

app.use('/api/analyze', (req, res, next) => {
    const fingerprint = userManager.generateFingerprint(req);
    const now = Date.now();
    const userRequests = requestLimiter.get(fingerprint) || [];
    
    // 清理1小时前的请求记录
    const recentRequests = userRequests.filter(time => now - time < 3600000);
    
    if (recentRequests.length >= 10) { // 每小时最多10次
        return res.status(429).json({
            success: false,
            error: '请求过于频繁，请稍后再试'
        });
    }
    
    recentRequests.push(now);
    requestLimiter.set(fingerprint, recentRequests);
    next();
});
```

---

*技术文档版本：v1.0*  
*最后更新：2025-08-23*