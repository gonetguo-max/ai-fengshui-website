# 💻 商业化功能开发清单

> **开发目标**: 4-6周内完成基础商业化功能  
> **技术路线**: 简化MVP，专注核心付费功能  
> **目标市场**: 海外华人用户  

---

## 🎯 第1周开发任务

### **Day 1-2: 使用限制系统**

#### **功能需求**
- 基于IP的每日使用限制
- 免费用户每日1次评估
- 付费用户无限制使用
- 简单的用户会话管理

#### **技术实现**
```javascript
// 1. 用户识别机制
const UserIdentifier = {
  // 生成用户指纹
  generateFingerprint: (req) => {
    const ip = req.ip;
    const userAgent = req.headers['user-agent'];
    return crypto.createHash('md5')
      .update(ip + userAgent + new Date().toDateString())
      .digest('hex');
  },

  // 检查使用限制
  checkDailyLimit: async (fingerprint) => {
    const today = new Date().toDateString();
    const key = `usage_${fingerprint}_${today}`;
    const usage = await redis.get(key) || 0;
    return usage < 1; // 每日限制1次
  },

  // 记录使用
  recordUsage: async (fingerprint) => {
    const today = new Date().toDateString();
    const key = `usage_${fingerprint}_${today}`;
    await redis.incr(key);
    await redis.expire(key, 86400); // 24小时过期
  }
};
```

#### **API修改**
```javascript
// 修改现有分析API
app.post('/api/analyze', async (req, res) => {
  const fingerprint = UserIdentifier.generateFingerprint(req);
  
  // 检查是否有付费会话
  const hasPaidAccess = await checkPaidAccess(fingerprint);
  
  if (!hasPaidAccess) {
    const canUse = await UserIdentifier.checkDailyLimit(fingerprint);
    if (!canUse) {
      return res.status(429).json({
        success: false,
        error: 'DAILY_LIMIT_EXCEEDED',
        message: '今日免费次数已用完，请明天再试或购买详细分析',
        paymentUrl: '/payment'
      });
    }
  }

  // 执行分析...
  const result = await analyzer.analyze(req.body, language);
  
  // 记录使用
  if (!hasPaidAccess) {
    await UserIdentifier.recordUsage(fingerprint);
  }

  // 返回结果（免费版 vs 付费版）
  if (hasPaidAccess) {
    return res.json({ success: true, data: result, type: 'detailed' });
  } else {
    const basicResult = extractBasicInfo(result);
    return res.json({ 
      success: true, 
      data: basicResult, 
      type: 'basic',
      upgradePrompt: true 
    });
  }
});
```

### **Day 3-4: 支付系统集成**

#### **Stripe集成 (国际用户)**
```javascript
// 安装依赖
npm install stripe

// Stripe配置
const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);

// 创建支付会话
app.post('/api/create-payment', async (req, res) => {
  const { product, region } = req.body;
  const fingerprint = UserIdentifier.generateFingerprint(req);

  const pricing = {
    detailed_report: {
      'US': { amount: 499, currency: 'usd' },
      'AU': { amount: 699, currency: 'aud' },
      'CA': { amount: 649, currency: 'cad' },
      'SG': { amount: 699, currency: 'sgd' }
    }
  };

  const session = await stripe.checkout.sessions.create({
    payment_method_types: ['card'],
    line_items: [{
      price_data: {
        currency: pricing[product][region].currency,
        product_data: {
          name: 'AI风水详细分析报告',
          description: '专业六色区块分析 + PDF报告'
        },
        unit_amount: pricing[product][region].amount,
      },
      quantity: 1,
    }],
    mode: 'payment',
    success_url: `${req.protocol}://${req.get('host')}/payment-success?session_id={CHECKOUT_SESSION_ID}`,
    cancel_url: `${req.protocol}://${req.get('host')}/payment-cancel`,
    metadata: {
      user_fingerprint: fingerprint,
      product_type: product
    }
  });

  res.json({ sessionId: session.id });
});
```

#### **支付宝集成 (中国用户)**
```javascript
// 支付宝SDK集成
const AlipaySdk = require('alipay-sdk').default;

const alipaySdk = new AlipaySdk({
  appId: process.env.ALIPAY_APP_ID,
  privateKey: process.env.ALIPAY_PRIVATE_KEY,
  alipayPublicKey: process.env.ALIPAY_PUBLIC_KEY,
});

// 创建支付宝订单
app.post('/api/alipay-create', async (req, res) => {
  const fingerprint = UserIdentifier.generateFingerprint(req);
  const orderId = generateOrderId();

  const formData = new AlipayFormData();
  formData.setMethod('get');
  formData.addField('bizContent', {
    outTradeNo: orderId,
    productCode: 'FAST_INSTANT_TRADE_PAY',
    totalAmount: '29.90',
    subject: 'AI风水详细分析报告',
    body: '专业风水分析服务'
  });

  const result = await alipaySdk.exec('alipay.trade.page.pay', {}, formData);
  
  // 存储订单信息
  await storeOrder({
    orderId,
    fingerprint,
    amount: '29.90',
    product: 'detailed_report',
    status: 'pending'
  });

  res.json({ paymentUrl: result });
});
```

### **Day 5-7: 支付验证和访问控制**

#### **支付成功处理**
```javascript
// Stripe webhook处理
app.post('/api/stripe-webhook', express.raw({type: 'application/json'}), async (req, res) => {
  const sig = req.headers['stripe-signature'];
  let event;

  try {
    event = stripe.webhooks.constructEvent(req.body, sig, process.env.STRIPE_WEBHOOK_SECRET);
  } catch (err) {
    return res.status(400).send(`Webhook signature verification failed.`);
  }

  if (event.type === 'checkout.session.completed') {
    const session = event.data.object;
    const fingerprint = session.metadata.user_fingerprint;
    
    // 授予付费访问权限
    await grantPaidAccess(fingerprint, session.metadata.product_type);
  }

  res.json({received: true});
});

// 付费访问管理
const PaidAccessManager = {
  grant: async (fingerprint, productType, duration = '24h') => {
    const key = `paid_access_${fingerprint}`;
    const expireTime = productType === 'detailed_report' ? 86400 : 2592000; // 1天或30天
    
    await redis.setex(key, expireTime, JSON.stringify({
      type: productType,
      grantedAt: new Date().toISOString(),
      expiresAt: new Date(Date.now() + expireTime * 1000).toISOString()
    }));
  },

  check: async (fingerprint) => {
    const key = `paid_access_${fingerprint}`;
    const access = await redis.get(key);
    return access ? JSON.parse(access) : null;
  }
};
```

---

## 🎯 第2周开发任务

### **Day 8-10: 用户界面优化**

#### **支付流程UI**
```html
<!-- 免费次数用完提示 -->
<div class="upgrade-prompt" v-if="showUpgradePrompt">
  <div class="prompt-card">
    <h3>🔮 今日免费分析已用完</h3>
    <p>想要获得更详细的专业分析报告？</p>
    <div class="pricing-options">
      <div class="option">
        <h4>详细分析报告</h4>
        <div class="price">$4.99</div>
        <ul>
          <li>✅ 完整六色区块分析</li>
          <li>✅ 专业改善建议</li>
          <li>✅ PDF报告下载</li>
          <li>✅ 24小时内可重新查看</li>
        </ul>
        <button @click="startPayment('detailed_report')">立即购买</button>
      </div>
    </div>
    <p class="free-option">或者明天再来享受免费分析</p>
  </div>
</div>
```

#### **多语言支付界面**
```javascript
// 多语言价格显示
const PricingDisplay = {
  getLocalizedPrice: (region, product) => {
    const pricing = {
      'US': { detailed_report: '$4.99', currency_symbol: '$' },
      'AU': { detailed_report: 'AU$6.99', currency_symbol: 'AU$' },
      'CA': { detailed_report: 'CA$6.49', currency_symbol: 'CA$' },
      'SG': { detailed_report: 'S$6.99', currency_symbol: 'S$' },
      'CN': { detailed_report: '¥29.9', currency_symbol: '¥' }
    };
    return pricing[region] || pricing['US'];
  },

  getPaymentMethods: (region) => {
    const methods = {
      'CN': ['alipay', 'wechat_pay'],
      'US': ['stripe', 'paypal'],
      'AU': ['stripe', 'paypal'],
      'CA': ['stripe', 'paypal'],
      'SG': ['stripe', 'paypal']
    };
    return methods[region] || methods['US'];
  }
};
```

### **Day 11-14: 报告系统优化**

#### **免费vs付费报告差异**
```javascript
// 报告内容分层
const ReportGenerator = {
  generateBasicReport: (analysisResult) => {
    return {
      score: analysisResult.score,
      level: analysisResult.level,
      basicSuggestions: analysisResult.suggestions.slice(0, 3),
      summary: analysisResult.summary.substring(0, 200) + '...',
      watermark: true,
      type: 'basic'
    };
  },

  generateDetailedReport: (analysisResult) => {
    return {
      ...analysisResult,
      detailedAnalysis: true,
      fullSuggestions: analysisResult.suggestions,
      colorBlocks: analysisResult.sixColorAnalysis,
      timingAdvice: analysisResult.timing,
      warnings: analysisResult.warnings,
      pdfDownload: true,
      watermark: false,
      type: 'detailed'
    };
  }
};
```

#### **PDF报告生成**
```javascript
// PDF生成功能
npm install puppeteer

const generatePDF = async (reportData, language = 'zh') => {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();
  
  // 生成HTML报告
  const html = generateReportHTML(reportData, language);
  await page.setContent(html);
  
  const pdf = await page.pdf({
    format: 'A4',
    printBackground: true,
    margin: { top: '20px', bottom: '20px', left: '20px', right: '20px' }
  });
  
  await browser.close();
  return pdf;
};
```

---

## 🎯 第3-4周开发任务

### **地区自动识别和本地化**
```javascript
// 地区识别
const RegionDetector = {
  detectRegion: (req) => {
    // 基于IP地址识别地区
    const ip = req.ip;
    const country = geoip.lookup(ip)?.country || 'US';
    
    const regionMap = {
      'US': 'US',
      'CA': 'CA', 
      'AU': 'AU',
      'SG': 'SG',
      'MY': 'SG',
      'CN': 'CN',
      'HK': 'CN',
      'TW': 'CN'
    };
    
    return regionMap[country] || 'US';
  },

  getLocalizedContent: (region, language) => {
    return {
      currency: getPricingCurrency(region),
      paymentMethods: getPaymentMethods(region),
      legalNotice: getLegalNotice(region),
      supportContact: getSupportContact(region)
    };
  }
};
```

### **用户历史记录系统**
```javascript
// 简单的历史记录
const HistoryManager = {
  save: async (fingerprint, reportData) => {
    const historyKey = `history_${fingerprint}`;
    const record = {
      id: generateId(),
      timestamp: new Date().toISOString(),
      type: reportData.type,
      score: reportData.score,
      summary: reportData.summary.substring(0, 100)
    };
    
    await redis.lpush(historyKey, JSON.stringify(record));
    await redis.ltrim(historyKey, 0, 9); // 保留最近10条
    await redis.expire(historyKey, 2592000); // 30天过期
  },

  get: async (fingerprint) => {
    const historyKey = `history_${fingerprint}`;
    const records = await redis.lrange(historyKey, 0, -1);
    return records.map(r => JSON.parse(r));
  }
};
```

---

## 📋 开发检查清单

### **第1周完成标准**
- [ ] IP限制系统正常工作
- [ ] Stripe支付流程完整
- [ ] 支付宝集成测试通过
- [ ] 免费/付费分层正确
- [ ] 基础错误处理完善

### **第2周完成标准**
- [ ] 支付成功自动授权
- [ ] 多地区价格显示
- [ ] 用户界面友好
- [ ] PDF报告生成
- [ ] 基础历史记录

### **第3-4周完成标准**
- [ ] 地区自动识别
- [ ] 多语言支付界面
- [ ] 客服联系方式
- [ ] 移动端优化
- [ ] 基础数据统计

### **测试清单**
- [ ] 免费用户限制测试
- [ ] 支付流程端到端测试
- [ ] 不同地区价格测试
- [ ] 移动端支付测试
- [ ] 报告生成测试

---

## 🔧 开发环境配置

### **必需的环境变量**
```bash
# Stripe配置
STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# 支付宝配置
ALIPAY_APP_ID=...
ALIPAY_PRIVATE_KEY=...
ALIPAY_PUBLIC_KEY=...

# Redis配置 (用于会话管理)
REDIS_URL=redis://localhost:6379

# 地区识别
GEOIP_LICENSE_KEY=...
```

### **新增依赖包**
```bash
npm install stripe alipay-sdk puppeteer geoip-lite redis
```

---

**🎯 开发原则**
1. **简单优先** - MVP功能，避免过度设计
2. **安全可靠** - 支付数据安全处理
3. **用户友好** - 清晰的支付流程和错误提示
4. **国际化** - 考虑不同地区用户习惯
5. **可扩展** - 为未来功能留出接口

**📅 里程碑**
- 第1周末：基础付费功能可用
- 第2周末：完整用户体验
- 第4周末：生产环境就绪 